<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Richard</title>
  
  <subtitle>L.Wang Blogs</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2022-01-15T08:34:13.311Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>L.Wang</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>å›çœ‹2021</title>
    <link href="http://yoursite.com/2022/01/15/20220115/"/>
    <id>http://yoursite.com/2022/01/15/20220115/</id>
    <published>2022-01-15T07:21:28.000Z</published>
    <updated>2022-01-15T08:34:13.311Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>2021å¹´å·²æ‚„ç„¶è¿‡å»ï¼Œåœ¨å‘¨ä¸€åˆ°å‘¨ä¸‰åœ¨å‘¨äº”çš„æ— é™å¾ªç¯ä¸­é£é€ï¼Œå“ï¼Œè¿™éƒ½æ˜¯æˆ‘çš„é’æ˜¥å•Šï¼<a id="more"></a></p></blockquote><p>æ¯å¹´åœ¨å¹´æœ«çš„æ—¶å€™ï¼Œæˆ‘éƒ½ä¼šå›æƒ³ä¸‹å¹´åˆçš„å®æ„¿ï¼Œæ‹¯æ•‘æ˜Ÿæ²³ã€æ‹¯æ•‘å…¨äººç±»ï¼Œä½†æ˜¯ä»æ¥æ²¡æœ‰è®°å½•è¿‡ï¼Œä»Šå¹´å°±æƒ³æ¢ä¸ªæ–¹å¼å»åšè¿™ä»¶äº‹â€¦..</p><h2 id="å›é¦–2021å¹´åˆ"><a href="#å›é¦–2021å¹´åˆ" class="headerlink" title="å›é¦–2021å¹´åˆ"></a>å›é¦–2021å¹´åˆ</h2><ol><li><p>MySQLçŸ¥è¯†äº†è§£ã€‚</p></li><li><p>å­¦ä¹ å¤–è¯­ã€‚</p></li><li><p>Dubboæ¡†æ¶çŸ¥è¯†æ•´ç†ã€‚</p></li><li><p>è¯»RocketMQæºç ã€‚</p><p>â€¦â€¦</p></li></ol><p>å…¶å®ï¼Œç°åœ¨å›çœ‹2021çš„ç›®æ ‡åè€Œæ²¡æœ‰å®Œæˆå‡ ä»¶ï¼Œè‡ªæˆ‘é©±åŠ¨å‹ä¸å¤Ÿã€ç›®æ ‡å¤ªå¤§æ²¡æœ‰ç»†åŒ–â€¦</p><h2 id="2021å¹´åšçš„äº‹æƒ…"><a href="#2021å¹´åšçš„äº‹æƒ…" class="headerlink" title="2021å¹´åšçš„äº‹æƒ…"></a>2021å¹´åšçš„äº‹æƒ…</h2><ol><li><p>åŸºé‡‘çŸ¥è¯†çš„äº†è§£ï¼Œèƒ½å¤Ÿè½»æ¾åº”å¯¹ä¸šåŠ¡å¼€å‘ã€‚</p></li><li><p>Dubboæ¡†æ¶æºç çš„äº†è§£ï¼Œè®©æˆ‘å­¦ä¼šäº†å¾ˆå¤šè®¾è®¡æ¨¡å¼ï¼Œåº”ç”¨åœ¨ä»£ç ç¼–å†™ä¸Šã€‚ï¼ˆè¿™ä¸ªè®©æˆ‘å¾ˆå¼€å¿ƒâ€¦.ï¼‰</p></li><li><p>Redisçš„ä½¿ç”¨æœ‰è‡ªå·±çš„è®¤è¯†ã€‚ä¼šå¸¸è§„è¿ç”¨Redisï¼Œæ’æŸ¥Redisçš„éƒ¨åˆ†é—®é¢˜ï¼Œå¯¹Redisçš„æŒä¹…åŒ–å’Œé«˜å¯ç”¨æœ‰éƒ¨åˆ†ç ”ç©¶ã€‚ï¼ˆæˆ‘ä¹Ÿä¸çŸ¥é“åç»­éœ€è¦å¦‚ä½•å»æå‡ï¼Œåœ¨å¼€å‘ä¸­æˆ‘å¥½åƒä¹Ÿå¾ˆéš¾æ¥è§¦åˆ°â€¦.ï¼‰</p></li><li>RocketMQä»…ä»…åªæ˜¯ä¼šç”¨ï¼Œä¼šæ’æŸ¥å°é—®é¢˜ã€‚è·ç¦»æˆ‘çš„æœŸæœ›è¿˜æœ‰å¾ˆé•¿å¾ˆé•¿çš„è·¯ã€‚</li><li>åœ¨ä»Šå¹´æˆ‘å¯¹JVMçŸ¥è¯†é‡æ–°åšäº†æ¢³ç†ï¼Œå¯¹JVMçš„å†…å­˜æœ‰äº†æ–°çš„è®¤è¯†ã€‚ç°åœ¨ç®€å†è¯¥å¯ä»¥å†™ä¸Šäº†è§£JVMäº†ï¼ŒğŸ˜‚ã€‚</li><li>å¯¹JVMçš„åŸºç¡€ç±»æ¡†æ¶åœ¨ååŠå¹´æ—¶é—´ï¼Œé‡æ–°è¿›è¡Œæ¢³ç†ï¼Œä½†æ˜¯è·ç¦»ç›®æ ‡ä¾æ—§å¾ˆè¿œã€‚</li><li>åœ¨åšä¸šåŠ¡å¼€å‘æ—¶ï¼Œå‘ç°è‡ªå·±æœ‰æ—¶æ–¹å¼ä¸æ­£ç¡®ï¼Œåœ¨2021å¹´ï¼Œå†™äº†å¤ªå¤šçš„Bugï¼Œä¹Ÿè®©æˆ‘æˆé•¿å¿«é€Ÿï¼Œæ„Ÿè°¢å…¬å¸ç»™æˆ‘çš„æœºä¼š/ç»™æˆ‘çš„å¹³å°ã€‚</li><li>é‡æMySQLï¼Œä»Šå¹´ã€ŠMYSQLé«˜æ€§èƒ½ã€‹åªçœ‹äº†ä¸€åŠï¼Œå‘ç°è‡ªå·±è¿˜æ˜¯å°ç™½ï¼Œå·²ç»é”™è¿‡äº†ä¸€å¹´çš„è§„åˆ’ï¼Œæˆ‘æƒ³æˆ‘åœ¨ä»Šå¹´åº”è¯¥ä¸ä¼šåœ¨é”™è¿‡äº†ã€‚</li><li>åœ¨å¼€å‘çš„æ—¶é—´åšäº†ä¸€æ®µæ—¶é—´çš„ç®¡ç†ï¼Œå‘ç°è‡ªå·±çš„ç®¡ç†å¤©èµ‹å·®å¼ºäººæ„å•Šï¼Œä»¥åè¦æ€ä¹ˆå»åšå‘¢ï¼Ÿ</li></ol><p>2021å¹´ä¹°äº†å¾ˆå¤šä¹¦ï¼Œå‘ç°è¿˜æœ‰ä¸€å¤§éƒ¨åˆ†æ²¡æœ‰çœ‹å®Œï¼Œæ‰€ä»¥2022æˆ‘ä¸æƒ³å†ç»§ç»­ä¹°ä¹¦äº†ï¼ŒåŠªåŠ›æŠŠä¹°äº†çš„ä¹¦çœ‹å®Œâ€¦.</p><p>æœ‰æ—¶è§‰å¾—è‡ªå·±å¾ˆå¥‡æ€ªï¼Œåšäº†å¾ˆå¤šçš„è®¡åˆ’ä½†æœ‰å¾ˆå¤šæ²¡æœ‰å®Œæˆï¼Œä½†æ˜¯ä¾æ—§åœ¨åšæŒåšè®¡åˆ’â€¦æ‰€ä»¥æˆ‘ä»Šå¹´ä¾æ—§ä¼šåšè®¡åˆ’ï¼Œå¸Œæœ›è‡ªå·±2022å¹´èƒ½åšå®Œå§ã€‚</p><h2 id="2022å¹´çš„è®¡åˆ’"><a href="#2022å¹´çš„è®¡åˆ’" class="headerlink" title="2022å¹´çš„è®¡åˆ’"></a>2022å¹´çš„è®¡åˆ’</h2><p>æ¯å¤©éƒ½åšè®¡åˆ’ï¼Œä½†æ˜¯å¥½åƒæ¯å¹´éƒ½æ²¡æœ‰å®Œæˆã€‚å“ï¼Œæˆ‘è¦ç‹ ç‹ çš„æ•™è®­æˆ‘ä¸€é¡¿ï¼Œä»Šå¹´æ™šä¸Šåƒä¸ªå¤§é¤ï¼Œæ’‘æ­»è‡ªå·±å¾—äº†â€¦.</p><p>å› ä¸ºä»¥å¾€æ¯å¹´çš„è®¡åˆ’å®Œæˆçš„éƒ½ä¸æ˜¯å¾ˆå¥½ï¼Œæ‰€ä»¥æˆ‘ä»Šå¹´çš„è®¡åˆ’åšçš„å°½å¯èƒ½è¯¦ç»†â€¦..</p><p>ç›®å‰ï¼Œæ‘†åœ¨æˆ‘é¢å‰çš„é—®é¢˜æˆ‘è§‰çš„æœ‰è¿™å‡ ä¸ªâ€¦.<br>        MySQLã€RocketMQã€JVMåŸºç¡€çŸ¥è¯†ï¼ˆåŒ…å«JVM+JVMçš„åŸºç¡€ç±»ï¼‰ã€Springæ¡†æ¶ã€MyBaitsæ¡†æ¶â€¦â€¦</p><p>å¥½åƒè‡ªå·±ä¸ä¼šçš„å¤ªå¤šäº†ï¼Œè¿˜æ˜¯å°‘äº›ç‚¹ï¼Œå…çš„æ˜å¹´åšæ€»ç»“çš„æ—¶å€™ï¼Œåˆè¦åƒå¥½åƒçš„æŠŠè‡ªå·±æ’‘æ­»æ¥æƒ©ç½šè‡ªå·±ï¼Œå¤ªè´¹é’±äº†â€¦</p><h3 id="2022-MySQL"><a href="#2022-MySQL" class="headerlink" title="2022::MySQL"></a>2022::MySQL</h3><p>æ„Ÿè§‰MySQLæˆ‘çœ‹äº†å¾ˆå¤šå¹´ï¼Œä½†æ˜¯ä¾æ—§å­¦ä¸å¥½â€¦.</p><p>ä»Šå¹´ï¼Œã€ŠMySQLé«˜æ€§èƒ½ã€‹è‡³å°‘çœ‹ä¸¤éï¼ŒçŸ¥é“è‡ªå·±èƒ½å¤Ÿç”»å‡ºè„‘å›¾ï¼Œæœ‰è‡ªå·±çš„çŸ¥è¯†ä½“ç³»ä¸ºæ­¢ï¼Œæœ¬æ¥æƒ³ç€èƒ½å¤Ÿé»˜å†™çš„ç”»å‡ºè„‘å›¾ï¼Œä½†æ˜¯æƒ³äº†ä¸‹ï¼Œå¤§ä½“çš„ç»“æ„èƒ½é»˜å†™ç”»å‡ºï¼Œæ¯”è¾ƒå°‘ç”¨çš„ç»†èŠ‚èƒ½å¤Ÿç¿»ä¹¦æŸ¥é˜…ï¼Œå¯¹äºä½¿ç”¨è¾ƒå¤šçš„çŸ¥è¯†ç»“ç‚¹è¦æœ‰è‡ªå·±çš„è®¤è¯†ï¼Œä¸è¦é€šè¿‡ç¿»ä¹¦æŸ¥é˜…æ‰èƒ½æƒ³èµ·æ¥â€¦.</p><ol><li>ä¹¦ç±å…ˆçœ‹å®Œä¸€éã€‚å¯¹ç…§ä¹¦ç±ç”»å‡ºé€»è¾‘æ€ç»´å›¾ã€‚</li><li>å¯¹ç€é€»è¾‘æ€ç»´å›¾ï¼Œçœ‹çœ‹è‡ªå·±èƒ½å¯¹é‚£äº›æ¨¡å—æŒæ¡ä¸å¤Ÿ ï¼Œç„¶ååŠ æ·±é˜…è¯»ã€‚</li><li>åœ¨ç”»è„‘å›¾ï¼Œåœ¨çœ‹ä¹¦â€¦.çŸ¥é“è‡ªå·±ç†è§£ä¸ºæ­¢â€¦</li></ol><h3 id="2022-RocketMQ"><a href="#2022-RocketMQ" class="headerlink" title="2022::RocketMQ"></a>2022::RocketMQ</h3><p>ä»Šå¹´çš„ç›®æ ‡å¾ˆç®€å•ï¼Œå°±æ˜¯æŠŠRocketMQçš„é‡ç‚¹éƒ¨åˆ†çš„æºç æ¢³ç†ä¸€éâ€¦.</p><p>å‘é€æ¶ˆæ¯/æ¶ˆæ¯å­˜å‚¨/é›†ç¾¤ç®¡ç†/â€¦.</p><h3 id="2022-JVM"><a href="#2022-JVM" class="headerlink" title="2022::JVM"></a>2022::JVM</h3><p>JVMçš„åŸºç¡€çŸ¥è¯†å…¶å®æˆ‘ä¹Ÿçœ‹äº†å¾ˆå¤šéï¼Œä½†æ˜¯å¿˜çš„å¤ªå¿«â€¦..</p><p>JVMçš„å¸¸è§„åŸºç¡€çŸ¥è¯†åœ¨æ•´ç†ä¸€é</p><p>å¯¹JVMé€šç”¨çš„åŸºç¡€ç±»è¿›è¡Œæ¢³ç†ã€‚ä¾‹å¦‚AQS/é”/Map/â€¦.</p><h3 id="2022-Springæ¡†æ¶"><a href="#2022-Springæ¡†æ¶" class="headerlink" title="2022::Springæ¡†æ¶"></a>2022::Springæ¡†æ¶</h3><p>äº†è§£Springæ¡†æ¶çš„åŸºç¡€æºç ï¼ŒçŸ¥é“åŸç†ã€‚</p><h3 id="2022-çœ‹å®Œè‡ªå·±æ²¡æœ‰çœ‹å®Œçš„ä¹¦"><a href="#2022-çœ‹å®Œè‡ªå·±æ²¡æœ‰çœ‹å®Œçš„ä¹¦" class="headerlink" title="2022::çœ‹å®Œè‡ªå·±æ²¡æœ‰çœ‹å®Œçš„ä¹¦"></a>2022::çœ‹å®Œè‡ªå·±æ²¡æœ‰çœ‹å®Œçš„ä¹¦</h3><p>2021ä¹°äº†å¾ˆå¤šä¹¦ï¼Œä½†æ˜¯å¾ˆå¤šæ²¡æœ‰çœ‹å®Œï¼ŒåŠ›äº‰ä»Šå¹´çœ‹å®Œã€‚</p><h3 id="2022-å¯¹åŸºé‡‘çš„è¡Œä¸šçŸ¥è¯†è¦æœ‰æ›´å……åˆ†çš„è®¤çŸ¥"><a href="#2022-å¯¹åŸºé‡‘çš„è¡Œä¸šçŸ¥è¯†è¦æœ‰æ›´å……åˆ†çš„è®¤çŸ¥" class="headerlink" title="2022:: å¯¹åŸºé‡‘çš„è¡Œä¸šçŸ¥è¯†è¦æœ‰æ›´å……åˆ†çš„è®¤çŸ¥"></a>2022:: å¯¹åŸºé‡‘çš„è¡Œä¸šçŸ¥è¯†è¦æœ‰æ›´å……åˆ†çš„è®¤çŸ¥</h3><p>å¹²ä¸€è¡Œï¼Œå°±è¦çˆ±ä¸€è¡Œã€‚æ‰€ä»¥ä»Šå¹´è¦å¯¹åŸºé‡‘çŸ¥è¯†æœ‰æ›´å……åˆ†çš„è®¤è¯†ï¼Œæ‹¿åˆ°åŸºé‡‘ä»ä¸šèµ„æ ¼è¯æ˜¯å¿…é¡»çš„ã€‚</p><h2 id="ç»“è¯­é€ç»™2022"><a href="#ç»“è¯­é€ç»™2022" class="headerlink" title="ç»“è¯­é€ç»™2022"></a>ç»“è¯­é€ç»™2022</h2><p>ä¸çŸ¥é“è°è¯´çš„ï¼Œè®°ä¸æ¸…äº†ï¼Œä½†æ˜¯å¤§æ„æ˜¯è¯´è®¡åˆ’è™½èµ¶ä¸ä¸Šå˜åŒ–ï¼Œä½†æ˜¯æœ‰è®¡åˆ’ï¼Œå¯ä»¥è®©ä½ ä¸è‡´äºåç¦»èˆªçº¿å¤ªè¿œâ€¦.</p><p>2022åŠ æ²¹ï¼Œå¸Œæœ›åœ¨2022å¹´å¹´æœ«æœ‰ä¸€ä¸ªå¥½çš„ç»“æœâ€¦.</p><p>åŠ æ²¹ï¼Œ2022ï¼åŠªåŠ›æ‰ä¸è´Ÿæµé€çš„é’æ˜¥â€¦..</p>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;2021å¹´å·²æ‚„ç„¶è¿‡å»ï¼Œåœ¨å‘¨ä¸€åˆ°å‘¨ä¸‰åœ¨å‘¨äº”çš„æ— é™å¾ªç¯ä¸­é£é€ï¼Œå“ï¼Œè¿™éƒ½æ˜¯æˆ‘çš„é’æ˜¥å•Šï¼&lt;/p&gt;&lt;/blockquote&gt;
    
    </summary>
    
      <category term="æ€»ç»“" scheme="http://yoursite.com/categories/%E6%80%BB%E7%BB%93/"/>
    
    
      <category term="èƒ¡è¨€ä¹±è¯­" scheme="http://yoursite.com/tags/%E8%83%A1%E8%A8%80%E4%B9%B1%E8%AF%AD/"/>
    
  </entry>
  
  <entry>
    <title>AQSæºç è§£æ</title>
    <link href="http://yoursite.com/2022/01/07/20220107/"/>
    <id>http://yoursite.com/2022/01/07/20220107/</id>
    <published>2022-01-07T02:03:00.000Z</published>
    <updated>2022-01-15T08:41:04.321Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>çœ‹è¿‡å¾ˆå¤šAQSçš„åšå®¢ï¼Œä¾ç„¶çœ‹ä¸æ‡‚AQSã€‚æ‰€ä»¥æˆ‘è®¡åˆ’æŒ‰ç…§è‡ªå·±çš„ç†è§£æ•´ç†AQSï¼Œå¯¹AQSæœ‰ä¸€ä¸ªè‡ªå·±çš„è®¤çŸ¥ã€‚<a id="more"></a></p></blockquote><h1 id="method-acquire"><a href="#method-acquire" class="headerlink" title="method::acquire"></a>method::acquire</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public final void acquire(int arg) &#123;</span><br><span class="line">    if (!tryAcquire(arg) &amp;&amp;</span><br><span class="line">        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">        selfInterrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="method-acquireQueued"><a href="#method-acquireQueued" class="headerlink" title="method::acquireQueued"></a>method::acquireQueued</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">boolean</span> interrupted = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">final</span> Node p = node.predecessor();</span><br><span class="line">            <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                setHead(node);</span><br><span class="line">                p.next = <span class="keyword">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                failed = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">return</span> interrupted;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                parkAndCheckInterrupt())</span><br><span class="line">                interrupted = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Node"><a href="#Node" class="headerlink" title="Node"></a>Node</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">    <span class="comment">/** Marker to indicate a node is waiting in shared mode */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> Node SHARED = <span class="keyword">new</span> Node();</span><br><span class="line">    <span class="comment">/** Marker to indicate a node is waiting in exclusive mode */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> Node EXCLUSIVE = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** waitStatus value to indicate thread has cancelled */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CANCELLED =  <span class="number">1</span>;</span><br><span class="line">    <span class="comment">/** waitStatus value to indicate successor's thread needs unparking */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SIGNAL    = -<span class="number">1</span>;</span><br><span class="line">    <span class="comment">/** waitStatus value to indicate thread is waiting on condition */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CONDITION = -<span class="number">2</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * waitStatus value to indicate the next acquireShared should</span></span><br><span class="line"><span class="comment">     * unconditionally propagate</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROPAGATE = -<span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">int</span> waitStatus;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">volatile</span> Node prev;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">volatile</span> Node next;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">volatile</span> Thread thread;</span><br><span class="line"></span><br><span class="line">    Node nextWaiter;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns true if node is waiting in shared mode.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isShared</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> nextWaiter == SHARED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">final</span> Node <span class="title">predecessor</span><span class="params">()</span> <span class="keyword">throws</span> NullPointerException </span>&#123;</span><br><span class="line">        Node p = prev;</span><br><span class="line">        <span class="keyword">if</span> (p == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Node() &#123;    <span class="comment">// Used to establish initial head or SHARED marker</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Node(Thread thread, Node mode) &#123;     <span class="comment">// Used by addWaiter</span></span><br><span class="line">        <span class="keyword">this</span>.nextWaiter = mode;</span><br><span class="line">        <span class="keyword">this</span>.thread = thread;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Node(Thread thread, <span class="keyword">int</span> waitStatus) &#123; <span class="comment">// Used by Condition</span></span><br><span class="line">        <span class="keyword">this</span>.waitStatus = waitStatus;</span><br><span class="line">        <span class="keyword">this</span>.thread = thread;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2022/01/07/20220107/node.png" alt="Node"></p><h1 id="ConditionObject"><a href="#ConditionObject" class="headerlink" title="ConditionObject"></a>ConditionObject</h1><p><img src="/2022/01/07/20220107/abstractMethod.png" alt="æŠ½è±¡æ–¹æ³•"></p>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;çœ‹è¿‡å¾ˆå¤šAQSçš„åšå®¢ï¼Œä¾ç„¶çœ‹ä¸æ‡‚AQSã€‚æ‰€ä»¥æˆ‘è®¡åˆ’æŒ‰ç…§è‡ªå·±çš„ç†è§£æ•´ç†AQSï¼Œå¯¹AQSæœ‰ä¸€ä¸ªè‡ªå·±çš„è®¤çŸ¥ã€‚&lt;/p&gt;&lt;/blockquote&gt;
    
    </summary>
    
      <category term="é«˜å¹¶å‘" scheme="http://yoursite.com/categories/%E9%AB%98%E5%B9%B6%E5%8F%91/"/>
    
    
      <category term="AQS" scheme="http://yoursite.com/tags/AQS/"/>
    
      <category term="LOCK" scheme="http://yoursite.com/tags/LOCK/"/>
    
  </entry>
  
  <entry>
    <title>ThreadPoolExcutoræºç å‰–æ</title>
    <link href="http://yoursite.com/2021/12/21/20211221/"/>
    <id>http://yoursite.com/2021/12/21/20211221/</id>
    <published>2021-12-21T14:17:17.000Z</published>
    <updated>2022-01-06T06:28:21.534Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>åˆ›å»ºçº¿ç¨‹æ± çš„æ–¹å¼æœ‰Executorså’ŒThreadPoolExecutorlä¸¤ç§æ–¹å¼ï¼›ThreadPoolExecutoræ˜¯ä½œä¸ºæœ€åŸºç¡€çš„åˆ›å»ºæ–¹å¼ï¼Œå†æ¬¡æ•´ç†åŠ æ·±äº†è§£ï¼<a id="more"></a></p></blockquote><p><img src="/2021/12/21/20211221/exuctor.png" alt="&#39;ThreadPoolExcutoræ‰§è¡Œæµç¨‹&#39;"></p><h1 id="æˆå‘˜å˜é‡"><a href="#æˆå‘˜å˜é‡" class="headerlink" title="æˆå‘˜å˜é‡"></a>æˆå‘˜å˜é‡</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger ctl = <span class="keyword">new</span> AtomicInteger(ctlOf(RUNNING, <span class="number">0</span>));</span><br><span class="line"><span class="comment">// Integer.SIZE 32ä½</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COUNT_BITS = Integer.SIZE - <span class="number">3</span>;</span><br><span class="line"><span class="comment">//2^29 - 1</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CAPACITY   = (<span class="number">1</span> &lt;&lt; COUNT_BITS) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RUNNING    = -<span class="number">1</span> &lt;&lt; COUNT_BITS;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SHUTDOWN   =  <span class="number">0</span> &lt;&lt; COUNT_BITS;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STOP       =  <span class="number">1</span> &lt;&lt; COUNT_BITS;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TIDYING    =  <span class="number">2</span> &lt;&lt; COUNT_BITS;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TERMINATED =  <span class="number">3</span> &lt;&lt; COUNT_BITS;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">runStateOf</span><span class="params">(<span class="keyword">int</span> c)</span>     </span>&#123; <span class="keyword">return</span> c &amp; ~CAPACITY; &#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">workerCountOf</span><span class="params">(<span class="keyword">int</span> c)</span>  </span>&#123; <span class="keyword">return</span> c &amp; CAPACITY; &#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">ctlOf</span><span class="params">(<span class="keyword">int</span> rs, <span class="keyword">int</span> wc)</span> </span>&#123; <span class="keyword">return</span> rs | wc; &#125;</span><br></pre></td></tr></table></figure><h2 id="çº¿ç¨‹çŠ¶æ€å˜é‡"><a href="#çº¿ç¨‹çŠ¶æ€å˜é‡" class="headerlink" title="çº¿ç¨‹çŠ¶æ€å˜é‡"></a>çº¿ç¨‹çŠ¶æ€å˜é‡</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">                            <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span></span><br><span class="line">        </span><br><span class="line">RUNNING                     <span class="number">1110</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span>       -<span class="number">1</span>&lt;&lt;<span class="number">29</span></span><br><span class="line">               </span><br><span class="line">SHUTDOWN                    <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span>       <span class="number">0</span>&lt;&lt;<span class="number">29</span></span><br><span class="line">               </span><br><span class="line">STOP                        <span class="number">0010</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span>       <span class="number">1</span>&lt;&lt;<span class="number">29</span></span><br><span class="line">               </span><br><span class="line">                            <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0010</span>       <span class="number">2</span></span><br><span class="line">TIDYING                     <span class="number">0100</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span>       <span class="number">2</span>&lt;&lt;<span class="number">29</span></span><br><span class="line">               </span><br><span class="line">                            <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0011</span>       <span class="number">3</span></span><br><span class="line">TERMINATED                  <span class="number">0110</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span>       <span class="number">3</span>&lt;&lt;<span class="number">29</span></span><br><span class="line">               </span><br><span class="line">                            <span class="number">1110</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span></span><br><span class="line">                                                                  ï½œ</span><br><span class="line">                            <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span>    </span><br><span class="line">ctlOf                   =   <span class="number">1110</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span></span><br></pre></td></tr></table></figure><p>COUNT_BITSï¼šæ¦‚å¿µä¸Šç”¨äºè¡¨ç¤ºçŠ¶æ€ä½ä¸çº¿ç¨‹æ•°ä½çš„åˆ†ç•Œå€¼ï¼Œå®é™…ç”¨äºçŠ¶æ€å˜é‡ç­‰ç§»ä½æ“ä½œã€‚</p><p>CAPACITYï¼šè¡¨ç¤º ThreadPoolExecutor çš„æœ€å¤§å®¹é‡ã€‚æœ€å¤§å®¹é‡å³ä½29ä½å…¨éƒ¨ä¸º1ã€‚</p><p>ç”±ä¸Šå¯ä»¥çœ‹å‡ºï¼Œ-1ã€0ã€1ã€2ã€3çš„å·¦ç§»29ä½çš„åŒºåˆ«éƒ½åœ¨é«˜3ä½ï¼Œæ‰€ä»¥ç”¨é«˜3ä½ä»£è¡¨çº¿ç¨‹çš„çŠ¶æ€ã€‚</p><p>ctl åœ¨ä¸€ä¸ªintä¸­åŒ…è£…äº†æ´»è·ƒçº¿ç¨‹æ•°å’Œçº¿ç¨‹æ± è¿è¡Œæ—¶çŠ¶æ€ä¸¤ä¸ªå˜é‡ã€‚é«˜3ä½ä»£è¡¨çº¿ç¨‹çš„çŠ¶æ€ï¼Œä½29ä½ç”¨æ¥è¡¨ç¤ºçº¿ç¨‹æ± çš„å®¹é‡ã€‚</p><h2 id="å‰–ç¦»ctl"><a href="#å‰–ç¦»ctl" class="headerlink" title="å‰–ç¦»ctl"></a>å‰–ç¦»ctl</h2><p>runStateOf è·å–çº¿ç¨‹æ± çŠ¶æ€ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CAPACITY                    <span class="number">0001</span> <span class="number">1111</span> <span class="number">1111</span> <span class="number">1111</span> <span class="number">1111</span> <span class="number">1111</span> <span class="number">1111</span> <span class="number">1111</span></span><br><span class="line">                                                            </span><br><span class="line">~CAPACITY                   <span class="number">1110</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span></span><br><span class="line">                                                                  &amp;</span><br><span class="line">ctl                         <span class="number">0110</span> <span class="number">0101</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span>      ï¼ˆctlä»»æ„èµ‹äºˆçš„å€¼ï¼‰</span><br><span class="line">runStateOf                  <span class="number">0110</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span></span><br></pre></td></tr></table></figure><p>workerCountOf è·å–çº¿ç¨‹æ´»è·ƒçº¿ç¨‹æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CAPACITY                    <span class="number">0001</span> <span class="number">1111</span> <span class="number">1111</span> <span class="number">1111</span> <span class="number">1111</span> <span class="number">1111</span> <span class="number">1111</span> <span class="number">1111</span></span><br><span class="line">                                                                  &amp;</span><br><span class="line">ctl                         <span class="number">0110</span> <span class="number">0101</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span>      ï¼ˆctlä»»æ„èµ‹äºˆçš„å€¼ï¼‰</span><br><span class="line">runStateOf                  <span class="number">0000</span> <span class="number">0101</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span></span><br></pre></td></tr></table></figure><p>ä»»ä½•å€¼ä¸0ç­‰äº0ï¼Œä¸1ç­‰äºåŸå€¼ã€‚å› æ­¤ â€˜ä¸â€™ æ“ä½œè¿‡åï¼Œctl çš„é«˜3ä½ä¿ç•™åŸå€¼ï¼Œä½29ä½ç½®0ã€‚ä½¿ç”¨è¿™ç§æ–¹å¼å·§å¦™çš„æ–¹å¼å°†çº¿ç¨‹æ± çŠ¶æ€ä¸æ´»è·ƒçº¿ç¨‹æ•°å‰¥ç¦»å¼€ã€‚</p><h2 id="ç”Ÿå‘½å‘¨æœŸ"><a href="#ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="ç”Ÿå‘½å‘¨æœŸ"></a>ç”Ÿå‘½å‘¨æœŸ</h2><p><img src="/2021/12/21/20211221/lifecycle.png" alt="ç”Ÿå‘½å‘¨æœŸ"></p><h1 id="executeæ‰§è¡Œæµç¨‹"><a href="#executeæ‰§è¡Œæµç¨‹" class="headerlink" title="executeæ‰§è¡Œæµç¨‹"></a>executeæ‰§è¡Œæµç¨‹</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable command)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (command == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    <span class="comment">// è·å– ctl çš„å€¼ï¼Œctl = (runState + workerCount)</span></span><br><span class="line">    <span class="keyword">int</span> c = ctl.get();</span><br><span class="line">    <span class="comment">// å¦‚æœå·¥ä½œçº¿ç¨‹æ•°å°äºçº¿ç¨‹æ± æ ¸å¿ƒçº¿ç¨‹å¤§å°,æ·»åŠ æ ¸å¿ƒçº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">if</span> (workerCountOf(c) &lt; corePoolSize) &#123;</span><br><span class="line">        <span class="keyword">if</span> (addWorker(command, <span class="keyword">true</span>))</span><br><span class="line">            <span class="comment">// æ·»åŠ æˆåŠŸï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="comment">// æ·»åŠ å¤±è´¥ï¼Œé‡æ–°è·å–ctl</span></span><br><span class="line">        c = ctl.get();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åœ¨çº¿ç¨‹æ± å·²æ»¡çš„æƒ…å†µä¸‹ï¼Œå¦‚æœçº¿ç¨‹æ± æ˜¯è¿è¡ŒçŠ¶æ€ï¼Œå°è¯•å°†ä»»åŠ¡æ·»åŠ è‡³é˜Ÿåˆ—ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123;</span><br><span class="line">        <span class="comment">// å†æ¬¡è·å– ctl çš„å€¼ï¼Œè¿›è¡ŒåŒé‡è®¤è¯</span></span><br><span class="line">        <span class="keyword">int</span> recheck = ctl.get();</span><br><span class="line">        <span class="comment">// å¦‚æœçº¿ç¨‹æ± éè¿è¡ŒçŠ¶æ€ï¼Œå°è¯•ä»é˜Ÿåˆ—ä¸­ç§»é™¤ä»»åŠ¡</span></span><br><span class="line">        <span class="keyword">if</span> (! isRunning(recheck) &amp;&amp; remove(command))</span><br><span class="line">            reject(command);</span><br><span class="line">        <span class="comment">// å¦‚æœçº¿ç¨‹æ± ä¸ºè¿è¡ŒçŠ¶æ€ã€æˆ–ç§»é™¤ä»»åŠ¡å¤±è´¥</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (workerCountOf(recheck) == <span class="number">0</span>)</span><br><span class="line">        <span class="comment">// æ‰§è¡Œ addWorker æ–¹æ³•ï¼Œæ­¤æ—¶æ·»åŠ çš„æ˜¯éæ ¸å¿ƒçº¿ç¨‹ï¼ˆç©ºé—²çº¿ç¨‹ï¼Œæœ‰å­˜æ´»æ—¶é—´ï¼‰</span></span><br><span class="line">            addWorker(<span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœçº¿ç¨‹æ± æ˜¯éè¿è¡ŒçŠ¶æ€æˆ–è€…workQueueæ·»åŠ ä»»åŠ¡å¤±è´¥ï¼Œå†æ¬¡å°è¯• addWorker() æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!addWorker(command, <span class="keyword">false</span>))</span><br><span class="line">        <span class="comment">//workQueueæ·»åŠ å¤±è´¥ï¼Œæ‰§è¡Œæ‹’ç»ç­–ç•¥ã€‚</span></span><br><span class="line">        reject(command);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2021/12/21/20211221/excutorHandler.png" alt="excutoræ‰§è¡Œæµç¨‹"></p><h2 id="method-reject"><a href="#method-reject" class="headerlink" title="method::reject"></a>method::reject</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">reject</span><span class="params">(Runnable command)</span> </span>&#123;</span><br><span class="line">    handler.rejectedExecution(command, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œæ‹’ç»ç­–ç•¥ï¼Œè°ƒç”¨RejectedExecutionHandlerç±»ï¼Œä½¿ç”¨ç­–ç•¥æ¨¡å¼ï¼Œæ ¹æ®é…ç½®ï¼Œæ‰§è¡Œå…·ä½“çš„ç­–ç•¥ã€‚</p><h2 id="method-addWorker"><a href="#method-addWorker" class="headerlink" title="method::addWorker"></a>method::addWorker</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">addWorker</span><span class="params">(Runnable firstTask, <span class="keyword">boolean</span> core)</span> </span>&#123;</span><br><span class="line">    retry:</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">int</span> c = ctl.get();</span><br><span class="line">        <span class="comment">// è·å–çº¿ç¨‹æ± çš„è¿è¡ŒçŠ¶æ€</span></span><br><span class="line">        <span class="keyword">int</span> rs = runStateOf(c);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check if queue empty only if necessary.</span></span><br><span class="line">        <span class="comment">// å¦‚æœ rs &gt; SHUTDOWNï¼Œæ­¤æ—¶ä¸å…è®¸æ¥æ”¶æ–°ä»»åŠ¡ï¼Œä¹Ÿä¸å…è®¸æ‰§è¡Œå·¥ä½œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œç›´æ¥è¿”å›fasleã€‚</span></span><br><span class="line">        <span class="comment">// å¦‚æœ rs == SHUTDOWNï¼Œä»»åŠ¡ä¸ºnullï¼Œå¹¶ä¸”å·¥ä½œé˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œæ­¤æ—¶èµ°ä¸‹é¢çš„ 'æ‰§è¡Œå·¥ä½œé˜Ÿåˆ—ä¸­ä»»åŠ¡' çš„é€»è¾‘ã€‚</span></span><br><span class="line">        <span class="comment">// è¿™é‡Œè®¾ç½® firstTask == null æ˜¯å› ä¸ºï¼šçº¿ç¨‹æ± åœ¨SHUTDOWNçŠ¶æ€ä¸‹ï¼Œä¸å…è®¸æ·»åŠ æ–°ä»»åŠ¡ï¼Œåªå…è®¸æ‰§è¡Œå·¥ä½œé˜Ÿåˆ—ä¸­å‰©ä½™çš„ä»»åŠ¡ã€‚</span></span><br><span class="line">        <span class="keyword">if</span> (rs &gt;= SHUTDOWN &amp;&amp;</span><br><span class="line">            ! (rs == SHUTDOWN &amp;&amp;</span><br><span class="line">               firstTask == <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">               ! workQueue.isEmpty()))</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">// è·å–å·¥ä½œçº¿ç¨‹æ•°</span></span><br><span class="line">            <span class="keyword">int</span> wc = workerCountOf(c);</span><br><span class="line">            <span class="comment">// å·¥ä½œçº¿ç¨‹å¤§äºå®¹é‡  å·¥ä½œçº¿ç¨‹å°äºæœ€å¤§çº¿ç¨‹æ•°</span></span><br><span class="line">            <span class="keyword">if</span> (wc &gt;= CAPACITY ||</span><br><span class="line">                wc &gt;= (core ? corePoolSize : maximumPoolSize))</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            <span class="comment">// å°è¯•å¢åŠ æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå¤±è´¥ä»å¤´å¼€å§‹å¾ªç¯æ‰§è¡Œ</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndIncrementWorkerCount(c))</span><br><span class="line">                <span class="keyword">break</span> retry;</span><br><span class="line">            c = ctl.get();  <span class="comment">// Re-read ctl</span></span><br><span class="line">            <span class="keyword">if</span> (runStateOf(c) != rs)</span><br><span class="line">                <span class="keyword">continue</span> retry;</span><br><span class="line">            <span class="comment">// else CAS failed due to workerCount change; retry inner loop</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> workerStarted = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">boolean</span> workerAdded = <span class="keyword">false</span>;</span><br><span class="line">    Worker w = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºworkerçº¿ç¨‹ï¼Œæ¯ä¸€ä¸ªWorkerå†…æŒæœ‰çœŸæ­£æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹ã€‚</span></span><br><span class="line">        w = <span class="keyword">new</span> Worker(firstTask);</span><br><span class="line">        <span class="keyword">final</span> Thread t = w.thread;</span><br><span class="line">        <span class="keyword">if</span> (t != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">            mainLock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// è·å–run state</span></span><br><span class="line">                <span class="keyword">int</span> rs = runStateOf(ctl.get());</span><br><span class="line">                <span class="comment">// 1.è¿è¡ŒçŠ¶æ€ï¼Œåˆ™åˆ›å»ºworkerçº¿ç¨‹</span></span><br><span class="line">                <span class="comment">// 2.å¦‚æœä¸º SHUTDOWN çŠ¶æ€ï¼Œå¹¶ä¸” firstTask == nullï¼Œæ­¤æ—¶å°†åˆ›å»ºçº¿ç¨‹æ‰§è¡Œ ä»»åŠ¡é˜Ÿåˆ— ä¸­çš„ä»»åŠ¡ã€‚</span></span><br><span class="line">                <span class="keyword">if</span> (rs &lt; SHUTDOWN ||</span><br><span class="line">                    (rs == SHUTDOWN &amp;&amp; firstTask == <span class="keyword">null</span>)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (t.isAlive()) <span class="comment">// precheck that t is startable</span></span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalThreadStateException();</span><br><span class="line">                    workers.add(w);</span><br><span class="line">                    <span class="keyword">int</span> s = workers.size();</span><br><span class="line">                    <span class="keyword">if</span> (s &gt; largestPoolSize)</span><br><span class="line">                        largestPoolSize = s;</span><br><span class="line">                    workerAdded = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// è§£é”</span></span><br><span class="line">                mainLock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (workerAdded) &#123;</span><br><span class="line">                t.start();</span><br><span class="line">                workerStarted = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (! workerStarted)</span><br><span class="line">            addWorkerFailed(w);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> workerStarted;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>addWorkeré‡è¦èŠ‚ç‚¹ï¼š</p><ol><li>é€šè¿‡ä¸¤å±‚æ­»å¾ªç¯å’ŒCASä¿è¯compareAndIncrementWorkerCount(c)æ›´æ–°æ´»è·ƒçº¿ç¨‹æ•°ã€‚<ol><li>åœ¨ä»€ä¹ˆæƒ…å†µä¸‹æ‰èƒ½å¤Ÿæ›´æ–°æ´»è·ƒçº¿ç¨‹æ•°å‘¢ï¼Ÿ<ol><li>çº¿ç¨‹æ± çŠ¶æ€æ˜¯runing/stopçŠ¶æ€æ‰ã€‚</li><li>çº¿ç¨‹æ± çŠ¶æ€æ˜¯shutdownï¼Œä½†æ˜¯åœ¨workQueueä¸­ä¾ç„¶æœ‰å¾…æ‰§è¡Œçš„ä»»åŠ¡ï¼ŒfirstTask==nullã€‚</li><li>æ´»è·ƒçº¿ç¨‹æ•°å°äºçº¿ç¨‹æ± å®¹é‡ã€‚</li><li>æ´»è·ƒçº¿ç¨‹æ•°è¦å°äºæ ¸å¿ƒçº¿ç¨‹æ•°æˆ–çº¿ç¨‹æ± æœ€å¤§çº¿ç¨‹æ•°ã€‚</li></ol></li></ol></li></ol><p><img src="/2021/12/21/20211221/addWorker.png" alt="addWorker"></p><h2 id="method-compareAndIncrementWorkerCount"><a href="#method-compareAndIncrementWorkerCount" class="headerlink" title="method::compareAndIncrementWorkerCount"></a>method::compareAndIncrementWorkerCount</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">compareAndIncrementWorkerCount</span><span class="params">(<span class="keyword">int</span> expect)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ctl.compareAndSet(expect, expect + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡CASå‘½ä»¤çš„æ–¹å¼ä»¤ctlä¸­ä½29ä½çº¿ç¨‹æ´»è·ƒæ•°+1ã€‚</p><h2 id="method-addWorkerFailed"><a href="#method-addWorkerFailed" class="headerlink" title="method::addWorkerFailed"></a>method::addWorkerFailed</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addWorkerFailed</span><span class="params">(Worker w)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">    mainLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (w != <span class="keyword">null</span>)</span><br><span class="line">         <span class="comment">// ä»ç¼“å­˜ä¸­ç§»é™¤worker</span></span><br><span class="line">            workers.remove(w);</span><br><span class="line">        <span class="comment">// </span></span><br><span class="line">        decrementWorkerCount();</span><br><span class="line">        tryTerminate();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        mainLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Decrements the workerCount field of ctl. This is called only on</span></span><br><span class="line"><span class="comment"> * abrupt termination of a thread (see processWorkerExit). Other</span></span><br><span class="line"><span class="comment"> * decrements are performed within getTask.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">decrementWorkerCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;&#125; <span class="keyword">while</span> (! compareAndDecrementWorkerCount(ctl.get()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="tryTerminate"><a href="#tryTerminate" class="headerlink" title="tryTerminate"></a>tryTerminate</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">final void tryTerminate() &#123;</span><br><span class="line">    for (;;) &#123;</span><br><span class="line">        int c = ctl.get();</span><br><span class="line">        if (isRunning(c) ||</span><br><span class="line">            runStateAtLeast(c, TIDYING) ||</span><br><span class="line">            (runStateOf(c) == SHUTDOWN &amp;&amp; ! workQueue.isEmpty()))</span><br><span class="line">            return;</span><br><span class="line">        if (workerCountOf(c) != 0) &#123; // Eligible to terminate</span><br><span class="line">            interruptIdleWorkers(ONLY_ONE);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        final ReentrantLock mainLock = this.mainLock;</span><br><span class="line">        mainLock.lock();</span><br><span class="line">        try &#123;</span><br><span class="line">            if (ctl.compareAndSet(c, ctlOf(TIDYING, 0))) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    terminated();</span><br><span class="line">                &#125; finally &#123;</span><br><span class="line">                    ctl.set(ctlOf(TERMINATED, 0));</span><br><span class="line">                    termination.signalAll();</span><br><span class="line">                &#125;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            mainLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">        // else retry on failed CAS</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="å†…éƒ¨ç±»-Worker"><a href="#å†…éƒ¨ç±»-Worker" class="headerlink" title="å†…éƒ¨ç±»::Worker"></a>å†…éƒ¨ç±»::Worker</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Worker</span></span></span><br><span class="line"><span class="class">    <span class="keyword">extends</span> <span class="title">AbstractQueuedSynchronizer</span></span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">Runnable</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">6138294804551838833L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å·¥ä½œçº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">final</span> Thread thread;</span><br><span class="line">    <span class="comment">// æäº¤çš„å¾…æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">    Runnable firstTask;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// volatile ä¿è¯çº¿ç¨‹çš„å¯è§æ€§ï¼Œå·²ç»å®Œæˆçš„çº¿ç¨‹ä»»åŠ¡é‡</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">long</span> completedTasks;</span><br><span class="line"></span><br><span class="line">    Worker(Runnable firstTask) &#123;</span><br><span class="line">       <span class="comment">// åˆå§‹åŒ–çŠ¶æ€</span></span><br><span class="line">        setState(-<span class="number">1</span>); </span><br><span class="line">       <span class="comment">// éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡</span></span><br><span class="line">        <span class="keyword">this</span>.firstTask = firstTask;</span><br><span class="line">       <span class="comment">// åˆ©ç”¨çº¿ç¨‹åˆ›å»ºå·¥å‚åˆ›å»ºçº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">this</span>.thread = getThreadFactory().newThread(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Delegates main run loop to outer runWorker  */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="comment">// çœŸæ­£æ‰§è¡Œé€»è¾‘çš„ç»†èƒæ–¹æ³•runWorker</span></span><br><span class="line">        runWorker(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Lock methods</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// The value 0 represents the unlocked state.</span></span><br><span class="line">    <span class="comment">// The value 1 represents the locked state.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//AQSæ¡†æ¶</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isHeldExclusively</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getState() != <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> unused)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨CASå°†0å˜æˆ1</span></span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="comment">//æ’ä»–é” è®¾ç½®å½“å‰çº¿ç¨‹ç‹¬å </span></span><br><span class="line">            setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é‡Šæ”¾çº¿ç¨‹</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">tryRelease</span><span class="params">(<span class="keyword">int</span> unused)</span> </span>&#123;</span><br><span class="line">        setExclusiveOwnerThread(<span class="keyword">null</span>);</span><br><span class="line">        setState(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span>        </span>&#123; acquire(<span class="number">1</span>); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">()</span>  </span>&#123; <span class="keyword">return</span> tryAcquire(<span class="number">1</span>); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span>      </span>&#123; release(<span class="number">1</span>); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isLocked</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> isHeldExclusively(); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">interruptIfStarted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Thread t;</span><br><span class="line">        <span class="keyword">if</span> (getState() &gt;= <span class="number">0</span> &amp;&amp; (t = thread) != <span class="keyword">null</span> &amp;&amp; !t.isInterrupted()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                t.interrupt();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SecurityException ignore) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Workerç»§æ‰¿äº†AbstractQueuedSynchronizerå®ç°äº†Runnableæ¥å£ã€‚(æ‰€ä»¥å‘¢ï¼Ÿæš‚æ—¶å¯¹AQSäº†è§£ä¸å¤Ÿæ·±å…¥ï¼)</p><p><img src="/2021/12/21/20211221/Worker.png" alt="Worker"></p><p>AbstractQueuedSynchronizer:</p><p>Runable:</p><p>è°ƒç”¨run()æ–¹æ³•ï¼Œå…·ä½“æ‰§è¡Œçš„æ˜¯runWorker(this);</p><p>åœ¨åˆ›å»ºæ¯ä¸€ä¸ªworkeræ—¶ï¼Œä¼šåˆå§‹åŒ–RUNNING(-1)çŠ¶æ€ã€å¾…æ‰§è¡Œçš„ä»»åŠ¡(firstTask)ï¼Œå¹¶ä¸ºworkerå¯¹è±¡ç»‘å®šä¸€ä¸ªçº¿ç¨‹(é€šè¿‡ThreadFactoryåˆ›å»º)ï¼Œåœ¨çº¿ç¨‹æ± ä¸­ä»»åŠ¡çš„è¿è¡Œä¸æ˜¯ç›´æ¥æ‰§è¡Œrun()æ–¹æ³•ï¼Œè€Œæ˜¯æ‰§è¡ŒWorkerä¸­runæ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­æäº¤run()æ–¹æ³•ã€‚</p><h2 id="Worker-runWorker"><a href="#Worker-runWorker" class="headerlink" title="Worker::runWorker"></a>Worker::runWorker</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">runWorker</span><span class="params">(Worker w)</span> </span>&#123;</span><br><span class="line">     Thread wt = Thread.currentThread();</span><br><span class="line">     <span class="comment">// æ‹·è´æäº¤çš„ä»»åŠ¡ï¼Œå°†fistTaskèµ‹å€¼ä¸ºnullï¼Œä¸ºä»€ä¹ˆéœ€è¦è¿™ä¹ˆåšå‘¢ï¼Ÿ</span></span><br><span class="line">     Runnable task = w.firstTask;</span><br><span class="line">     w.firstTask = <span class="keyword">null</span>;</span><br><span class="line">     w.unlock(); <span class="comment">// allow interrupts</span></span><br><span class="line">     <span class="keyword">boolean</span> completedAbruptly = <span class="keyword">true</span>;</span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="comment">// æŒæœ‰çš„ä»»åŠ¡å®Œæˆä¹‹åï¼ŒæŒç»­ä»workQueueä¸­è·å–ä»»åŠ¡æ‰§è¡Œ</span></span><br><span class="line">         <span class="keyword">while</span> (task != <span class="keyword">null</span> || (task = getTask()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">             w.lock();</span><br><span class="line">             <span class="comment">// If pool is stopping, ensure thread is interrupted;</span></span><br><span class="line">             <span class="comment">// if not, ensure thread is not interrupted.  This</span></span><br><span class="line">             <span class="comment">// requires a recheck in second case to deal with</span></span><br><span class="line">             <span class="comment">// shutdownNow race while clearing interrupt</span></span><br><span class="line">             <span class="keyword">if</span> ((runStateAtLeast(ctl.get(), STOP) ||</span><br><span class="line">                  (Thread.interrupted() &amp;&amp;</span><br><span class="line">                   runStateAtLeast(ctl.get(), STOP))) &amp;&amp;</span><br><span class="line">                 !wt.isInterrupted())</span><br><span class="line">                 wt.interrupt();</span><br><span class="line">             <span class="keyword">try</span> &#123;</span><br><span class="line">                 <span class="comment">// å‰ç½®æ–¹æ³•ï¼šé’©å­å‡½æ•°</span></span><br><span class="line">                 beforeExecute(wt, task);</span><br><span class="line">                 Throwable thrown = <span class="keyword">null</span>;</span><br><span class="line">                 <span class="keyword">try</span> &#123;</span><br><span class="line">                     <span class="comment">// æäº¤ä»»åŠ¡</span></span><br><span class="line">                     task.run();</span><br><span class="line">                 &#125; <span class="keyword">catch</span> (RuntimeException x) &#123;</span><br><span class="line">                     thrown = x; <span class="keyword">throw</span> x;</span><br><span class="line">                 &#125; <span class="keyword">catch</span> (Error x) &#123;</span><br><span class="line">                     thrown = x; <span class="keyword">throw</span> x;</span><br><span class="line">                 &#125; <span class="keyword">catch</span> (Throwable x) &#123;</span><br><span class="line">                     thrown = x; <span class="keyword">throw</span> <span class="keyword">new</span> Error(x);</span><br><span class="line">                 &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                     <span class="comment">// åç½®æ–¹æ³•ï¼šé’©å­å‡½æ•°</span></span><br><span class="line">                     afterExecute(task, thrown);</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                 task = <span class="keyword">null</span>;</span><br><span class="line">                 w.completedTasks++;</span><br><span class="line">                 w.unlock();</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         completedAbruptly = <span class="keyword">false</span>;</span><br><span class="line">     &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">         <span class="comment">// workQueueæ²¡æœ‰ä»»åŠ¡ï¼Œæˆ–è€…çº¿ç¨‹æ± å…³é—­äº†ï¼Œæ­¤æ—¶éœ€è¦å°†workerä»ç¼“å­˜å†²æ¸…é™¤</span></span><br><span class="line">         processWorkerExit(w, completedAbruptly);</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure><p>runWorkä¼šéå†æ‰§è¡ŒWokerå¯¹è±¡ç»‘å®šçš„ä»»åŠ¡å’ŒworkeQueueä¸­çš„ä»»åŠ¡ã€‚</p><p>runWorker() æ˜¯çœŸæ­£æ‰§è¡Œæäº¤ä»»åŠ¡çš„æ–¹æ³•ï¼Œé€šè¿‡run()æ–¹æ³•ç›´æ¥æ‰§è¡Œä»»åŠ¡ã€‚</p><h2 id="Worker-getTask"><a href="#Worker-getTask" class="headerlink" title="Worker::getTask"></a>Worker::getTask</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Runnable <span class="title">getTask</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> timedOut = <span class="keyword">false</span>; <span class="comment">// Did the last poll() time out?</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">int</span> c = ctl.get();</span><br><span class="line">        <span class="keyword">int</span> rs = runStateOf(c);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check if queue empty only if necessary.</span></span><br><span class="line">        <span class="comment">// 1. å¦‚æœçº¿ç¨‹æ± çš„çŠ¶æ€æ˜¯shutdownçŠ¶æ€éœ€è¦å…ˆæ‰§è¡Œå®ŒworkQueueä¸­å‰©ä½™çš„ä»»åŠ¡</span></span><br><span class="line">        <span class="comment">// 2. çº¿ç¨‹æ± è¦ä¸ºæ´»è·ƒçŠ¶æ€</span></span><br><span class="line">        <span class="keyword">if</span> (rs &gt;= SHUTDOWN &amp;&amp; (rs &gt;= STOP || workQueue.isEmpty())) &#123;</span><br><span class="line">            decrementWorkerCount();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> wc = workerCountOf(c);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Are workers subject to culling?</span></span><br><span class="line">        <span class="comment">// çº¿ç¨‹æ± é”€æ¯æœºåˆ¶ï¼šè¶…è¿‡æ ¸å¿ƒçº¿ç¨‹æ•°æ—¶ï¼Œè€Œä¸”ï¼ˆè¶…è¿‡æœ€å¤§å€¼æˆ–è€…timeoutè¿‡ï¼‰ï¼Œå°±ä¼šé”€æ¯ã€‚</span></span><br><span class="line">        <span class="keyword">boolean</span> timed = allowCoreThreadTimeOut || wc &gt; corePoolSize;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((wc &gt; maximumPoolSize || (timed &amp;&amp; timedOut))</span><br><span class="line">            &amp;&amp; (wc &gt; <span class="number">1</span> || workQueue.isEmpty())) &#123;</span><br><span class="line">            <span class="keyword">if</span> (compareAndDecrementWorkerCount(c))</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡</span></span><br><span class="line">            Runnable r = timed ?</span><br><span class="line">                workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :</span><br><span class="line">                workQueue.take();</span><br><span class="line">            <span class="keyword">if</span> (r != <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">return</span> r;</span><br><span class="line">            timedOut = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException retry) &#123;</span><br><span class="line">            timedOut = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Worker-processWorkerExit"><a href="#Worker-processWorkerExit" class="headerlink" title="Worker::processWorkerExit"></a>Worker::processWorkerExit</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processWorkerExit</span><span class="params">(Worker w, <span class="keyword">boolean</span> completedAbruptly)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (completedAbruptly) <span class="comment">// If abrupt, then workerCount wasn't adjusted</span></span><br><span class="line">        decrementWorkerCount();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">    mainLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        completedTaskCount += w.completedTasks;</span><br><span class="line">        <span class="comment">// private final HashSet&lt;Worker&gt; workers = new HashSet&lt;Worker&gt;();</span></span><br><span class="line">        <span class="comment">// ä»ç¼“å­˜ä¸­ç§»é™¤worker</span></span><br><span class="line">        workers.remove(w);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        mainLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°è¯•åœæ­¢çº¿ç¨‹æ± </span></span><br><span class="line">    tryTerminate();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> c = ctl.get();</span><br><span class="line">    <span class="keyword">if</span> (runStateLessThan(c, STOP)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!completedAbruptly) &#123;</span><br><span class="line">            <span class="keyword">int</span> min = allowCoreThreadTimeOut ? <span class="number">0</span> : corePoolSize;</span><br><span class="line">            <span class="keyword">if</span> (min == <span class="number">0</span> &amp;&amp; ! workQueue.isEmpty())</span><br><span class="line">                min = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (workerCountOf(c) &gt;= min)</span><br><span class="line">                <span class="keyword">return</span>; <span class="comment">// replacement not needed</span></span><br><span class="line">        &#125;</span><br><span class="line">        addWorker(<span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="shutdown-æ‰§è¡Œæµç¨‹"><a href="#shutdown-æ‰§è¡Œæµç¨‹" class="headerlink" title="shutdown()æ‰§è¡Œæµç¨‹"></a>shutdown()æ‰§è¡Œæµç¨‹</h1><p>ç”±ä¸Šå›¾ç”Ÿå‘½å‘¨æœŸä¸­æè¿°ï¼Œçº¿ç¨‹æ± æœ‰ä¸¤é¢ä¸»åŠ¨å…³é—­çš„æ–¹å¼</p><ol><li>shutdown å…³é—­çº¿ç¨‹æ± ä¸­æ‰€æœ‰ç©ºé—²çš„workçº¿ç¨‹ï¼Œçº¿ç¨‹æ± çš„çŠ¶æ€è®¾ç½®ä¸ºSHUTWDOWNçŠ¶æ€ï¼Œç»§ç»­æ‰§è¡ŒworkQueueä¸­çš„ä»»åŠ¡ã€‚</li><li>shutdownNow  å…³é—­çº¿ç¨‹æ± ä¸­æ‰€æœ‰Workerçº¿ç¨‹ï¼Œæ”¹å˜çº¿ç¨‹æ± çŠ¶æ€ä¸ºSTOPï¼Œå¹¶è¯•å›¾åœæ­¢æ‰€æœ‰æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹ï¼Œä¸å†å¤„ç†è¿˜åœ¨æ± é˜Ÿåˆ—ä¸­ç­‰å¾…çš„ä»»åŠ¡ï¼Œå¹¶è¿”å›æ‰€æœ‰æ­£åœ¨ç­‰å¾…å¤„ç†çš„ä»»åŠ¡åˆ—è¡¨ã€‚</li></ol><h2 id="method-shutdow"><a href="#method-shutdow" class="headerlink" title="method::shutdow"></a>method::shutdow</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// åŠ é”</span></span><br><span class="line">    <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">    mainLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// æ£€æŸ¥çº¿ç¨‹æ± æ˜¯å¦å…³é—­</span></span><br><span class="line">        checkShutdownAccess();</span><br><span class="line">        <span class="comment">// ä¿®æ”¹çº¿ç¨‹æ± çŠ¶æ€</span></span><br><span class="line">        advanceRunState(SHUTDOWN);</span><br><span class="line">        <span class="comment">// å…³é—­ç©ºé—²çº¿ç¨‹</span></span><br><span class="line">        interruptIdleWorkers();</span><br><span class="line">        onShutdown(); <span class="comment">// hook for ScheduledThreadPoolExecutor</span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        mainLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å°è¯•ç»ˆæ­¢çº¿ç¨‹æ± </span></span><br><span class="line">    tryTerminate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="method-checkShutdownAccess"><a href="#method-checkShutdownAccess" class="headerlink" title="method::checkShutdownAccess"></a>method::checkShutdownAccess</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkShutdownAccess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    SecurityManager security = System.getSecurityManager();</span><br><span class="line">    <span class="keyword">if</span> (security != <span class="keyword">null</span>) &#123;</span><br><span class="line">        security.checkPermission(shutdownPerm);</span><br><span class="line">        <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">        mainLock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (Worker w : workers)</span><br><span class="line">                security.checkAccess(w.thread);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            mainLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="method-advanceRunState"><a href="#method-advanceRunState" class="headerlink" title="method::advanceRunState"></a>method::advanceRunState</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">advanceRunState</span><span class="params">(<span class="keyword">int</span> targetState)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">int</span> c = ctl.get();</span><br><span class="line">        <span class="keyword">if</span> (runStateAtLeast(c, targetState) ||</span><br><span class="line">            ctl.compareAndSet(c, ctlOf(targetState, workerCountOf(c))))</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="method-interruptIdleWorkers"><a href="#method-interruptIdleWorkers" class="headerlink" title="method::interruptIdleWorkers"></a>method::<strong>interruptIdleWorkers</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">interruptIdleWorkers</span><span class="params">(<span class="keyword">boolean</span> onlyOne)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">    mainLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (Worker w : workers) &#123;</span><br><span class="line">            Thread t = w.thread;</span><br><span class="line">            <span class="keyword">if</span> (!t.isInterrupted() &amp;&amp; w.tryLock()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    t.interrupt();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SecurityException ignore) &#123;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    w.unlock();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (onlyOne)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        mainLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Common form of interruptIdleWorkers, to avoid having to</span></span><br><span class="line"><span class="comment"> * remember what the boolean argument means.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">interruptIdleWorkers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    interruptIdleWorkers(<span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="method-shutdownNow"><a href="#method-shutdownNow" class="headerlink" title="method:shutdownNow"></a>method:shutdownNow</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Runnable&gt; <span class="title">shutdownNow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;Runnable&gt; tasks;</span><br><span class="line">    <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">    mainLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// æ£€æŸ¥shutdownæƒé™</span></span><br><span class="line">        checkShutdownAccess();</span><br><span class="line">        advanceRunState(STOP);</span><br><span class="line">        <span class="comment">// ä¸­æ–­æ‰€æœ‰çº¿ç¨‹</span></span><br><span class="line">        interruptWorkers();</span><br><span class="line">        <span class="comment">// è·å–é˜Ÿåˆ—ä¸­æ‰€æœ‰æ­£åœ¨ç­‰å¾…å¤„ç†çš„ä»»åŠ¡åˆ—è¡¨</span></span><br><span class="line">        tasks = drainQueue();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        mainLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    tryTerminate();</span><br><span class="line">    <span class="comment">// è¿”å›workerQueueä¸­ç­‰å¾…çš„çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">return</span> tasks;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>shutdownNowæ–¹æ³•å’Œshutdownæ–¹æ³•çš„æ ¸å¿ƒåŸå­æ–¹æ³•æ¯”è¾ƒç›¸ä¼¼ï¼ŒåŒºåˆ«åœ¨å»interruptWorkersæ–¹æ³•ã€‚</p><h3 id="method-interruptWorkers"><a href="#method-interruptWorkers" class="headerlink" title="method::interruptWorkers"></a>method::interruptWorkers</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">interruptWorkers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">    mainLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// éå†ç¼“å­˜ä¸­çš„æ‰€æœ‰worker</span></span><br><span class="line">        <span class="keyword">for</span> (Worker w : workers)</span><br><span class="line">            <span class="comment">// å¦‚æœworkeræ˜¯å¯åŠ¨çŠ¶æ€å°±å°†å…¶ä¸­æ–­</span></span><br><span class="line">            w.interruptIfStarted();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        mainLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">interruptIfStarted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Thread t;</span><br><span class="line">    <span class="comment">// state &gt;= 0è¡¨ç¤ºworkerå·²ç»å¯åŠ¨ï¼ŒWorkerå¯åŠ¨å¹¶ä¸”æŒæœ‰çº¿ç¨‹ä¸ä¸ºnullå¹¶ä¸”æŒæœ‰çº¿ç¨‹æœªè¢«æ ‡è®°ä¸­æ–­ï¼Œåˆ™ä¸­æ–­è¯¥çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">if</span> (getState() &gt;= <span class="number">0</span> &amp;&amp; (t = thread) != <span class="keyword">null</span> &amp;&amp; !t.isInterrupted()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            t.interrupt();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SecurityException ignore) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="method-drainQueue"><a href="#method-drainQueue" class="headerlink" title="method::drainQueue"></a>method::drainQueue</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// å°†ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ·»åŠ è¿›åˆ—è¡¨ä¸­è¿”å›</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> List&lt;Runnable&gt; <span class="title">drainQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    BlockingQueue&lt;Runnable&gt; q = workQueue;</span><br><span class="line">    ArrayList&lt;Runnable&gt; taskList = <span class="keyword">new</span> ArrayList&lt;Runnable&gt;();</span><br><span class="line">    q.drainTo(taskList);</span><br><span class="line">    <span class="comment">// å¦‚æœé˜Ÿåˆ—æ˜¯å»¶è¿Ÿé˜Ÿåˆ—æˆ–æ˜¯å…¶ä»–æ— æ³•é€šè¿‡drainTo()æ–¹æ³•è½¬ç§»ä»»åŠ¡æ—¶ï¼Œå†é€šè¿‡å¾ªç¯éå†è¿›è¡Œè½¬ç§»</span></span><br><span class="line">    <span class="keyword">if</span> (!q.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Runnable r : q.toArray(<span class="keyword">new</span> Runnable[<span class="number">0</span>])) &#123;</span><br><span class="line">            <span class="keyword">if</span> (q.remove(r))</span><br><span class="line">                taskList.add(r);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> taskList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="æ‹’ç»ç­–ç•¥"><a href="#æ‹’ç»ç­–ç•¥" class="headerlink" title="æ‹’ç»ç­–ç•¥"></a>æ‹’ç»ç­–ç•¥</h1><h2 id="CallerRunsPolicy"><a href="#CallerRunsPolicy" class="headerlink" title="CallerRunsPolicy"></a>CallerRunsPolicy</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CallerRunsPolicy</span> <span class="keyword">implements</span> <span class="title">RejectedExecutionHandler</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a &#123;<span class="doctag">@code</span> CallerRunsPolicy&#125;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CallerRunsPolicy</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Executes task r in the caller's thread, unless the executor</span></span><br><span class="line"><span class="comment">     * has been shut down, in which case the task is discarded.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> r the runnable task requested to be executed</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> e the executor attempting to execute this task</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rejectedExecution</span><span class="params">(Runnable r, ThreadPoolExecutor e)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Â å¦‚æ–‡æ¡£æè¿°ï¼Œå¦‚æœçº¿ç¨‹æ± æ²¡å…³é—­ï¼Œåœ¨å½“å‰çº¿ç¨‹ä¸­æ‰§è¡Œ</span></span><br><span class="line">        <span class="keyword">if</span> (!e.isShutdown()) &#123;</span><br><span class="line">            r.run();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="AbortPolicy"><a href="#AbortPolicy" class="headerlink" title="AbortPolicy"></a>AbortPolicy</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AbortPolicy</span> <span class="keyword">implements</span> <span class="title">RejectedExecutionHandler</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates an &#123;<span class="doctag">@code</span> AbortPolicy&#125;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AbortPolicy</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Always throws RejectedExecutionException.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> r the runnable task requested to be executed</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> e the executor attempting to execute this task</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> RejectedExecutionException always</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rejectedExecution</span><span class="params">(Runnable r, ThreadPoolExecutor e)</span> </span>&#123;</span><br><span class="line">      <span class="comment">// ç›´æ¥æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RejectedExecutionException(<span class="string">"Task "</span> + r.toString() +</span><br><span class="line">                                             <span class="string">" rejected from "</span> +</span><br><span class="line">                                             e.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="DiscardPolicy"><a href="#DiscardPolicy" class="headerlink" title="DiscardPolicy"></a>DiscardPolicy</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DiscardPolicy</span> <span class="keyword">implements</span> <span class="title">RejectedExecutionHandler</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a &#123;<span class="doctag">@code</span> DiscardPolicy&#125;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DiscardPolicy</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Does nothing, which has the effect of discarding task r.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> r the runnable task requested to be executed</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> e the executor attempting to execute this task</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rejectedExecution</span><span class="params">(Runnable r, ThreadPoolExecutor e)</span> </span>&#123;</span><br><span class="line">      <span class="comment">//Does nothing, which has the effect of discarding task r.</span></span><br><span class="line">      <span class="comment">// ä¸åšä»»ä½•å¤„ç†ï¼Œç›´æ¥ä¸¢å¼ƒ</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="DiscardOldestPolicy"><a href="#DiscardOldestPolicy" class="headerlink" title="DiscardOldestPolicy"></a>DiscardOldestPolicy</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DiscardOldestPolicy</span> <span class="keyword">implements</span> <span class="title">RejectedExecutionHandler</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a &#123;<span class="doctag">@code</span> DiscardOldestPolicy&#125; for the given executor.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DiscardOldestPolicy</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Obtains and ignores the next task that the executor</span></span><br><span class="line"><span class="comment">     * would otherwise execute, if one is immediately available,</span></span><br><span class="line"><span class="comment">     * and then retries execution of task r, unless the executor</span></span><br><span class="line"><span class="comment">     * is shut down, in which case task r is instead discarded.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> r the runnable task requested to be executed</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> e the executor attempting to execute this task</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rejectedExecution</span><span class="params">(Runnable r, ThreadPoolExecutor e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!e.isShutdown()) &#123;</span><br><span class="line">           <span class="comment">// ç§»é™¤workerä¸­é˜»å¡æœ€æ—§çš„ä»»åŠ¡ï¼Œå°†å½“å‰ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—ã€‚</span></span><br><span class="line">            e.getQueue().poll();</span><br><span class="line">            e.execute(r);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;åˆ›å»ºçº¿ç¨‹æ± çš„æ–¹å¼æœ‰Executorså’ŒThreadPoolExecutorlä¸¤ç§æ–¹å¼ï¼›ThreadPoolExecutoræ˜¯ä½œä¸ºæœ€åŸºç¡€çš„åˆ›å»ºæ–¹å¼ï¼Œå†æ¬¡æ•´ç†åŠ æ·±äº†è§£ï¼&lt;/p&gt;&lt;/blockquote&gt;
    
    </summary>
    
      <category term="çº¿ç¨‹æ± " scheme="http://yoursite.com/categories/%E7%BA%BF%E7%A8%8B%E6%B1%A0/"/>
    
    
      <category term="çº¿ç¨‹æ± " scheme="http://yoursite.com/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/"/>
    
      <category term="ThreadPoolExcutor" scheme="http://yoursite.com/tags/ThreadPoolExcutor/"/>
    
  </entry>
  
  <entry>
    <title>Javaå†…å­˜æ¨¡å‹å°è®°01</title>
    <link href="http://yoursite.com/2021/09/13/20210913/"/>
    <id>http://yoursite.com/2021/09/13/20210913/</id>
    <published>2021-09-13T14:15:24.000Z</published>
    <updated>2021-09-15T15:17:46.220Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>ä»Šå¤©å’Œè€å¤§èŠJVMå†…å­˜æ¨¡å‹ï¼Œä¸€å¼€å£ï¼Œè€å¤§å°±æŒ‡å‡ºæˆ‘æŠŠJVMå†…å­˜æ¨¡å‹å’ŒJavaè™šæ‹Ÿæœºè¿è¡Œæ—¶æ•°æ®åŒºæåäº†ï¼Œåœ¨ç½‘ä¸Šç¿»äº†å¾ˆå¤šåšå®¢ï¼Œå‘ç°éƒ½æåäº†ï¼Œç¿»äº†<a href="http://www.cs.umd.edu/~pugh/java/memoryModel/jsr133.pdf" target="_blank" rel="noopener"> JSR-133: Java Memory Model and Thread Specification </a>å’Œã€Šæ·±å…¥JVMè™šæ‹Ÿæœºã€‹æ‰äº†è§£å…·ä½“çš„å®šä¹‰ã€‚<a id="more"></a></p></blockquote><h1 id="å†…å­˜æ¨¡å‹æ¦‚å¿µ"><a href="#å†…å­˜æ¨¡å‹æ¦‚å¿µ" class="headerlink" title="å†…å­˜æ¨¡å‹æ¦‚å¿µ"></a>å†…å­˜æ¨¡å‹æ¦‚å¿µ</h1><p>Javaå†…å­˜æ¨¡å‹çš„ä¸»è¦ç›®æ ‡æ˜¯å®šä¹‰ç¨‹åºä¸­å„ä¸ªå˜é‡çš„è®¿é—®è§„åˆ™ã€‚å³åœ¨è™šæ‹Ÿæœºä¸­å°†å˜é‡å­˜å‚¨åˆ°å†…å­˜å’Œä»å†…å­˜ä¸­å–å‡ºå˜é‡è¿™æ ·çš„åº•å±‚ç»†èŠ‚ã€‚</p><p><img src="/2021/09/13/20210913/memoryModel.png" alt="äº¤äº’å…³ç³»"></p><p>ä¸»å†…å­˜ï¼šå­˜å‚¨Javaæ‰€æœ‰çš„å˜é‡</p><p>å·¥ä½œå†…å­˜ï¼šæ¯æ¡çº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„å·¥ä½œå†…å­˜ï¼Œå…¶ä¸­ä¿ç•™äº†è¢«è¯¥çº¿ç¨‹ä½¿ç”¨åˆ°çš„å˜é‡çš„ä¸»å†…å­˜å‰¯æœ¬æ‹·è´ï¼Œçº¿ç¨‹å¯¹å˜é‡çš„æ‰€æœ‰æ“ä½œï¼ˆè¯»å–å’Œèµ‹å€¼ç­‰ï¼‰éƒ½å¿…é¡»åœ¨å·¥ä½œå†…å­˜ä¸­è¿›è¡Œï¼Œè€Œä¸èƒ½ç›´æ¥è¯»å†™ä¸»å†…å­˜ä¸­çš„å˜é‡ã€‚ </p><p>ä¸åŒçš„çº¿ç¨‹ä¹‹é—´æ— æ³•ç›´æ¥è®¿é—®å¯¹æ–¹çš„å·¥ä½œå†…å­˜ä¸­çš„å˜é‡ï¼Œçº¿ç¨‹é—´å˜é‡å€¼çš„ä¼ é€’å‡éœ€è¦é€šè¿‡ä¸»å†…å­˜æ¥å®Œæˆã€‚</p><h1 id="å†…å­˜é—´å¦‚ä½•äº¤äº’"><a href="#å†…å­˜é—´å¦‚ä½•äº¤äº’" class="headerlink" title="å†…å­˜é—´å¦‚ä½•äº¤äº’"></a>å†…å­˜é—´å¦‚ä½•äº¤äº’</h1><p><img src="/2021/09/13/20210913/memory02.png" alt="å†…å­˜äº¤äº’"></p><p>ç¨‹åºéœ€è¦å¯¹ä¸»å†…å­˜ä¸­çš„testA=1å˜é‡è¿›è¡Œè®¿é—®æ—¶ï¼Œå¦‚æœä¸ºäº†ä¿è¯å¹¶å‘ä¿®æ”¹é—®é¢˜ï¼š</p><ol><li><p>å…ˆå¯¹ä¸»å†…å­˜ä¸­çš„testA=1è¿›è¡ŒlockåŠ é”ã€‚ï¼ˆlockï¼‰</p></li><li><p>è¯»å–ä¸»å†…å­˜ä¸­çš„å˜é‡testAå¹¶å°†å…¶ä¼ è¾“åˆ°çº¿ç¨‹çš„å·¥ä½œå†…å­˜ä¸­ã€‚ï¼ˆreadï¼‰</p></li><li><p>æŠŠä»ä¸»å†…å­˜å¾—åˆ°çš„testAå˜é‡æ”¾å…¥å·¥ä½œå†…å­˜çš„å˜é‡å‰¯æœ¬ä¸­ã€‚ï¼ˆloadï¼‰</p></li><li><p>å½“æœ‰æ‰§è¡Œå¼•æ“éœ€è¦è¿™ä¸ªå€¼æ—¶ï¼Œå°†å·¥ä½œå†…å­˜ä¸­çš„testAå˜é‡ä¼ é€’ç»™è°ƒç”¨è€…ã€‚ï¼ˆuseï¼‰</p></li><li><p>æ‰§è¡Œå¼•æ“å¯¹testA=1é‡æ–°èµ‹å€¼ä¸ºtestA=2ã€‚ï¼ˆassignï¼‰</p></li><li>å¦‚æœå¯¹å·¥ä½œå†…å­˜ä¸­çš„å˜é‡é‡æ–°å¤åˆ¶æ“ä½œï¼ˆassignï¼‰ï¼Œå¿…é¡»å°†å·¥ä½œå†…å­˜çš„testA=2åŒæ­¥åˆ°writeã€‚å¦‚æœæ²¡æœ‰å‘ç”Ÿä»»ä½•assignæ“ä½œï¼Œåˆ™ä¸å…è®¸è¿›è¡ŒåŒæ­¥æ“ä½œã€‚ï¼ˆstoreï¼‰</li><li>å°†åŒæ­¥åˆ°ä¸»å†…å­˜çš„testA=2å†™å…¥åˆ°ä¸»å†…å­˜çš„å˜é‡testAä¸­ã€‚</li><li>åœ¨æ‰§è¡Œunlockæ“ä½œå‰ï¼Œå¿…é¡»æŠŠå˜é‡åŒæ­¥å†™å…¥åˆ°ä¸»å†…å­˜ä¸­ã€‚unlockå’Œlockçš„æ‰§è¡Œæ¬¡æ•°ä¸€è‡´ã€‚</li></ol><p>å¯¹äºå¤§éƒ¨åˆ†çš„æ•°æ®å¹¶å‘ç«äº‰é—®é¢˜é€‚ç”¨ï¼ˆsynchronizedï¼‰ï¼Œä½†æ˜¯volatileæœ‰è‡ªå·±çš„ç‰¹æ®Šè§„åˆ™ã€‚</p><h1 id="ç‰¹æ®Šè§„åˆ™-volatileå˜é‡"><a href="#ç‰¹æ®Šè§„åˆ™-volatileå˜é‡" class="headerlink" title="ç‰¹æ®Šè§„åˆ™- volatileå˜é‡"></a>ç‰¹æ®Šè§„åˆ™- volatileå˜é‡</h1><p>å½“ä¸€ä¸ªå˜é‡å®šäºä¸ºvolatileï¼Œå®ƒå°†å…·å¤‡ä¸¤ç§ç‰¹æ€§ï¼š</p><ol><li><p>ä¿è¯æ­¤å˜é‡å¯¹æ‰€æœ‰çº¿ç¨‹å¯è§æ€§ã€‚</p><p>åœ¨å„ä¸ªçº¿ç¨‹çš„å·¥ä½œå†…å­˜ä¸­ï¼Œvolatileå˜é‡ä¹Ÿå¯ä»¥å­˜åœ¨ä¸ä¸€è‡´çš„æƒ…å†µï¼Œä½†ç”±äºæ¯æ¬¡ä½¿ç”¨ä¹‹å‰éƒ½è¦åˆ·æ–°ï¼Œæ‰§è¡Œå¼•æ“çœ‹ä¸åˆ°ä¸ä¸€è‡´çš„æƒ…å†µï¼Œå› æ­¤å¯ä»¥ä»»åŠ¡ä¸å­˜åœ¨ä¸€è‡´æ€§é—®é¢˜ã€‚ä½†æ˜¯Javaé‡Œé¢çš„è¿ç®—å¹¶éåŸå­æ“ä½œï¼Œå¯¼è‡´volatileå˜é‡çš„è¿ç®—åœ¨å¹¶å‘ä¸‹ä¸€æ ·æ—¶ä¸å®‰å…¨çš„ã€‚</p><p>ç”±äºvolatileå˜é‡åªèƒ½ä¿è¯å¯è§æ€§ï¼Œåœ¨ä¸ç¬¦åˆä»¥ä¸‹çš„ä¸¤æ¡è§„åˆ™çš„è¿ç®—åœºæ™¯ä¸‹ï¼Œå¯ä»¥é€šè¿‡åŠ é”ï¼ˆsynchronize/åŸå­ç±»ï¼‰æ¥ä¿è¯å¹¶å‘æ€§ã€‚</p><p>I    è¿ç®—ç»“æœå¹¶ä¸ä¾èµ–å˜é‡çš„å½“å‰å€¼ï¼Œæˆ–è€…èƒ½å¤Ÿç¡®ä¿åªæœ‰å•ä¸€çš„çº¿ç¨‹ä¿®æ”¹å˜é‡çš„å€¼ã€‚</p><p>II   å˜é‡ä¸éœ€è¦ä¸å…¶ä»–çš„çŠ¶æ€å˜é‡å…±åŒå‚ä¸ä¸å˜çº¦æŸã€‚</p></li><li><p>ç¦æ­¢æŒ‡ä»¤é‡æ’åºä¼˜åŒ–ï¼Œæ™®é€šçš„å˜é‡ä»…ä»…ä¼šä¿è¯åœ¨è¯¥æ–¹æ³•çš„æ‰§è¡Œè¿‡ç¨‹ä¸­æ‰€æœ‰ä¾èµ–èµ‹å€¼ç»“æœçš„éƒ½èƒ½è·å–åˆ°æ­£ç¡®çš„ç»“æœï¼Œè€Œä¸èƒ½ä¿è¯å˜é‡èµ‹å€¼æ—¶æ“ä½œçš„é¡ºåºä¸ç¨‹åºä»£ç ä¸­çš„æ‰§è¡Œé¡ºåºä¸€è‡´ã€‚</p><p>åœ¨å†™æ“ä½œæ’å…¥è®¸å¤šå†…å­˜å±éšœæ¥ä¿è¯å¤„ç†å™¨ä¸å‘ç”Ÿä¹±åºæ‰§è¡Œã€‚</p></li></ol><h1 id="æ¨¡å‹è§£å†³äº†ä»€ä¹ˆé—®é¢˜"><a href="#æ¨¡å‹è§£å†³äº†ä»€ä¹ˆé—®é¢˜" class="headerlink" title="æ¨¡å‹è§£å†³äº†ä»€ä¹ˆé—®é¢˜"></a>æ¨¡å‹è§£å†³äº†ä»€ä¹ˆé—®é¢˜</h1><p>Javaçš„å†…å­˜æ¨¡å‹ä¿è¯åœ¨å¹¶å‘è¿‡ç¨‹ä¸­å¤„ç†é—®é¢˜çš„åŸå­æ€§ã€å¯è§æ€§ã€æœ‰åºæ€§ã€‚</p><p>åŸå­æ€§ï¼šLock/unlockï¼Œsynchronizeçš„monitorenter/monitorexitæ»¡è¶³åŸå­æ€§çš„éœ€æ±‚ã€‚</p><p>å¯è§æ€§ï¼švolatile/synchronize/finalä¿è¯äº†å¯è§æ€§ã€‚</p><p>æœ‰åºæ€§ï¼š</p><ol><li>volatileçš„ç¦æ­¢æŒ‡ä»¤é‡æ’åºè¯­ä¹‰ã€‚</li><li>synchronizeçš„ä¸€ä¸ªå˜é‡åœ¨åŒä¸€æ—¶åˆ»åªå…è®¸ä¸€æ¡çº¿ç¨‹å¯¹å…¶è¿›è¡Œlockæ“ä½œã€‚</li><li>å…ˆè¡Œå‘ç”ŸåŸåˆ™ã€‚</li></ol>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;ä»Šå¤©å’Œè€å¤§èŠJVMå†…å­˜æ¨¡å‹ï¼Œä¸€å¼€å£ï¼Œè€å¤§å°±æŒ‡å‡ºæˆ‘æŠŠJVMå†…å­˜æ¨¡å‹å’ŒJavaè™šæ‹Ÿæœºè¿è¡Œæ—¶æ•°æ®åŒºæåäº†ï¼Œåœ¨ç½‘ä¸Šç¿»äº†å¾ˆå¤šåšå®¢ï¼Œå‘ç°éƒ½æåäº†ï¼Œç¿»äº†&lt;a href=&quot;http://www.cs.umd.edu/~pugh/java/memoryModel/jsr133.pdf&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt; JSR-133: Java Memory Model and Thread Specification &lt;/a&gt;å’Œã€Šæ·±å…¥JVMè™šæ‹Ÿæœºã€‹æ‰äº†è§£å…·ä½“çš„å®šä¹‰ã€‚&lt;/p&gt;&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="JVM" scheme="http://yoursite.com/tags/JVM/"/>
    
  </entry>
  
  <entry>
    <title>æ…¢æŸ¥è¯¢æ’æŸ¥è®°å½•</title>
    <link href="http://yoursite.com/2021/08/01/20210801/"/>
    <id>http://yoursite.com/2021/08/01/20210801/</id>
    <published>2021-08-01T07:48:23.000Z</published>
    <updated>2021-09-15T16:39:00.770Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>åœ¨å¹³æ—¶çš„å¼€å‘æ“ä½œä¸­ï¼Œä¼šå†™å‡ºä¸€äº›æ…¢SQLï¼Œåªæ˜¯çŸ¥é“å¦‚ä½•é¿å…æ…¢SQLï¼Œä½†æ˜¯æ²¡æœ‰å…·ä½“çš„äº†è§£æ…¢SQLçš„è¡¡é‡æ ‡å‡†ï¼Œå®ƒä¸ºä»€ä¹ˆä¼šå¯¼è‡´æŸ¥è¯¢æ•ˆç‡çš„ç¼“å­˜ï¼Œåªæœ‰äº†è§£æ…¢SQLäº§ç”Ÿçš„åŸå› ï¼Œæ‰èƒ½æ›´å¥½çš„é¿å…å†™å‡ºæ…¢SQLã€‚ <a id="more"></a></p></blockquote><h1 id="æ…¢æŸ¥è¯¢æ˜¯å¦‚ä½•äº§ç”Ÿçš„"><a href="#æ…¢æŸ¥è¯¢æ˜¯å¦‚ä½•äº§ç”Ÿçš„" class="headerlink" title="æ…¢æŸ¥è¯¢æ˜¯å¦‚ä½•äº§ç”Ÿçš„"></a>æ…¢æŸ¥è¯¢æ˜¯å¦‚ä½•äº§ç”Ÿçš„</h1><p>æ…¢æŸ¥è¯¢äº§ç”Ÿçš„åŸå› å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªå¤§ç±»ä¸»åŠ¨å’Œè¢«åŠ¨ï¼ˆè‡ªæˆ‘ç†è§£ï¼‰ï¼Œä¸»åŠ¨å°±æ˜¯åœ¨å†™SQLæ—¶ä¸šåŠ¡é€»è¾‘å¤„ç†ä¸æ¸…æ™°å¯¼è‡´çš„ï¼Œè¢«åŠ¨å°±æ˜¯é€»è¾‘æ¸…æ™°ä½†æ˜¯SQLçš„æŸ¥è¯¢æ–¹å¼éœ€è¦ä¼˜åŒ–ï¼Œç®€å•çš„è¯´å°±æ˜¯ä¸šåŠ¡èƒ½åŠ›ä¸æŠ€æœ¯èƒ½åŠ›äº§ç”Ÿã€‚</p><p>é€šå¸¸ç”±ä»¥ä¸‹é—®é¢˜å¯¼è‡´æ…¢æŸ¥è¯¢ï¼š</p><ol><li>æŸ¥è¯¢ä¸éœ€è¦çš„è®°å½•</li><li>å¤šè¡¨å…³è”æ—¶è¿”å›å…¨éƒ¨åˆ—</li><li>æ€»æ˜¯å–å‡ºå…¨éƒ¨åˆ—</li><li>é‡å¤æŸ¥è¯¢ç›¸åŒçš„æ•°æ®</li></ol><p>è¡¡é‡æ…¢æŸ¥è¯¢çš„æŒ‡æ ‡ï¼š</p><ol><li>å“åº”æ—¶é—´</li><li>æ‰«æçš„è¡Œæ•°</li><li>è¿”å›çš„è¡Œæ•°</li></ol><p>å“åº”æ—¶é—´æ˜¯æŒ‡æœåŠ¡æ—¶é—´å’Œæ’é˜Ÿæ—¶é—´ã€‚æ’é˜Ÿæ—¶é—´æ˜¯æŒ‡æ•°æ®åº“å¤„ç†äº†è¿™ä¸ªæ…¢æŸ¥è¯¢çœŸæ­£èŠ±è´¹çš„æ—¶é—´ã€‚æ’é˜Ÿæ—¶é—´æ˜¯æŒ‡æœåŠ¡å™¨å› ä¸ºç­‰å¾…æŸäº›èµ„æºè€Œæ²¡æœ‰çœŸæ­£æ‰§è¡ŒæŸ¥è¯¢çš„æ—¶é—´ï¼ˆI/Oæˆ–é”ç­‰ï¼‰ã€‚</p><p>åœ¨ä¸åŒçš„åº”ç”¨å‹åŠ›ä¸‹ï¼Œå“åº”æ—¶é—´æ˜¯æ²¡æœ‰è§„å¾‹çš„ï¼Œå“åº”æ—¶é—´ä¼šå—å­˜å‚¨å¼•æ“çš„é”ã€é«˜å¹¶å‘èµ„æºç«äº‰ã€å“åº”æ—¶é—´ç­‰å› ç´ å½±å“ã€‚</p><p>æ‰«æçš„è¡Œæ•°å’Œè¿”å›çš„è¡Œæ•°åœ¨ç†æƒ³ç†æƒ³æƒ…å†µä¸‹æ˜¯1:1ï¼Œä½†æ˜¯åœ¨ç”Ÿäº§ä¸­å´æ˜¯ç›¸åçš„ã€‚</p><h1 id="äº†è§£æŸ¥è¯¢æ‰§è¡Œçš„è¿‡ç¨‹"><a href="#äº†è§£æŸ¥è¯¢æ‰§è¡Œçš„è¿‡ç¨‹" class="headerlink" title="äº†è§£æŸ¥è¯¢æ‰§è¡Œçš„è¿‡ç¨‹"></a>äº†è§£æŸ¥è¯¢æ‰§è¡Œçš„è¿‡ç¨‹</h1><p><img src="/2021/08/01/20210801/æŸ¥è¯¢æ‰§è¡Œè·¯å¾„.jpg" alt="&#39;æŸ¥è¯¢æ‰§è¡Œè·¯å¾„&#39;"> </p><h2 id="é€šè®¯åè®®"><a href="#é€šè®¯åè®®" class="headerlink" title="é€šè®¯åè®®"></a>é€šè®¯åè®®</h2><p>MySQLå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„é€šä¿¡åè®®æ˜¯â€åŠåŒå·¥â€çš„ï¼Œæ‰€ä»¥åœ¨ä»»ä½•ä¸€ä¸ªæ—¶åˆ»ï¼Œè¦ä¹ˆæ˜¯å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€æ•°æ®ï¼Œè¦ä¹ˆæ˜¯æœåŠ¡ç«¯å‘å®¢æˆ·ç«¯å‘é€æ•°æ®ï¼Œä¸¤ä¸ªåŠ¨ä½œä¸èƒ½åŒæ—¶å‘ç”Ÿã€‚</p><p>å¤šæ•°è¿æ¥MySQLçš„åº“å‡½æ•°éƒ½å¯ä»¥è·çš„å…¨éƒ¨ç»“æœå¹¶ç¼“å­˜åˆ°å†…å­˜é‡Œï¼Œè¿˜å¯ä»¥é€è¡Œè·å–éœ€è¦çš„æ•°æ®ã€‚é»˜è®¤ä¸€èˆ¬æ˜¯è·çš„å…¨éƒ¨ç»“æœé›†å¹¶ç¼“å­˜åˆ°å†…å­˜ä¸­ã€‚MySQLé€šå¸¸éœ€è¦ç­‰å¾…æ‰€æœ‰çš„æ•°æ®éƒ½å·²ç»å‘é€ç»™å®¢æˆ·ç«¯æ‰èƒ½é‡Šæ”¾è¿™æ¡æŸ¥è¯¢æ‰€å ç”¨çš„èµ„æºï¼Œæ‰€ä»¥æ¥å—å…¨éƒ¨ç»“æœå¹¶ç¼“å­˜é€šå¸¸å¯ä»¥å‡å°‘æœåŠ¡å™¨çš„å‹åŠ›ï¼Œè®©æŸ¥è¯¢èƒ½å¤Ÿæ—©ç‚¹ç»“æŸã€æ—©ç‚¹é‡Šæ”¾ç›¸åº”çš„èµ„æºã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">test</span>;</span><br></pre></td></tr></table></figure><p>åœ¨testè¡¨ä¸­æœ‰1000ä¸‡æ¡æ•°æ®ï¼Œå°†æŸ¥è¯¢çš„ç»“æœé›†è¿›è¡Œç¼“å­˜ä¼šèŠ±è´¹å¤§é‡çš„æ—¶é—´å’Œå†…å­˜ï¼Œæ¶ˆè€—å†…å­˜çš„æˆæœ¬å¤§äºæ—¶é—´æˆæœ¬ï¼Œå¯ä»¥è€ƒè™‘ä¸é€‚ç”¨ç¼“å­˜ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Show</span> <span class="keyword">full</span> <span class="keyword">processlist</span>;</span><br></pre></td></tr></table></figure><h2 id="æŸ¥è¯¢çš„çŠ¶æ€"><a href="#æŸ¥è¯¢çš„çŠ¶æ€" class="headerlink" title="æŸ¥è¯¢çš„çŠ¶æ€"></a>æŸ¥è¯¢çš„çŠ¶æ€</h2><p>æŸ¥çœ‹å½“å‰çº¿ç¨‹çš„çŠ¶æ€ã€‚</p><table><thead><tr><th>çŠ¶æ€</th><th></th></tr></thead><tbody><tr><td>Sleep</td><td>çº¿ç¨‹æ­£åœ¨ç­‰å¾…å®¢æˆ·ç«¯å‘é€æ–°çš„è¯·æ±‚ã€‚</td></tr><tr><td>Query</td><td>çº¿ç¨‹æ­£åœ¨æ‰§è¡ŒæŸ¥è¯¢æˆ–è€…æ­£åœ¨å°†ç»“æœå‘é€ç»™å®¢æˆ·ç«¯ã€‚</td></tr><tr><td>Locked</td><td>è¯¥çº¿ç¨‹æ­£åœ¨ç­‰å¾…é”</td></tr><tr><td>Analyzing and statistics</td><td>çº¿ç¨‹æ­£åœ¨æ”¶é›†å­˜å‚¨å¼•æ“çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œå¹¶ç”ŸæˆæŸ¥è¯¢çš„æ‰§è¡Œè®¡åˆ’ã€‚</td></tr><tr><td>Copying to tmp table [on disk]</td><td>çº¿ç¨‹æ­£åœ¨æ‰§è¡ŒæŸ¥è¯¢ï¼Œå¹¶ä¸”å°†å…¶ç»“æœé›†éƒ½å¤åˆ¶åˆ°ä¸€ä¸ªä¸´æ—¶è¡¨ä¸­ã€‚</td></tr><tr><td>Sorting resule</td><td>çº¿ç¨‹æ­£åœ¨å¯¹ç»“æœé›†è¿›è¡Œæ’åºã€‚</td></tr><tr><td>Sending data</td><td>çº¿ç¨‹å¯èƒ½åœ¨å¤šä¸ªçŠ¶æ€ä¹‹é—´ä¼ é€’æ•°æ®ï¼Œæˆ–è€…åœ¨ç”Ÿæˆç»“æœé›†ï¼Œæ´»åœ¨åœ¨å‘å®¢æˆ·ç«¯è¿”å›ç»“æœé›†ã€‚</td></tr></tbody></table><h2 id="æŸ¥è¯¢ç¼“å­˜"><a href="#æŸ¥è¯¢ç¼“å­˜" class="headerlink" title="æŸ¥è¯¢ç¼“å­˜"></a>æŸ¥è¯¢ç¼“å­˜</h2><p>åœ¨è§£æä¸€ä¸ªæŸ¥è¯¢è¯­å¥ä¹‹å‰ï¼Œå¦‚æœæŸ¥è¯¢ç¼“å­˜æ˜¯æ‰“å¼€çš„ï¼ŒMySQLä¼šæ ¹æ®ä¸€ä¸ªå¯¹å¤§å°å†™æ•æ„Ÿçš„å“ˆå¸Œä»ç¼“å­˜ä¸­ä¼˜å…ˆæŸ¥è¯¢ï¼Œå¦‚æœå‘½ä¸­äº†ç¼“å­˜ï¼Œä¼šç›´æ¥ä»ç¼“å­˜ä¸­è·å–ç»“æœå¹¶è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p><p>##æŸ¥è¯¢ä¼˜åŒ–å¤„ç†</p><p>æŸ¥è¯¢ä¼˜åŒ–åŒ…å«å¤šä¸ªå­—é˜¶æ®µï¼šè§£æSQLã€é¢„å¤„ç†ã€ä¼˜åŒ–SQLæ‰§è¡Œè®¡åˆ’ã€‚</p><h2 id="è¯­æ³•è§£æå…¶å’Œé¢„å¤„ç†"><a href="#è¯­æ³•è§£æå…¶å’Œé¢„å¤„ç†" class="headerlink" title="è¯­æ³•è§£æå…¶å’Œé¢„å¤„ç†"></a>è¯­æ³•è§£æå…¶å’Œé¢„å¤„ç†</h2><p>MySQLé€šè¿‡å…³é”®å­—å°†SQLè¯­æ³•è§£æï¼Œå¹¶ç”Ÿæˆä¸€æ£µå¯¹åº”çš„â€œè§£ææ ‘â€ï¼ŒMySQLè§£æå™¨å°†ä½¿ç”¨MySQLè¯­æ³•è§„åˆ™éªŒè¯å’Œè§£ææŸ¥è¯¢ã€‚</p><h2 id="æŸ¥è¯¢ä¼˜åŒ–å™¨"><a href="#æŸ¥è¯¢ä¼˜åŒ–å™¨" class="headerlink" title="æŸ¥è¯¢ä¼˜åŒ–å™¨"></a>æŸ¥è¯¢ä¼˜åŒ–å™¨</h2><p>ä¸€æ¡æŸ¥è¯¢å¯ä»¥æœ‰å¾ˆå¤šç§æ‰§è¡Œæ–¹å¼ï¼Œæœ€åéƒ½è¿”å›ç›¸åŒçš„ç»“æœã€‚ä¼˜åŒ–å™¨çš„ä½œç”¨å°±æ˜¯æ‰¾åˆ°å…¶ä¸­æœ€å¥½çš„æ‰§è¡Œè®¡åˆ’ã€‚</p><p>éœ€è¦å¦ä½œä¸€ç‰‡æ–‡ç« è¿›è¡Œè®¨è®ºã€‚</p><h2 id="æ‰§è¡Œè®¡åˆ’"><a href="#æ‰§è¡Œè®¡åˆ’" class="headerlink" title="æ‰§è¡Œè®¡åˆ’"></a>æ‰§è¡Œè®¡åˆ’</h2><p>MySQLç”ŸæˆæŸ¥è¯¢çš„ä¸€æ£µæŒ‡ä»¤æ ‘ï¼Œç„¶åé€šè¿‡å­˜å‚¨å¼•æ“æ‰§è¡Œå®Œæˆè¿™æ£µæŒ‡ä»¤æ ‘å¹¶è¿”å›ç»“æœã€‚</p><p>MySQLæ€»æ˜¯ä»ä¸€ä¸ªè¡¨å¼€å§‹ä¸€ç›´åµŒå¥—å¾ªç¯ã€å›æº¯å®Œæˆæ‰€æœ‰è¡¨å…³è”ã€‚MySQLçš„æ‰§è¡Œè®¡åˆ’æ˜¯ä¸€åˆ»å·¦æµ‹æ·±åº¦ä¼˜å…ˆçš„æ ‘ã€‚</p><h2 id="æŸ¥è¯¢æ‰§è¡Œå¼•æ“"><a href="#æŸ¥è¯¢æ‰§è¡Œå¼•æ“" class="headerlink" title="æŸ¥è¯¢æ‰§è¡Œå¼•æ“"></a>æŸ¥è¯¢æ‰§è¡Œå¼•æ“</h2><p>MySQLæ ¹æ®æ‰§è¡Œè®¡åˆ’çš„æŒ‡ä»¤é€æ­¥æ‰§è¡Œã€‚åœ¨æ ¹ç»æ‰§è¡Œè®¡åˆ’é€æ­¥æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œæœ‰å¤§é‡çš„æ“ä½œéœ€è¦é€šè¿‡è°ƒç”¨å­˜å‚¨å¼•æ“å®ç°çš„æ¥å£å®Œæˆï¼Œå³â€handler APIâ€œæ¥å£ã€‚æŸ¥è¯¢ä¸­çš„æ¯ä¸€ä¸ªè¡¨ç”±ä¸€ä¸ªhandlerçš„å®ä¾‹è¡¨ç¤ºã€‚</p><h2 id="è¿”å›ç»“æœç»™å®¢æˆ·ç«¯"><a href="#è¿”å›ç»“æœç»™å®¢æˆ·ç«¯" class="headerlink" title="è¿”å›ç»“æœç»™å®¢æˆ·ç«¯"></a>è¿”å›ç»“æœç»™å®¢æˆ·ç«¯</h2><p>æŸ¥è¯¢æ‰§è¡Œçš„æœ€åä¸€é˜¶æ®µæ˜¯å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚å³ä½¿æŸ¥è¯¢ä¸éœ€è¦è¿”å›ç»“æœé›†ç»™å®¢æˆ·ç«¯ï¼ŒMySQLä»»ä¼šè¿”å›æŸ¥è¯¢çš„ä¸€äº›ä¿¡æ¯ã€‚</p><p>MySQLå°†ç»“æœé›†è¿”å›å®¢æˆ·ç«¯æ˜¯ä¸€ä¸ªå¢é‡ã€é€æ­¥è¿”å›çš„è¿‡ç¨‹ã€‚è¿™æ ·åšæœåŠ¡å™¨ç«¯æ— é¡»å­˜å‚¨å¤ªå¤šçš„ç»“æœï¼Œå‡å°‘å†…å­˜çš„æ¶ˆè€—ï¼›MySQLå®¢æˆ·ç«¯ç¬¬ä¸€æ—¶é—´è·å¾—è¿”å›çš„ç»“æœã€‚</p><h1 id="æ…¢æŸ¥è¯¢äº§ç”Ÿçš„ç¯èŠ‚"><a href="#æ…¢æŸ¥è¯¢äº§ç”Ÿçš„ç¯èŠ‚" class="headerlink" title="æ…¢æŸ¥è¯¢äº§ç”Ÿçš„ç¯èŠ‚"></a>æ…¢æŸ¥è¯¢äº§ç”Ÿçš„ç¯èŠ‚</h1><p>æ…¢æŸ¥è¯¢å¯èƒ½æ˜¯åSQLå¯¼è‡´æŸ¥è¯¢ä¼˜åŒ–å™¨æ— æ³•ä¼˜åŒ–ï¼Œæ‰§è¡Œå¼•æ“æ‰§è¡Œç¼“æ…¢ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦åŠ æ·±å¯¹æŸ¥è¯¢ä¼˜åŒ–å™¨çš„ç†è§£ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;åœ¨å¹³æ—¶çš„å¼€å‘æ“ä½œä¸­ï¼Œä¼šå†™å‡ºä¸€äº›æ…¢SQLï¼Œåªæ˜¯çŸ¥é“å¦‚ä½•é¿å…æ…¢SQLï¼Œä½†æ˜¯æ²¡æœ‰å…·ä½“çš„äº†è§£æ…¢SQLçš„è¡¡é‡æ ‡å‡†ï¼Œå®ƒä¸ºä»€ä¹ˆä¼šå¯¼è‡´æŸ¥è¯¢æ•ˆç‡çš„ç¼“å­˜ï¼Œåªæœ‰äº†è§£æ…¢SQLäº§ç”Ÿçš„åŸå› ï¼Œæ‰èƒ½æ›´å¥½çš„é¿å…å†™å‡ºæ…¢SQLã€‚&lt;/p&gt;&lt;/blockquote&gt;
    
    </summary>
    
      <category term="MySQL" scheme="http://yoursite.com/categories/MySQL/"/>
    
    
      <category term="æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–" scheme="http://yoursite.com/tags/%E6%9F%A5%E8%AF%A2%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>Springäº‹åŠ¡è®¾è®¡</title>
    <link href="http://yoursite.com/2020/08/13/2020081301/"/>
    <id>http://yoursite.com/2020/08/13/2020081301/</id>
    <published>2020-08-13T06:45:54.000Z</published>
    <updated>2020-09-14T13:58:34.761Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>Springæä¾›äº†ä¸¤ç§ç¼–ç¨‹å¼äº‹ç‰©ç®¡ç†çš„æ–¹æ³•ï¼š</p><ol><li><p>ä½¿ç”¨TransactionTemplateæˆ–è€…TransactionalOperator. </p></li><li><p>ç›´æ¥å®ç°TransactionManageræ¥å£.  </p></li></ol><p>å¦‚æœæ˜¯ä½¿ç”¨å‘½ä»¤å¼ç¼–ç¨‹ï¼ŒSpringæ¨èä½¿ç”¨TransactionTemplateæ¥å®Œæˆç¼–ç¨‹å¼äº‹åŠ¡ç®¡ç†ï¼Œå¦‚æœæ˜¯å“åº”å¼ç¼–ç¨‹ï¼Œé‚£ä¹ˆä½¿ç”¨TransactionalOperatoræ›´åŠ åˆé€‚<a id="more"></a></p></blockquote><h1 id="TransactionTemplate"><a href="#TransactionTemplate" class="headerlink" title="TransactionTemplate"></a>TransactionTemplate</h1><p><img src="/2020/08/13/2020081301/TransactionTemplate.png" alt="TransactionTemplate"></p><p>TransactionTemplateçš„å·¥ä½œæœºåˆ¶ï¼šå®é™…ä¸Šå°±æ˜¯é€šè¿‡ä¸€ä¸ªTransactionCallbackå°è£…äº†ä¸šåŠ¡é€»è¾‘ï¼Œç„¶åTransactionTemplateä¼šåœ¨äº‹åŠ¡çš„ä¸Šä¸‹æ–‡ä¸­è°ƒç”¨ã€‚è€Œå®é™…ä¸Šæœ‰æ—¶å€™å¹¶ä¸éœ€è¦è¿”å›å€¼ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨TransactionCallbackWithoutResultæä»£TransactionCallbackã€‚</p><h2 id="Eg1"><a href="#Eg1" class="headerlink" title="Eg1"></a>Eg1</h2><p>TransactionTemplateå®Œæˆäº‹åŠ¡å¤„ç†ï¼Œé€šè¿‡å®ç°TransactionCallbackæ¥å£å¹¶åœ¨å…¶doInTransactionæ–¹æ³•å®Œæˆä¸šåŠ¡å¤„ç†ï¼Œä½¿ç”¨å¦‚ä¸‹å›¾ï¼š</p><p><img src="/2020/08/13/2020081301/transactionCallbackWithoutResult.png" alt="TransactionTemplateä½¿ç”¨æ¡ˆä¾‹"></p><h2 id="TransactionTemplate-executeæ–¹æ³•"><a href="#TransactionTemplate-executeæ–¹æ³•" class="headerlink" title="TransactionTemplate#executeæ–¹æ³•"></a>TransactionTemplate#executeæ–¹æ³•</h2><p>TransactionTemplateæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæˆ‘ä»¬å¯ä»¥å…¨å±€é…ç½®ä¸€ä¸ªTransactionTemplateï¼Œç„¶åæ‰€æœ‰çš„ç±»éƒ½å…±äº«è¿™ä¸ªTransactionTemplateã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">execute</span><span class="params">(TransactionCallback&lt;T&gt; action)</span> <span class="keyword">throws</span> TransactionException </span>&#123;</span><br><span class="line">Assert.state(<span class="keyword">this</span>.transactionManager != <span class="keyword">null</span>, <span class="string">"No PlatformTransactionManager set"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.transactionManager <span class="keyword">instanceof</span> CallbackPreferringPlatformTransactionManager) &#123;</span><br><span class="line"><span class="keyword">return</span> ((CallbackPreferringPlatformTransactionManager) <span class="keyword">this</span>.transactionManager).execute(<span class="keyword">this</span>, action);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// 1.é€šè¿‡äº‹ç‰©ç®¡ç†å™¨å¼€å¯äº‹ç‰©</span></span><br><span class="line">TransactionStatus status = <span class="keyword">this</span>.transactionManager.getTransaction(<span class="keyword">this</span>);</span><br><span class="line">T result;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//2.æ‰§è¡Œä¼ å…¥çš„ä¸šåŠ¡é€»è¾‘</span></span><br><span class="line">result = action.doInTransaction(status);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (RuntimeException | Error ex) &#123;</span><br><span class="line"><span class="comment">// Transactional code threw application exception -&gt; rollback</span></span><br><span class="line"><span class="comment">// å‡ºç°å¼‚å¸¸ï¼Œè¿›è¡Œå›æ»š</span></span><br><span class="line">rollbackOnException(status, ex);</span><br><span class="line"><span class="keyword">throw</span> ex;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line"><span class="comment">// Transactional code threw unexpected exception -&gt; rollback</span></span><br><span class="line"><span class="comment">//// å‡ºç°å¼‚å¸¸ï¼Œè¿›è¡Œå›æ»š</span></span><br><span class="line">rollbackOnException(status, ex);</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(ex, <span class="string">"TransactionCallback threw undeclared checked exception"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ‰§è¡ŒæˆåŠŸï¼Œæäº¤äº‹ç‰©</span></span><br><span class="line"><span class="keyword">this</span>.transactionManager.commit(status);</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>#TransactionDefinition</p><p><img src="/2020/08/13/2020081301/RuleBasedTransactionAttribute.png" alt="äº‹åŠ¡çš„å®šä¹‰ä¿¡æ¯"></p><p>æè¿°å¯¹äº‹åŠ¡çš„å±æ€§ï¼Œæ¯”å¦‚äº‹ç‰©çš„ä¼ æ’­æ–¹å¼ï¼Œäº‹ç‰©çš„éš”ç¦»çº§åˆ«ã€‚</p><p><img src="/2020/08/13/2020081301/transactionDefinition.png" alt="äº‹åŠ¡ä¼ æ’­å±æ€§"></p><h1 id="TransactionManageræ¥å£"><a href="#TransactionManageræ¥å£" class="headerlink" title="TransactionManageræ¥å£"></a>TransactionManageræ¥å£</h1><h2 id="PlatformTransactionManager"><a href="#PlatformTransactionManager" class="headerlink" title="PlatformTransactionManager"></a>PlatformTransactionManager</h2><p><img src="/2020/08/13/2020081301/DataSourceTransactionManager.png" alt="äº‹åŠ¡ç®¡ç†å™¨"></p><p>PlatformTransactionManageræ˜¯å‘½ä»¤å¼ç¼–ç¨‹æ¨¡å‹ä¸‹Springäº‹ç‰©æœºåˆ¶çš„ä¸­å¿ƒæ¥å£ï¼Œå®šä¹‰äº†å®Œæˆä¸€ä¸ªäº‹ç‰©å¿…é¡»çš„ä¸‰ä¸ªæ­¥éª¤ã€‚å®šä¹‰äº‹ç‰©æäº¤ï¼Œå›æ»šï¼Œè·å–äº‹ç‰©çŠ¶æ€çš„æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PlatformTransactionManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">TransactionStatus <span class="title">getTransaction</span><span class="params">(@Nullable TransactionDefinition definition)</span> <span class="keyword">throws</span> TransactionException</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">commit</span><span class="params">(TransactionStatus status)</span> <span class="keyword">throws</span> TransactionException</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rollback</span><span class="params">(TransactionStatus status)</span> <span class="keyword">throws</span> TransactionException</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="AbstractPlatformTransactionManager"><a href="#AbstractPlatformTransactionManager" class="headerlink" title="AbstractPlatformTransactionManager"></a>AbstractPlatformTransactionManager</h2><p>SYNCHRONIZATION_ALWAYSï¼šé»˜è®¤ä¸º0</p><p>SYNCHRONIZATION_ON_ACTUAL_TRANSACTIONï¼šé»˜è®¤ä¸º1 </p><p>SYNCHRONIZATION_NEVERï¼šé»˜è®¤ä¸º2</p><p>transactionSynchronization</p><p>defaultTimeout</p><p>nestedTransactionAllowed</p><p>validateExistingTransaction</p><p>globalRollbackOnParticipationFailure</p><p>failEarlyOnGlobalRollbackOnly</p><p>failEarlyOnGlobalRollbackOnly</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> TransactionStatus <span class="title">getTransaction</span><span class="params">(@Nullable TransactionDefinition definition)</span> <span class="keyword">throws</span> TransactionException </span>&#123;</span><br><span class="line">Object transaction = doGetTransaction();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Cache debug flag to avoid repeated checks.</span></span><br><span class="line"><span class="keyword">boolean</span> debugEnabled = logger.isDebugEnabled();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (definition == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="comment">// Use defaults if no transaction definition given.</span></span><br><span class="line">definition = <span class="keyword">new</span> DefaultTransactionDefinition();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (isExistingTransaction(transaction)) &#123;</span><br><span class="line"><span class="comment">// Existing transaction found -&gt; check propagation behavior to find out how to behave.</span></span><br><span class="line"><span class="keyword">return</span> handleExistingTransaction(definition, transaction, debugEnabled);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Check definition settings for new transaction.</span></span><br><span class="line"><span class="keyword">if</span> (definition.getTimeout() &lt; TransactionDefinition.TIMEOUT_DEFAULT) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> InvalidTimeoutException(<span class="string">"Invalid transaction timeout"</span>, definition.getTimeout());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//--------------propagation_mandatory----------------------//</span></span><br><span class="line"><span class="comment">// No existing transaction found -&gt; check propagation behavior to find out how to proceed.</span></span><br><span class="line"><span class="keyword">if</span> (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_MANDATORY) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalTransactionStateException(</span><br><span class="line"><span class="string">"No existing transaction found for transaction marked with propagation 'mandatory'"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//----------------------propagation_required/propagation_requires_new/propagation_nested--------------------//</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRED ||</span><br><span class="line">definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRES_NEW ||</span><br><span class="line">definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NESTED) &#123;</span><br><span class="line"><span class="comment">// æŠŠå½“å‰äº‹åŠ¡æŒ‚èµ·å¹¶ä¿å­˜å½“å‰äº‹åŠ¡çš„äº‹åŠ¡å±æ€§</span></span><br><span class="line">SuspendedResourcesHolder suspendedResources = suspend(<span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">if</span> (debugEnabled) &#123;</span><br><span class="line">logger.debug(<span class="string">"Creating new transaction with name ["</span> + definition.getName() + <span class="string">"]: "</span> + definition);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">boolean</span> newSynchronization = (getTransactionSynchronization() != SYNCHRONIZATION_NEVER);</span><br><span class="line">DefaultTransactionStatus status = newTransactionStatus(</span><br><span class="line">definition, transaction, <span class="keyword">true</span>, newSynchronization, debugEnabled, suspendedResources);</span><br><span class="line"><span class="comment">// åˆå§‹åŒ–äº‹åŠ¡,é’©å­æ–¹æ³•</span></span><br><span class="line">doBegin(transaction, definition);</span><br><span class="line"><span class="comment">// åˆå§‹åŒ–äº‹åŠ¡åŒæ­¥</span></span><br><span class="line">prepareSynchronization(status, definition);</span><br><span class="line"><span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (RuntimeException | Error ex) &#123;</span><br><span class="line">resume(<span class="keyword">null</span>, suspendedResources);</span><br><span class="line"><span class="keyword">throw</span> ex;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// Create "empty" transaction: no actual transaction, but potentially synchronization.</span></span><br><span class="line"><span class="keyword">if</span> (definition.getIsolationLevel() != TransactionDefinition.ISOLATION_DEFAULT &amp;&amp; logger.isWarnEnabled()) &#123;</span><br><span class="line">logger.warn(<span class="string">"Custom isolation level specified but no actual transaction initiated; "</span> +</span><br><span class="line"><span class="string">"isolation level will effectively be ignored: "</span> + definition);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">boolean</span> newSynchronization = (getTransactionSynchronization() == SYNCHRONIZATION_ALWAYS);</span><br><span class="line"><span class="comment">// åˆ›å»ºæ–°äº‹åŠ¡,æ³¨æ„:transactionå‚æ•°ä¸ºnull,æ‰€ä»¥è¿™é‡Œåˆ›å»ºçš„ä¸æ˜¯ä¸€ä¸ªçœŸæ­£çš„äº‹åŠ¡</span></span><br><span class="line"><span class="keyword">return</span> prepareTransactionStatus(definition, <span class="keyword">null</span>, <span class="keyword">true</span>, newSynchronization, debugEnabled, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> SuspendedResourcesHolder <span class="title">suspend</span><span class="params">(@Nullable Object transaction)</span> <span class="keyword">throws</span> TransactionException </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (TransactionSynchronizationManager.isSynchronizationActive()) &#123;</span><br><span class="line">List&lt;TransactionSynchronization&gt; suspendedSynchronizations = doSuspendSynchronization();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">Object suspendedResources = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span> (transaction != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="comment">//æŒ‚èµ·äº‹åŠ¡,é’©å­æ–¹æ³•</span></span><br><span class="line">suspendedResources = doSuspend(transaction);</span><br><span class="line">&#125;</span><br><span class="line">String name = TransactionSynchronizationManager.getCurrentTransactionName();</span><br><span class="line">TransactionSynchronizationManager.setCurrentTransactionName(<span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">boolean</span> readOnly = TransactionSynchronizationManager.isCurrentTransactionReadOnly();</span><br><span class="line">TransactionSynchronizationManager.setCurrentTransactionReadOnly(<span class="keyword">false</span>);</span><br><span class="line">Integer isolationLevel = TransactionSynchronizationManager.getCurrentTransactionIsolationLevel();</span><br><span class="line">TransactionSynchronizationManager.setCurrentTransactionIsolationLevel(<span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">boolean</span> wasActive = TransactionSynchronizationManager.isActualTransactionActive();</span><br><span class="line">TransactionSynchronizationManager.setActualTransactionActive(<span class="keyword">false</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> SuspendedResourcesHolder(</span><br><span class="line">suspendedResources, suspendedSynchronizations, name, readOnly, isolationLevel, wasActive);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (RuntimeException | Error ex) &#123;</span><br><span class="line"><span class="comment">// doSuspend failed - original transaction is still active...</span></span><br><span class="line">doResumeSynchronization(suspendedSynchronizations);</span><br><span class="line"><span class="keyword">throw</span> ex;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (transaction != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="comment">// Transaction active but no synchronization active.</span></span><br><span class="line">Object suspendedResources = doSuspend(transaction);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> SuspendedResourcesHolder(suspendedResources);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// Neither transaction nor synchronization active.</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> List&lt;TransactionSynchronization&gt; <span class="title">doSuspendSynchronization</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 1.è·å–å½“å‰çº¿ç¨‹çš„æ‰€æœ‰äº‹åŠ¡åŒæ­¥å›è°ƒ</span></span><br><span class="line">List&lt;TransactionSynchronization&gt; suspendedSynchronizations =</span><br><span class="line">TransactionSynchronizationManager.getSynchronizations();</span><br><span class="line">  <span class="comment">// 2.å¾ªç¯å¹¶æŒ‚èµ·æ‰€æœ‰åŒæ­¥å›è°ƒæ¥å£</span></span><br><span class="line"><span class="keyword">for</span> (TransactionSynchronization synchronization : suspendedSynchronizations) &#123;</span><br><span class="line">synchronization.suspend();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 3.æ¸…é™¤èµ„æº</span></span><br><span class="line">TransactionSynchronizationManager.clearSynchronization();</span><br><span class="line"><span class="keyword">return</span> suspendedSynchronizations;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=" "></a> </h2><p>TransactionStatus</p><p><img src="/2020/08/13/2020081301/TransactionStatus.png" alt=""></p><h1 id="TransactionSynchronizationManageråŒæ­¥äº‹åŠ¡"><a href="#TransactionSynchronizationManageråŒæ­¥äº‹åŠ¡" class="headerlink" title="TransactionSynchronizationManageråŒæ­¥äº‹åŠ¡"></a>TransactionSynchronizationManageråŒæ­¥äº‹åŠ¡</h1><p>TransactionSynchronizationManagerä½¿ç”¨ThreadLocalæ¥ä¸ºä¸åŒçš„äº‹ç‰©çº¿ç¨‹æä¾›ç‹¬ç«‹çš„èµ„æºå‰¯æœ¬ï¼Œå¹¶ä¸”åŒæ—¶ç»´æŠ¤è¿™äº›äº‹ç‰©çš„é…ç½®å±æ€§å’Œè¿è¡ŒçŠ¶æ€ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// çº¿ç¨‹ä¸Šä¸‹æ–‡ä¸­ä¿å­˜ç€[çº¿ç¨‹æ± å¯¹è±¡ï¼šConnectHolder]çš„Mapå¯¹è±¡ã€‚çº¿ç¨‹å¯ä»¥é€šè¿‡è¯¥å±æ€§è·å–åˆ°åŒä¸€ä¸ªConnectionå¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Map&lt;Object, Object&gt;&gt; resources = <span class="keyword">new</span> NamedThreadLocal&lt;&gt;(<span class="string">"Transactional resources"</span>);</span><br><span class="line"><span class="comment">// äº‹åŠ¡åŒæ­¥å™¨ï¼Œè‡ªå®šä¹‰æ‰©å±•æ–¹æ³•ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½å¯ä»¥æ³¨å†ŒNä¸ªäº‹åŠ¡åŒæ­¥å™¨</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Set&lt;TransactionSynchronization&gt;&gt; synchronizations = <span class="keyword">new</span> NamedThreadLocal&lt;&gt;(<span class="string">"Transaction synchronizations"</span>);</span><br><span class="line"><span class="comment">// äº‹åŠ¡çš„åç§°</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;String&gt; currentTransactionName = <span class="keyword">new</span> NamedThreadLocal&lt;&gt;(<span class="string">"Current transaction name"</span>);</span><br><span class="line"><span class="comment">// äº‹åŠ¡æ˜¯å¦åªè¯»</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Boolean&gt; currentTransactionReadOnly = <span class="keyword">new</span> NamedThreadLocal&lt;&gt;(<span class="string">"Current transaction read-only status"</span>);</span><br><span class="line"><span class="comment">// äº‹åŠ¡çš„éš”ç¦»çº§åˆ«</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Integer&gt; currentTransactionIsolationLevel = <span class="keyword">new</span> NamedThreadLocal&lt;&gt;(<span class="string">"Current transaction isolation level"</span>);</span><br><span class="line"><span class="comment">// äº‹åŠ¡æ˜¯å¦å¼€å¯</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Boolean&gt; actualTransactionActive = <span class="keyword">new</span> NamedThreadLocal&lt;&gt;(<span class="string">"Actual transaction active"</span>);</span><br></pre></td></tr></table></figure><h2 id="äº‹ç‰©ä¿¡æ¯ç»‘å®š"><a href="#äº‹ç‰©ä¿¡æ¯ç»‘å®š" class="headerlink" title="äº‹ç‰©ä¿¡æ¯ç»‘å®š"></a>äº‹ç‰©ä¿¡æ¯ç»‘å®š</h2><p>åœ¨org.springframework.jdbc.datasource.DataSourceTransactionManager#doBeginä¸­ï¼ŒDataSourceTransactionObjectæ”¶åˆ¤æ–­æ˜¯å¦ä¸ºæ–°å»ºçš„ï¼Œè‹¥æ˜¯æ–°å¢çš„ï¼Œå°†å¯¹å…¶è¿›è¡Œç»‘å®šã€‚TransactionSynchronizationManager.bindResource(obtainDataSource(), txObject.getConnectionHolder());</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">bindResource</span><span class="params">(Object key, Object value)</span> <span class="keyword">throws</span> IllegalStateException </span>&#123;</span><br><span class="line">Object actualKey = TransactionSynchronizationUtils.unwrapResourceIfNecessary(key);</span><br><span class="line">Assert.notNull(value, <span class="string">"Value must not be null"</span>);</span><br><span class="line">Map&lt;Object, Object&gt; map = resources.get();</span><br><span class="line"><span class="comment">// set ThreadLocal Map if none found</span></span><br><span class="line"><span class="keyword">if</span> (map == <span class="keyword">null</span>) &#123;</span><br><span class="line">map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">resources.set(map);</span><br><span class="line">&#125;</span><br><span class="line">Object oldValue = map.put(actualKey, value);</span><br><span class="line"><span class="comment">// Transparently suppress a ResourceHolder that was marked as void...</span></span><br><span class="line"><span class="keyword">if</span> (oldValue <span class="keyword">instanceof</span> ResourceHolder &amp;&amp; ((ResourceHolder) oldValue).isVoid()) &#123;</span><br><span class="line">oldValue = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (oldValue != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Already value ["</span> + oldValue + <span class="string">"] for key ["</span> +</span><br><span class="line">actualKey + <span class="string">"] bound to thread ["</span> + Thread.currentThread().getName() + <span class="string">"]"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">logger.trace(<span class="string">"Bound value ["</span> + value + <span class="string">"] for key ["</span> + actualKey + <span class="string">"] to thread ["</span> +</span><br><span class="line">Thread.currentThread().getName() + <span class="string">"]"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="åˆå§‹åŒ–äº‹ç‰©åŒæ­¥å™¨"><a href="#åˆå§‹åŒ–äº‹ç‰©åŒæ­¥å™¨" class="headerlink" title="åˆå§‹åŒ–äº‹ç‰©åŒæ­¥å™¨"></a>åˆå§‹åŒ–äº‹ç‰©åŒæ­¥å™¨</h2><p>åœ¨TransactionInterceptorä¸­ï¼Œæ‰§è¡Œinvokeï¼Œå¯¹äº‹ç‰©æ–¹æ³•è¿›è¡Œæ‹¦æˆªå¤„ç†ã€‚ç”±çˆ¶ç±»org.springframework.transaction.interceptor.TransactionAspectSupport#invokeWithinTransactionå®é™…æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œè°ƒç”¨TransactionInfo txInfo = createTransactionIfNecessary(tm, txAttr, joinpointIdentification);åˆ›å»ºTransactionInfoæ—¶ï¼Œä¼šè°ƒç”¨AbstractPlatformTransactionManager#prepareSynchronizationæ–¹æ³•åˆå§‹åŒ–äº‹åŠ¡åŒæ­¥å™¨ã€‚</p><h3 id="åˆ›å»ºTransactionInfo"><a href="#åˆ›å»ºTransactionInfo" class="headerlink" title="åˆ›å»ºTransactionInfo"></a>åˆ›å»ºTransactionInfo</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> TransactionInfo <span class="title">createTransactionIfNecessary</span><span class="params">(@Nullable PlatformTransactionManager tm,</span></span></span><br><span class="line"><span class="function"><span class="params">@Nullable TransactionAttribute txAttr, <span class="keyword">final</span> String joinpointIdentification)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// If no name specified, apply method identification as transaction name.</span></span><br><span class="line"><span class="keyword">if</span> (txAttr != <span class="keyword">null</span> &amp;&amp; txAttr.getName() == <span class="keyword">null</span>) &#123;</span><br><span class="line">txAttr = <span class="keyword">new</span> DelegatingTransactionAttribute(txAttr) &#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> joinpointIdentification;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TransactionStatus status = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span> (txAttr != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (tm != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="comment">// è·å–TransactionStatus</span></span><br><span class="line">status = tm.getTransaction(txAttr);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">logger.debug(<span class="string">"Skipping transactional joinpoint ["</span> + joinpointIdentification +</span><br><span class="line"><span class="string">"] because no transaction manager has been configured"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// é€šè¿‡åˆ¶å®šçš„å±æ€§å’ŒçŠ¶æ€åˆ›å»ºTransactionInfo</span></span><br><span class="line"><span class="keyword">return</span> prepareTransactionInfo(tm, txAttr, joinpointIdentification, status);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡åˆ¶å®šçš„å±æ€§å’ŒçŠ¶æ€åˆ›å»ºTransactionInfo</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> TransactionInfo <span class="title">prepareTransactionInfo</span><span class="params">(@Nullable PlatformTransactionManager tm,</span></span></span><br><span class="line"><span class="function"><span class="params">@Nullable TransactionAttribute txAttr, String joinpointIdentification,</span></span></span><br><span class="line"><span class="function"><span class="params">@Nullable TransactionStatus status)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">TransactionInfo txInfo = <span class="keyword">new</span> TransactionInfo(tm, txAttr, joinpointIdentification);</span><br><span class="line"><span class="keyword">if</span> (txAttr != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="comment">// We need a transaction for this method...</span></span><br><span class="line"><span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">logger.trace(<span class="string">"Getting transaction for ["</span> + txInfo.getJoinpointIdentification() + <span class="string">"]"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// The transaction manager will flag an error if an incompatible tx already exists.</span></span><br><span class="line">txInfo.newTransactionStatus(status);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// The TransactionInfo.hasTransaction() method will return false. We created it only</span></span><br><span class="line"><span class="comment">// to preserve the integrity of the ThreadLocal stack maintained in this class.</span></span><br><span class="line"><span class="keyword">if</span> (logger.isTraceEnabled())</span><br><span class="line">logger.trace(<span class="string">"Don't need to create transaction for ["</span> + joinpointIdentification +</span><br><span class="line"><span class="string">"]: This method isn't transactional."</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// We always bind the TransactionInfo to the thread, even if we didn't create</span></span><br><span class="line"><span class="comment">// a new transaction here. This guarantees that the TransactionInfo stack</span></span><br><span class="line"><span class="comment">// will be managed correctly even if no transaction was created by this aspect.</span></span><br><span class="line"><span class="comment">// ç»‘å®šTransactionInfo </span></span><br><span class="line">txInfo.bindToThread();</span><br><span class="line"><span class="keyword">return</span> txInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="åˆå§‹åŒ–äº‹ç‰©åŒæ­¥å™¨-1"><a href="#åˆå§‹åŒ–äº‹ç‰©åŒæ­¥å™¨-1" class="headerlink" title="åˆå§‹åŒ–äº‹ç‰©åŒæ­¥å™¨"></a>åˆå§‹åŒ–äº‹ç‰©åŒæ­¥å™¨</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Initialize transaction synchronization as appropriate.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">prepareSynchronization</span><span class="params">(DefaultTransactionStatus status, TransactionDefinition definition)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (status.isNewSynchronization()) &#123;</span><br><span class="line">TransactionSynchronizationManager.setActualTransactionActive(status.hasTransaction());</span><br><span class="line">TransactionSynchronizationManager.setCurrentTransactionIsolationLevel(</span><br><span class="line">definition.getIsolationLevel() != TransactionDefinition.ISOLATION_DEFAULT ?</span><br><span class="line">definition.getIsolationLevel() : <span class="keyword">null</span>);</span><br><span class="line">TransactionSynchronizationManager.setCurrentTransactionReadOnly(definition.isReadOnly());</span><br><span class="line">TransactionSynchronizationManager.setCurrentTransactionName(definition.getName());</span><br><span class="line">TransactionSynchronizationManager.initSynchronization();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="TransactionSynchronization"><a href="#TransactionSynchronization" class="headerlink" title="TransactionSynchronization"></a>TransactionSynchronization</h2><p><img src="/2020/08/13/2020081301/TransactionSynchronizationAdapter.png" alt="äº‹ç‰©åŒæ­¥ç±»ç»“æ„"></p><p>äº‹ç‰©åŒæ­¥çš„æ‰©å±•ç‚¹ï¼Œç”¨äºäº‹ç‰©åŒæ­¥å›è°ƒçš„æ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionSynchronizationAdapter</span> <span class="keyword">implements</span> <span class="title">TransactionSynchronization</span>, <span class="title">Ordered</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> Ordered.LOWEST_PRECEDENCE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// äº‹åŠ¡æŒ‚èµ·</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">suspend</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//äº‹åŠ¡æ¢å¤</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">resume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å°†åŸºç¡€ä¼šè¯åˆ·æ–°åˆ°æ•°æ®å­˜å‚¨åŒºï¼ˆå¦‚æœé€‚ç”¨ï¼‰</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">flush</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨äº‹åŠ¡æäº¤å‰è§¦å‘ï¼Œæ­¤å¤„è‹¥å‘ç”Ÿå¼‚å¸¸ï¼Œä¼šå¯¼è‡´å›æ»š</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeCommit</span><span class="params">(<span class="keyword">boolean</span> readOnly)</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åœ¨beforeCommitä¹‹åï¼Œcommit/rollbackä¹‹å‰æ‰§è¡Œã€‚å³ä½¿å¼‚å¸¸ï¼Œä¹Ÿä¸ä¼šå›æ»š</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeCompletion</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// äº‹åŠ¡æäº¤åæ‰§è¡Œ</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterCommit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// äº‹åŠ¡æäº¤/å›æ»šæ‰§è¡Œ</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(<span class="keyword">int</span> status)</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;Springæä¾›äº†ä¸¤ç§ç¼–ç¨‹å¼äº‹ç‰©ç®¡ç†çš„æ–¹æ³•ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;p&gt;ä½¿ç”¨TransactionTemplateæˆ–è€…TransactionalOperator. &lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;ç›´æ¥å®ç°TransactionManageræ¥å£.  &lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;å¦‚æœæ˜¯ä½¿ç”¨å‘½ä»¤å¼ç¼–ç¨‹ï¼ŒSpringæ¨èä½¿ç”¨TransactionTemplateæ¥å®Œæˆç¼–ç¨‹å¼äº‹åŠ¡ç®¡ç†ï¼Œå¦‚æœæ˜¯å“åº”å¼ç¼–ç¨‹ï¼Œé‚£ä¹ˆä½¿ç”¨TransactionalOperatoræ›´åŠ åˆé€‚&lt;/p&gt;&lt;/blockquote&gt;
    
    </summary>
    
      <category term="Spring" scheme="http://yoursite.com/categories/Spring/"/>
    
    
      <category term="äº‹åŠ¡" scheme="http://yoursite.com/tags/%E4%BA%8B%E5%8A%A1/"/>
    
  </entry>
  
  <entry>
    <title>Dubboçš„è´Ÿè½½å‡è¡¡ç®—æ³•å­¦ä¹ </title>
    <link href="http://yoursite.com/2020/06/06/20004/"/>
    <id>http://yoursite.com/2020/06/06/20004/</id>
    <published>2020-06-06T06:45:54.000Z</published>
    <updated>2020-06-10T13:19:14.456Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>Dubboçš„Cluterä¼šé€‰æ‹©æœ€åˆé€‚çš„æœåŠ¡ï¼Œä¾›è°ƒç”¨è€…ä½¿ç”¨ã€‚å¦‚ä½•é€‰å–ï¼Ÿ  </p><ol><li>ConsistentHashï¼ŒKetamaä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ã€‚</li><li>Rondomï¼Œéšæœºè·å–ã€‚</li><li>Roundbinï¼Œè½®è¯¢é€‰æ‹©ã€‚</li><li>leastActiveï¼Œé€‰æ‹©æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„èŠ‚ç‚¹ã€‚ <a id="more"></a>  </li></ol></blockquote><h2 id="AbastractLoadBlance"><a href="#AbastractLoadBlance" class="headerlink" title="AbastractLoadBlance"></a>AbastractLoadBlance</h2><p>Dubboå„ä¸ªæ¨¡å—éƒ½æ˜¯é€šè¿‡æ¨¡ç‰ˆæ¨¡å¼è¿›è¡Œçµæ´»é€‚é…ï¼Œè·¯ç”±æ¨¡å—ä¹Ÿä¸ä¾‹å¤–ã€‚</p><p>AbastractLoadBlanceå®ç°LoadBalanceæ¥å£ï¼Œè¿›è¡ŒåŸºç¡€å¤„ç†ï¼Œå¦‚ï¼šæƒé‡è·å–ã€åªæœ‰ä¸€ä¸ªInvokeræ—¶ï¼Œç›´æ¥è¿”å›ã€‚</p><h3 id="æ¨¡ç‰ˆå¤„ç†"><a href="#æ¨¡ç‰ˆå¤„ç†" class="headerlink" title="æ¨¡ç‰ˆå¤„ç†"></a>æ¨¡ç‰ˆå¤„ç†</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">Invoker&lt;T&gt; <span class="title">select</span><span class="params">(List&lt;Invoker&lt;T&gt;&gt; invokers, URL url, Invocation invocation)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (CollectionUtils.isEmpty(invokers)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">// åªå­˜åœ¨ä¸€ä¸ªæœåŠ¡èŠ‚ç‚¹ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (invokers.size() == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> invokers.get(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> doSelect(invokers, url, invocation);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ¨¡æ¿æ–¹æ³•</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">abstract</span> &lt;T&gt; <span class="function">Invoker&lt;T&gt; <span class="title">doSelect</span><span class="params">(List&lt;Invoker&lt;T&gt;&gt; invokers, URL url, Invocation invocation)</span></span>;</span><br></pre></td></tr></table></figure><p>å½“æœ‰å¤šä¸ªæœåŠ¡èŠ‚ç‚¹æ—¶ï¼Œå°±éœ€è¦åŒè¿‡é€‰æ‹©çš„è·¯ç”±ç®—æ³•è·å–å‡ºåˆé€‚çš„èŠ‚ç‚¹ã€‚doSelectæ¨¡ç‰ˆæ–¹æ³•çš„ç”±å¯¹åº”çš„è·¯ç”±ç®—æ³•å®ç°è‡ªå·±çš„ç‰¹ä¿—åŒ–å¤„ç†ã€‚</p><p><img src="/2020/06/06/20004/AbstractLoadBalance.png" alt="è·¯ç”±ç±»ç»“æ„å…³ç³»å›¾"></p><h3 id="æƒé‡è·å–"><a href="#æƒé‡è·å–" class="headerlink" title="æƒé‡è·å–"></a>æƒé‡è·å–</h3><p>æƒé‡çš„è·å–è‡³å…³é‡è¦ï¼ŒConsisten Hashã€Roundbinã€Rondomã€LeastActiveéƒ½éœ€è¦è·å–æƒé‡å‚ä¸è®¡ç®—ã€‚  </p><ul><li><p>è·å–å¯¹æ¯ä¸ªæœåŠ¡è‡ªå®šä»¥çš„æƒé‡ã€‚å¦‚æœæ²¡æœ‰é…ç½®ï¼Œä½¿ç”¨é»˜è®¤é…ç½®ã€‚</p></li><li><p>è·å–é¢„çƒ­æ—¶é—´ï¼ˆnowTime-startTimeï¼‰ã€æ€»é¢„çƒ­æ—¶é—´ã€‚</p></li><li><p>è®¡ç®—æƒé‡ã€‚</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–æƒé‡</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getWeight</span><span class="params">(Invoker&lt;?&gt; invoker, Invocation invocation)</span> </span>&#123;</span><br><span class="line"><span class="comment">// é€šè¿‡URLè·å–å½“å‰Invokerè®¾ç½®çš„æƒé‡</span></span><br><span class="line">    <span class="keyword">int</span> weight = invoker.getUrl().getMethodParameter(invocation.getMethodName(), WEIGHT_KEY, DEFAULT_WEIGHT);</span><br><span class="line">    <span class="keyword">if</span> (weight &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="comment">// è·å–å¯åŠ¨çš„æ—¶é—´èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">long</span> timestamp = invoker.getUrl().getParameter(TIMESTAMP_KEY, <span class="number">0L</span>);</span><br><span class="line">        <span class="keyword">if</span> (timestamp &gt; <span class="number">0L</span>) &#123;</span><br><span class="line"><span class="comment">// æ±‚å·®å€¼ï¼Œå¾—åˆ°å·²ç»é¢„çƒ­æ—¶é—´</span></span><br><span class="line">            <span class="keyword">long</span> uptime = System.currentTimeMillis() - timestamp;</span><br><span class="line">            <span class="keyword">if</span> (uptime &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line"><span class="comment">// è·å–è®¾ç½®çš„æ€»é¢„çƒ­æ—¶é—´</span></span><br><span class="line">            <span class="keyword">int</span> warmup = invoker.getUrl().getParameter(WARMUP_KEY, DEFAULT_WARMUP);</span><br><span class="line">            <span class="keyword">if</span> (uptime &gt; <span class="number">0</span> &amp;&amp; uptime &lt; warmup) &#123;</span><br><span class="line"><span class="comment">// è®¡ç®—å‡ºæœ€åçš„æƒé‡</span></span><br><span class="line">                weight = calculateWarmupWeight((<span class="keyword">int</span>)uptime, warmup, weight);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Math.max(weight, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æƒé‡è®¡ç®—ï¼šï¼ˆå¯åŠ¨è‡³ä»Šçš„æ—¶é—´/  ç»™äºˆçš„é¢„çƒ­æ€»æ—¶é—´ï¼‰* æƒé‡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">calculateWarmupWeight</span><span class="params">(<span class="keyword">int</span> uptime, <span class="keyword">int</span> warmup, <span class="keyword">int</span> weight)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ww = (<span class="keyword">int</span>) ( uptime / ((<span class="keyword">float</span>) warmup / weight));</span><br><span class="line">    <span class="keyword">return</span> ww &lt; <span class="number">1</span> ? <span class="number">1</span> : (Math.min(ww, weight));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Consistent-Hash"><a href="#Consistent-Hash" class="headerlink" title="Consistent Hash"></a>Consistent Hash</h2><p>Consistent Hashè´Ÿè½½å‡è¡¡å¯ä»¥è®©å‚æ•°ç›¸åŒçš„è¯·æ±‚æ¯æ¬¡è·¯ç”±åˆ°ç›¸åŒçš„æœºå™¨ä¸Šã€‚</p><p>Ketamaç®—æ³•ä¼šä¸ºæ¯ä¸ªçœŸå®èŠ‚ç‚¹åœ¨åˆ›å»ºå¤šä¸ªè™šæ‹ŸèŠ‚ç‚¹ï¼Œè®©èŠ‚ç‚¹åœ¨ç¯å½¢ä¸Šçš„åˆ†å¸ƒæ›´åŠ å‡åŒ€ï¼Œåç»­çš„è°ƒç”¨ä¹Ÿä¼šéšä¹‹æ›´åŠ å‡åŒ€ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">ConsistentHashSelector(List&lt;Invoker&lt;T&gt;&gt; invokers, String methodName, <span class="keyword">int</span> identityHashCode) &#123;</span><br><span class="line">    <span class="keyword">this</span>.virtualInvokers = <span class="keyword">new</span> TreeMap&lt;Long, Invoker&lt;T&gt;&gt;();</span><br><span class="line">    <span class="keyword">this</span>.identityHashCode = identityHashCode;</span><br><span class="line">    URL url = invokers.get(<span class="number">0</span>).getUrl();</span><br><span class="line">    <span class="keyword">this</span>.replicaNumber = url.getMethodParameter(methodName, HASH_NODES, <span class="number">160</span>);</span><br><span class="line">    String[] index = COMMA_SPLIT_PATTERN.split(url.getMethodParameter(methodName, HASH_ARGUMENTS, <span class="string">"0"</span>));</span><br><span class="line">    argumentIndex = <span class="keyword">new</span> <span class="keyword">int</span>[index.length];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; index.length; i++) &#123;</span><br><span class="line">        argumentIndex[i] = Integer.parseInt(index[i]);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// éå†æ‰€æœ‰çš„èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">for</span> (Invoker&lt;T&gt; invoker : invokers) &#123;</span><br><span class="line"><span class="comment">// è·å¾—æ¯ä¸ªèŠ‚ç‚¹çš„IP</span></span><br><span class="line">        String address = invoker.getUrl().getAddress();</span><br><span class="line"><span class="comment">// replicaNumberæ˜¯ç”Ÿæˆçš„è™šæ‹ŸèŠ‚ç‚¹æ•°ï¼Œé»˜è®¤ä¸º160ä¸ª</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; replicaNumber / <span class="number">4</span>; i++) &#123;</span><br><span class="line"><span class="comment">// ä»¥IP+é€’å¢æ•°å­—åšMD5ï¼Œä»¥æ­¤ä½œä¸ºèŠ‚ç‚¹æ ‡è¯†</span></span><br><span class="line">            <span class="keyword">byte</span>[] digest = md5(address + i);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> h = <span class="number">0</span>; h &lt; <span class="number">4</span>; h++) &#123;</span><br><span class="line">                <span class="keyword">long</span> m = hash(digest, h);</span><br><span class="line"><span class="comment">// å¯¹æ ‡è¯†åšâ€œHashâ€å¾—åˆ°TreeMapçš„Keyï¼Œä»¥Invokerä¸ºvalue</span></span><br><span class="line">                virtualInvokers.put(m, invoker);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Round-Robin"><a href="#Round-Robin" class="headerlink" title="Round Robin"></a>Round Robin</h2><p>æƒé‡è½®è¯¢è´Ÿè½½å‡è¡¡ä¼šæ ¹æ®è®¾ç½®çš„æƒé‡æ¥åˆ¤æ–­è½®è¯¢çš„æ¯”ä¾‹ã€‚</p><p>æ™®é€šè½®è®­è´Ÿè½½å‡è¡¡å¥½å¤„æ˜¯æ¯ä¸ªèŠ‚ç‚¹è·å¾—çš„è¯·æ±‚ä¼šå¾ˆå‡åŒ€ï¼Œå¦‚æœæŸäº›èŠ‚ç‚¹çš„è´Ÿè½½èƒ½åŠ›å¾ˆå¼±ï¼Œåˆ™è¿™ä¸ªèŠ‚ç‚¹ä¼šå †ç§¯è¾ƒå¤šçš„è¯·æ±‚ã€‚æ‰€ä»¥éœ€è¦æ ¹æ®èŠ‚ç‚¹æƒé‡è¿›è¡Œå¹²é¢„ã€‚</p><p>æƒé‡è½®è®­</p><p>æ™®é€šæƒé‡è½®è®­ï¼šä¼šé€ æˆæŸä¸ªèŠ‚ç‚¹çªç„¶è¢«é¢‘ç¹é€‰ä¸­ï¼Œæ˜“é€ æˆæŸä¸ªèŠ‚ç‚¹æµé‡æš´å¢ã€‚</p><p>å¹³æ»‘æƒé‡è½®è®­ï¼šåœ¨è½®è®­æ—¶ç©¿æ’è®­è´£å…¶ä»–èŠ‚ç‚¹ï¼Œè®©æ•´ä¸ªæœåŠ¡å™¨é€‰æ‹©çš„è¿‡ç¨‹æ¯”è¾ƒå‡åŒ€ã€‚</p><p>Dubboçš„RoundRobinè´Ÿè½½å‡è¡¡ç®—æ³•é‡‡ç”¨çš„å°±æ˜¯å¹³æ»‘æƒé‡è½®è®­ç®—æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> &lt;T&gt; <span class="function">Invoker&lt;T&gt; <span class="title">doSelect</span><span class="params">(List&lt;Invoker&lt;T&gt;&gt; invokers, URL url, Invocation invocation)</span> </span>&#123;</span><br><span class="line"><span class="comment">// ç”Ÿæˆkey</span></span><br><span class="line">    String key = invokers.get(<span class="number">0</span>).getUrl().getServiceKey() + <span class="string">"."</span> + invocation.getMethodName();</span><br><span class="line"><span class="comment">// æŸ¥çœ‹ç¼“å­˜ä¸­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    ConcurrentMap&lt;String, WeightedRoundRobin&gt; map = methodWeightMap.get(key);</span><br><span class="line">    <span class="keyword">if</span> (map == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="comment">// ä¸å­˜åœ¨ï¼Œé‡æ–°ç”ŸæˆWeightedRoundRobin</span></span><br><span class="line">        methodWeightMap.putIfAbsent(key, <span class="keyword">new</span> ConcurrentHashMap&lt;String, WeightedRoundRobin&gt;());</span><br><span class="line">        map = methodWeightMap.get(key);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// æƒé‡æ€»å’Œ</span></span><br><span class="line">    <span class="keyword">int</span> totalWeight = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// æœ€å¤§çš„Currentï¼Œé»˜è®¤ä¸ºæœ€å°å€¼</span></span><br><span class="line">    <span class="keyword">long</span> maxCurrent = Long.MIN_VALUE;</span><br><span class="line">    <span class="keyword">long</span> now = System.currentTimeMillis();</span><br><span class="line">    Invoker&lt;T&gt; selectedInvoker = <span class="keyword">null</span>;</span><br><span class="line">    WeightedRoundRobin selectedWRR = <span class="keyword">null</span>;</span><br><span class="line"><span class="comment">// éå†æœåŠ¡æä¾›è€…ï¼Œè·å–æƒé‡</span></span><br><span class="line">    <span class="keyword">for</span> (Invoker&lt;T&gt; invoker : invokers) &#123;</span><br><span class="line">        String identifyString = invoker.getUrl().toIdentityString();</span><br><span class="line">        WeightedRoundRobin weightedRoundRobin = map.get(identifyString);</span><br><span class="line"><span class="comment">/**************************************************************/</span></span><br><span class="line"><span class="comment">/**************************************************************/</span></span><br><span class="line"><span class="comment">/********å°†æ‰€æœ‰çš„Invokerçš„æƒé‡å°è£…æˆWeightedRoundRobinå¯¹è±¡**********/</span></span><br><span class="line"><span class="comment">/**************************************************************/</span></span><br><span class="line"><span class="comment">/**************************************************************/</span></span><br><span class="line"><span class="comment">// è·å–é¢„çƒ­æƒé‡</span></span><br><span class="line">        <span class="keyword">int</span> weight = getWeight(invoker, invocation);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (weightedRoundRobin == <span class="keyword">null</span>) &#123;</span><br><span class="line">            weightedRoundRobin = <span class="keyword">new</span> WeightedRoundRobin();</span><br><span class="line">            weightedRoundRobin.setWeight(weight);</span><br><span class="line">            map.putIfAbsent(identifyString, weightedRoundRobin);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">// å¦‚æœé¢„çƒ­æƒé‡å’Œå’Œinvokerè®¾ç½®çš„æƒé‡ä¸ç›¸ç­‰ï¼Œè¯´æ˜è¿˜åœ¨é¢„çƒ­é˜¶æ®µï¼Œæ­¤æ—¶ä»¥é¢„çƒ­æƒé‡ä¸ºå‡†ã€‚</span></span><br><span class="line">        <span class="keyword">if</span> (weight != weightedRoundRobin.getWeight()) &#123;</span><br><span class="line">            <span class="comment">//weight changed</span></span><br><span class="line">            weightedRoundRobin.setWeight(weight);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">// å¹³æ»‘è½®è¯¢</span></span><br><span class="line"><span class="comment">// æ¯ä¸ªinvokerä¼šæŠŠæƒé‡åŠ åˆ°è‡ªå·±çš„currentå±æ€§ä¸Šï¼Œå¹¶æ›´æ–°å½“å‰invoekrçš„lastUpdateå±æ€§ã€‚</span></span><br><span class="line"><span class="comment">// current = current + weight;</span></span><br><span class="line">        <span class="keyword">long</span> cur = weightedRoundRobin.increaseCurrent();</span><br><span class="line"><span class="comment">// è®¾ç½®æœ€åä¸€æ¬¡æ›´æ–°æ—¶é—´</span></span><br><span class="line">        weightedRoundRobin.setLastUpdate(now);</span><br><span class="line"><span class="comment">// é€‰å–currentæœ€å¤§çš„èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> (cur &gt; maxCurrent) &#123;</span><br><span class="line">            maxCurrent = cur;</span><br><span class="line">            selectedInvoker = invoker;</span><br><span class="line">            selectedWRR = weightedRoundRobin;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">// ç´¯åŠ æ¯ä¸ªInvokerçš„æƒé‡</span></span><br><span class="line">        totalWeight += weight;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// æ ¹æ®æƒé‡æ›´æ–°ç¼“å­˜</span></span><br><span class="line"><span class="comment">// ç”±äºæ‰€æœ‰çš„Invokeréƒ½ä¼šå°è£…æˆä¸ºweightedRoundRobinå¯¹è±¡ï¼Œ</span></span><br><span class="line">    <span class="comment">// å› ä¸ºå¯ä»¥è°ƒç”¨çš„invokeræ•°é‡å’Œç¼“å­˜weightedRoundRobinå¯¹è±¡çš„Mapå¤§å°ä¸ç›¸ç­‰ï¼Œåˆ™è¯´æ˜ç¼“å­˜ä¸­æœ‰æ— ç”¨çš„æ•°æ®ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (!updateLock.get() &amp;&amp; invokers.size() != map.size()) &#123;</span><br><span class="line"><span class="comment">// åˆ©ç”¨CASæŠ¢å é”</span></span><br><span class="line">        <span class="keyword">if</span> (updateLock.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// copy -&gt; modify -&gt; update reference</span></span><br><span class="line">                ConcurrentMap&lt;String, WeightedRoundRobin&gt; newMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(map);</span><br><span class="line">                <span class="comment">// æ ¹æ®lastUpdateæ›´æ–°è¿‡æœŸæ•°æ®</span></span><br><span class="line">newMap.entrySet().removeIf(item -&gt; now - item.getValue().getLastUpdate() &gt; RECYCLE_PERIOD);</span><br><span class="line">                <span class="comment">// ä¿®æ”¹æŒ‡é’ˆå¼•ç”¨</span></span><br><span class="line">methodWeightMap.put(key, newMap);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                updateLock.set(<span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// è¿”å›Invokerã€‚å°†å½“å‰Invokerçš„currentå‡å»æ€»æƒé‡ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (selectedInvoker != <span class="keyword">null</span>) &#123;</span><br><span class="line">        selectedWRR.sel(totalWeight);</span><br><span class="line">        <span class="keyword">return</span> selectedInvoker;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// should not happen here</span></span><br><span class="line">    <span class="keyword">return</span> invokers.get(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="WeightedRoundRobin"><a href="#WeightedRoundRobin" class="headerlink" title="WeightedRoundRobin"></a>WeightedRoundRobin</h3><p>æƒé‡çš„è®¡ç®—ä¸åŸå­ä¿å­˜</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">WeightedRoundRobin</span> </span>&#123;</span><br><span class="line"><span class="comment">// invokerè®¾å®šçš„æƒé‡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> weight;</span><br><span class="line"><span class="comment">// è€ƒè™‘åˆ°å¹¶å‘åœºæ™¯ä¸‹æŸä¸ªInvokerä¼šè¢«åŒæ—¶é€‰ä¸­ï¼Œè¡¨ç¤ºè¯¥èŠ‚ç‚¹è¢«æ‰€æœ‰çº¿ç¨‹é€‰ä¸­çš„æƒé‡æ€»å’Œ</span></span><br><span class="line">    <span class="keyword">private</span> AtomicLong current = <span class="keyword">new</span> AtomicLong(<span class="number">0</span>);</span><br><span class="line"><span class="comment">// æœ€åä¸€æ¬¡æ›´æ–°æ—¶é—´ï¼Œç”¨äºåç»­ç¼“å­˜è¶…æ—¶çš„åˆ¤æ–­</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> lastUpdate;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getWeight</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> weight;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setWeight</span><span class="params">(<span class="keyword">int</span> weight)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.weight = weight;</span><br><span class="line">        current.set(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">increaseCurrent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> current.addAndGet(weight);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sel</span><span class="params">(<span class="keyword">int</span> total)</span> </span>&#123;</span><br><span class="line">        current.addAndGet(-<span class="number">1</span> * total);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getLastUpdate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> lastUpdate;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLastUpdate</span><span class="params">(<span class="keyword">long</span> lastUpdate)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.lastUpdate = lastUpdate;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Random"><a href="#Random" class="headerlink" title="Random"></a>Random</h2><p>Randomè´Ÿè½½å‡è¡¡æ˜¯æŒ‰ç…§æƒé‡è®¾ç½®éšæœºæ¦‚ç‡åšè´Ÿè½½å‡è¡¡ã€‚ </p><ul><li><p>æ±‚å‡ºinvokersæƒé‡æ€»å’Œã€‚</p></li><li><p>æ ¹æ®æ€»æƒé‡è®¡ç®—å‡ºä¸€ä¸ªéšæœºçš„åç§»é‡ã€‚</p></li><li><p>åç§»é‡è½®å¾ªé”®æ¯ä¸ªinvokerçš„æƒé‡ï¼Œå¦‚æœåç§»é‡å°äº0ï¼Œå°±é€‰ä¸­å½“å‰Invoekerã€‚</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> &lt;T&gt; <span class="function">Invoker&lt;T&gt; <span class="title">doSelect</span><span class="params">(List&lt;Invoker&lt;T&gt;&gt; invokers, URL url, Invocation invocation)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Number of invokers</span></span><br><span class="line">    <span class="keyword">int</span> length = invokers.size();</span><br><span class="line">    <span class="comment">// Every invoker has the same weight?</span></span><br><span class="line"><span class="comment">// æ‰€æœ‰invokeræ‹¥æœ‰ç›¸åŒçš„æƒé‡</span></span><br><span class="line">    <span class="keyword">boolean</span> sameWeight = <span class="keyword">true</span>;</span><br><span class="line">    <span class="comment">// the weight of every invokers</span></span><br><span class="line"><span class="comment">// ç”Ÿå‘½ä¸€ä¸ªæƒé‡æ•°ç»„ï¼Œç”¨äºå­˜æ”¾æ‰€æœ‰invokerçš„æƒé‡</span></span><br><span class="line">    <span class="keyword">int</span>[] weights = <span class="keyword">new</span> <span class="keyword">int</span>[length];</span><br><span class="line">    <span class="comment">// the first invoker's weight</span></span><br><span class="line"><span class="comment">// è·å–ç¬¬ä¸€ä¸ªInvokerçš„æƒé‡</span></span><br><span class="line">    <span class="keyword">int</span> firstWeight = getWeight(invokers.get(<span class="number">0</span>), invocation);</span><br><span class="line">    weights[<span class="number">0</span>] = firstWeight;</span><br><span class="line">    <span class="comment">// The sum of weights</span></span><br><span class="line"><span class="comment">// invokersæƒé‡æ€»å’Œ</span></span><br><span class="line">    <span class="keyword">int</span> totalWeight = firstWeight;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; length; i++) &#123;</span><br><span class="line"><span class="comment">// è·å–æƒé‡</span></span><br><span class="line">        <span class="keyword">int</span> weight = getWeight(invokers.get(i), invocation);</span><br><span class="line">        <span class="comment">// save for later use</span></span><br><span class="line">        weights[i] = weight;</span><br><span class="line">        <span class="comment">// Sum</span></span><br><span class="line"><span class="comment">// invokersæƒé‡è¿›è¡ŒåŠ å’Œ</span></span><br><span class="line">        totalWeight += weight;</span><br><span class="line"><span class="comment">// åˆ¤æ–­invokersæ˜¯å¦æ‹¥æœ‰ç›¸åŒçš„æƒé‡</span></span><br><span class="line">        <span class="keyword">if</span> (sameWeight &amp;&amp; weight != firstWeight) &#123;</span><br><span class="line">            sameWeight = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// æ‰€æœ‰çš„invoekræƒé‡ä¸åŒ</span></span><br><span class="line">    <span class="keyword">if</span> (totalWeight &gt; <span class="number">0</span> &amp;&amp; !sameWeight) &#123;</span><br><span class="line">        <span class="comment">// If (not every invoker has the same weight &amp; at least one invoker's weight&gt;0), select randomly based on totalWeight.</span></span><br><span class="line">        <span class="comment">// æ ¹æ®æ€»æƒé‡è®¡ç®—å‡ºä¸€ä¸ªéšæœºçš„åç§»é‡ï¼Œæ­¤å¤„ä½¿ç”¨äº†ThreadLocalRandomæ€§èƒ½ä¼šæ›´å¥½</span></span><br><span class="line"><span class="keyword">int</span> offset = ThreadLocalRandom.current().nextInt(totalWeight);</span><br><span class="line">        <span class="comment">// Return a invoker based on the random value.</span></span><br><span class="line"><span class="comment">// éå†æ‰€æœ‰çš„Invokerï¼Œè½®è¯¢å‡å»æƒé‡ã€‚å¾—åˆ°è¢«é€‰ä¸­çš„Invoker</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">            offset -= weights[i];</span><br><span class="line">            <span class="keyword">if</span> (offset &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> invokers.get(i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// If all invokers have the same weight value or totalWeight=0, return evenly.</span></span><br><span class="line"><span class="comment">// å¦‚æœæ‰€æœ‰çš„æƒé‡ç›¸åŒï¼Œéšæœºè·å–ä¸€ä¸ªInvoker</span></span><br><span class="line">    <span class="keyword">return</span> invokers.get(ThreadLocalRandom.current().nextInt(length));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Least-Active"><a href="#Least-Active" class="headerlink" title="Least Active"></a>Least Active</h2><p>Least Activeè´Ÿè½½å‡è¡¡ç§°ä¸ºæœ€å°‘æ´»åŠ¨è°ƒç”¨æ•°è´Ÿè½½å‡è¡¡ï¼Œæ¡†æ¶ä¼šè®°ä¸‹æ¯ä¸ªInvokerçš„æ´»è·ƒæ•°ï¼Œæ¯æ¬¡åªå–æ´»è·ƒæ•°æœ€å°‘çš„Invokerã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> &lt;T&gt; <span class="function">Invoker&lt;T&gt; <span class="title">doSelect</span><span class="params">(List&lt;Invoker&lt;T&gt;&gt; invokers, URL url, Invocation invocation)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Number of invokers</span></span><br><span class="line">    <span class="keyword">int</span> length = invokers.size();</span><br><span class="line">    <span class="comment">// The least active value of all invokers</span></span><br><span class="line">    <span class="keyword">int</span> leastActive = -<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// The number of invokers having the same least active value (leastActive)</span></span><br><span class="line">    <span class="keyword">int</span> leastCount = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// The index of invokers having the same least active value (leastActive)</span></span><br><span class="line">    <span class="keyword">int</span>[] leastIndexes = <span class="keyword">new</span> <span class="keyword">int</span>[length];</span><br><span class="line">    <span class="comment">// the weight of every invokers</span></span><br><span class="line">    <span class="keyword">int</span>[] weights = <span class="keyword">new</span> <span class="keyword">int</span>[length];</span><br><span class="line">    <span class="comment">// The sum of the warmup weights of all the least active invokers</span></span><br><span class="line">    <span class="keyword">int</span> totalWeight = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// The weight of the first least active invoker</span></span><br><span class="line">    <span class="keyword">int</span> firstWeight = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// Every least active invoker has the same weight value?</span></span><br><span class="line">    <span class="keyword">boolean</span> sameWeight = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Filter out all the least active invokers</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">        Invoker&lt;T&gt; invoker = invokers.get(i);</span><br><span class="line"><span class="comment">// è·å¾—invokerçš„æ´»è·ƒæ•°å’Œé¢„çƒ­æƒé‡</span></span><br><span class="line">        <span class="comment">// Get the active number of the invoker</span></span><br><span class="line">        <span class="keyword">int</span> active = RpcStatus.getStatus(invoker.getUrl(), invocation.getMethodName()).getActive();</span><br><span class="line">        <span class="comment">// Get the weight of the invoker's configuration. The default value is 100.</span></span><br><span class="line">        <span class="keyword">int</span> afterWarmup = getWeight(invoker, invocation);</span><br><span class="line">        <span class="comment">// save for later use</span></span><br><span class="line">        weights[i] = afterWarmup;</span><br><span class="line">        <span class="comment">// ç¬¬ä¸€æ¬¡æ‰§è¡Œæˆ–è€…å‘ç°æ›´å°çš„æ´»è·ƒæ•°</span></span><br><span class="line"><span class="keyword">if</span> (leastActive == -<span class="number">1</span> || active &lt; leastActive) &#123;</span><br><span class="line"><span class="comment">// ç½®ç©ºä¹‹å‰çš„è®¡æ•°</span></span><br><span class="line">            <span class="comment">// Reset the active number of the current invoker to the least active number</span></span><br><span class="line">            leastActive = active;</span><br><span class="line">            <span class="comment">// Reset the number of least active invokers</span></span><br><span class="line">            leastCount = <span class="number">1</span>;</span><br><span class="line">            <span class="comment">// Put the first least active invoker first in leastIndexes</span></span><br><span class="line">            leastIndexes[<span class="number">0</span>] = i;</span><br><span class="line">            <span class="comment">// Reset totalWeight</span></span><br><span class="line">            totalWeight = afterWarmup;</span><br><span class="line">            <span class="comment">// Record the weight the first least active invoker</span></span><br><span class="line">            firstWeight = afterWarmup;</span><br><span class="line">            <span class="comment">// Each invoke has the same weight (only one invoker here)</span></span><br><span class="line">            sameWeight = <span class="keyword">true</span>;</span><br><span class="line">            <span class="comment">// If current invoker's active value equals with leaseActive, then accumulating.</span></span><br><span class="line"><span class="comment">// å½“å‰invokerçš„æ´»è·ƒæ•°å’Œè®¡æ•°ç›¸åŒï¼Œè¯´æ˜Nä¸ªinvokeréƒ½æ˜¯æœ€å°è®¡æ•°ï¼Œå…¨éƒ¨ä¿å­˜åˆ°é›†åˆä¸­åç»­å°±åœ¨å®ƒä»¬é‡Œé¢æ ¹æ®æƒé‡é€‰å–ä¸€ä¸ªã€‚</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (active == leastActive) &#123;</span><br><span class="line">            <span class="comment">// Record the index of the least active invoker in leastIndexes order</span></span><br><span class="line">            leastIndexes[leastCount++] = i;</span><br><span class="line">            <span class="comment">// Accumulate the total weight of the least active invoker</span></span><br><span class="line">            totalWeight += afterWarmup;</span><br><span class="line">            <span class="comment">// If every invoker has the same weight?</span></span><br><span class="line">            <span class="keyword">if</span> (sameWeight &amp;&amp; i &gt; <span class="number">0</span></span><br><span class="line">                    &amp;&amp; afterWarmup != firstWeight) &#123;</span><br><span class="line">                sameWeight = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Choose an invoker from all the least active invokers</span></span><br><span class="line"><span class="comment">// å¦‚æœåªæœ‰ä¸ªinvokerç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (leastCount == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// If we got exactly one invoker having the least active value, return this invoker directly.</span></span><br><span class="line">        <span class="keyword">return</span> invokers.get(leastIndexes[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// å¦‚æœæƒé‡ä¸ä¸€æ ·ï¼Œåˆ™ä½¿ç”¨å’ŒRandomè´Ÿè½½å‡è¡¡ä¸€æ ·çš„æƒé‡ç®—æ³•æ‰¾åˆ°ä¸€ä¸ªinvokerå¹¶è¿”å›ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (!sameWeight &amp;&amp; totalWeight &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// If (not every invoker has the same weight &amp; at least one invoker's weight&gt;0), select randomly based on </span></span><br><span class="line">        <span class="comment">// totalWeight.</span></span><br><span class="line">        <span class="keyword">int</span> offsetWeight = ThreadLocalRandom.current().nextInt(totalWeight);</span><br><span class="line">        <span class="comment">// Return a invoker based on the random value.</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; leastCount; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> leastIndex = leastIndexes[i];</span><br><span class="line">            offsetWeight -= weights[leastIndex];</span><br><span class="line">            <span class="keyword">if</span> (offsetWeight &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> invokers.get(leastIndex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// å¦‚æœæƒé‡ç›¸åŒéšæœºé€‰å–ä¸€ä¸ªè¿”å›ã€‚</span></span><br><span class="line">    <span class="comment">// If all invokers have the same weight value or totalWeight=0, return evenly.</span></span><br><span class="line">    <span class="keyword">return</span> invokers.get(leastIndexes[ThreadLocalRandom.current().nextInt(leastCount)]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>Dubboçš„è´Ÿè½½å‡è¡¡æ˜¯å›´ç»•æƒé‡è¿›è¡Œè®¡ç®—çš„ï¼š</p><ol><li><p>ä¸€è‡´æ€§å“ˆå¸Œåˆ©ç”¨äº†ç›®å‰ketamaå“ˆå¸Œç®—æ³•ï¼Œredisçš„é›†ç¾¤æ–¹æ¡ˆä¹Ÿæœ‰ä½¿ç”¨åˆ°ã€‚</p></li><li><p>rondomä»¥æ€»æƒé‡ä¸ºçº¿ï¼Œæ¯ä¸ªinvokerçš„æƒé‡ä¸ºæ®µï¼Œéšæœºä»æ€»æƒé‡ä¸­è·å–ä¸€ä¸ªæ¸¸æ ‡offsetï¼Œåˆ¤æ–­offsetä½äºé‚£ä¸€æ®µï¼Œå°±è¿”å›è¯¥invokerã€‚</p></li><li>Roundbinä½¿ç”¨å¹³æ»‘æƒé‡è½®å¾ªçš„æ•°å­¦åŸç†ã€‚</li></ol><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://www.notion.so/Dubbo-ca1fd67df519464583c4a240244e239b#57b1bedf8e2c48be9c92380ddd721ced/" target="_blank" rel="noopener">https://www.notion.so/Dubbo-ca1fd67df519464583c4a240244e239b#57b1bedf8e2c48be9c92380ddd721ced/</a></p>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;Dubboçš„Cluterä¼šé€‰æ‹©æœ€åˆé€‚çš„æœåŠ¡ï¼Œä¾›è°ƒç”¨è€…ä½¿ç”¨ã€‚å¦‚ä½•é€‰å–ï¼Ÿ  &lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;ConsistentHashï¼ŒKetamaä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ã€‚&lt;/li&gt;
&lt;li&gt;Rondomï¼Œéšæœºè·å–ã€‚&lt;/li&gt;
&lt;li&gt;Roundbinï¼Œè½®è¯¢é€‰æ‹©ã€‚&lt;/li&gt;
&lt;li&gt;leastActiveï¼Œé€‰æ‹©æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„èŠ‚ç‚¹ã€‚&lt;/li&gt;&lt;/ol&gt;&lt;/blockquote&gt;
    
    </summary>
    
      <category term="dubbo" scheme="http://yoursite.com/categories/dubbo/"/>
    
    
      <category term="Router" scheme="http://yoursite.com/tags/Router/"/>
    
  </entry>
  
  <entry>
    <title>Dubbo Clusterå¦‚ä½•è·å–æœ€ä¼˜çš„æœåŠ¡æä¾›è€…ï¼Ÿ</title>
    <link href="http://yoursite.com/2020/05/19/20001/"/>
    <id>http://yoursite.com/2020/05/19/20001/</id>
    <published>2020-05-19T14:07:51.000Z</published>
    <updated>2020-06-09T15:07:12.657Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>Clusterçš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€å°±æ˜¯å¯»æ‰¾å‡ºåˆé€‚çš„æœåŠ¡æä¾›è€…ï¼Œä¾›æ¶ˆè´¹è€…è¿œç¨‹è°ƒç”¨ã€‚<br>å¦‚ä½•å¯»æ‰¾ï¼š</p><ol><li><p>è·å–æ¶ˆè´¹è€…èƒ½å¤Ÿè¿œç¨‹è°ƒç”¨çš„æ‰€æœ‰æœåŠ¡æä¾›è€…åˆ—è¡¨ã€‚</p></li><li><p>é€‰æ‹©åˆé€‚çš„Invokerã€‚</p></li><li><p>å¦‚æœåªæœ‰ä¸€ä¸ªInvokeråˆ™ç›´æ¥è¿”å›ï¼Œæœ‰å¤šä¸ªInvokerï¼Œåˆ™é€šè¿‡loadbalanceç»„ä»¶é€‰æ‹©å‡ºåˆé€‚çš„Invokerã€‚ </p> <a id="more"></a></li></ol></blockquote><h4 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h4><p>Invocationï¼šä¼šè¯åŸŸï¼Œå®ƒæŒæœ‰è°ƒç”¨è¿‡ç¨‹ä¸­çš„å˜é‡ï¼Œæ¯”å¦‚æ–¹æ³•åï¼Œå‚æ•°ç­‰ã€‚<br>Invoker:å®ä½“åŸŸï¼Œå®ƒæ˜¯ Dubbo çš„æ ¸å¿ƒæ¨¡å‹ï¼Œå…¶å®ƒæ¨¡å‹éƒ½å‘å®ƒé æ‰°ï¼Œæˆ–è½¬æ¢æˆå®ƒï¼Œå®ƒä»£è¡¨ä¸€ä¸ªå¯æ‰§è¡Œä½“ï¼Œå¯å‘å®ƒå‘èµ· invoke è°ƒç”¨ï¼Œå®ƒæœ‰å¯èƒ½æ˜¯ä¸€ä¸ªæœ¬åœ°çš„å®ç°ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªè¿œç¨‹çš„å®ç°ï¼Œä¹Ÿå¯èƒ½ä¸€ä¸ªé›†ç¾¤å®ç°ã€‚</p><h4 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h4><p>é›†ç¾¤ Cluster ç”¨é€”æ˜¯å°†å¤šä¸ªæœåŠ¡æä¾›è€…åˆå¹¶ä¸ºä¸€ä¸ª Cluster Invokerï¼Œå¹¶å°†è¿™ä¸ª Invoker æš´éœ²ç»™æœåŠ¡æ¶ˆè´¹è€…ã€‚ä»¥Failover Clusterä¸ºåŸºç¡€äº†è§£Clusteræ‰§è¡Œ</p><p> Clusterï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SPI</span>(FailoverCluster.NAME)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Cluster</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Merge the directory invokers to a virtual invoker.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> directory</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> cluster invoker  </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> RpcException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Adaptive</span></span><br><span class="line">    &lt;T&gt; <span class="function">Invoker&lt;T&gt; <span class="title">join</span><span class="params">(Directory&lt;T&gt; directory)</span> <span class="keyword">throws</span> RpcException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FailoverCluster</span> <span class="keyword">implements</span> <span class="title">Cluster</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String NAME = <span class="string">"failover"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">Invoker&lt;T&gt; <span class="title">join</span><span class="params">(Directory&lt;T&gt; directory)</span> <span class="keyword">throws</span> RpcException </span>&#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºå¹¶è¿”å›FailoverClusterInvoker</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FailoverClusterInvoker&lt;T&gt;(directory);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Clusterè·å–Invokeræµç¨‹"><a href="#Clusterè·å–Invokeræµç¨‹" class="headerlink" title="Clusterè·å–Invokeræµç¨‹"></a>Clusterè·å–Invokeræµç¨‹</h4><p>AbstractClusterInvoker:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">invoke</span><span class="params">(<span class="keyword">final</span> Invocation invocation)</span> <span class="keyword">throws</span> RpcException </span>&#123;</span><br><span class="line">    checkWhetherDestroyed();</span><br><span class="line">    <span class="comment">// binding attachments into invocation.</span></span><br><span class="line">    Map&lt;String, String&gt; contextAttachments = RpcContext.getContext().getAttachments();</span><br><span class="line">    <span class="keyword">if</span> (contextAttachments != <span class="keyword">null</span> &amp;&amp; contextAttachments.size() != <span class="number">0</span>) &#123;</span><br><span class="line">        ((RpcInvocation) invocation).addAttachments(contextAttachments);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆ—ä¸¾invoker</span></span><br><span class="line">    List&lt;Invoker&lt;T&gt;&gt; invokers = list(invocation);</span><br><span class="line">    <span class="comment">// åŠ è½½LoadBalance </span></span><br><span class="line">    LoadBalance loadbalance = initLoadBalance(invokers, invocation);</span><br><span class="line">    RpcUtils.attachInvocationIdIfAsync(getUrl(), invocation);</span><br><span class="line">    <span class="keyword">return</span> doInvoke(invocation, invokers, loadbalance);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>FailoverClusterInvoker</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"unchecked"</span>, <span class="string">"rawtypes"</span>&#125;)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">doInvoke</span><span class="params">(Invocation invocation, <span class="keyword">final</span> List&lt;Invoker&lt;T&gt;&gt; invokers, LoadBalance loadbalance)</span> <span class="keyword">throws</span> RpcException </span>&#123;</span><br><span class="line">    List&lt;Invoker&lt;T&gt;&gt; copyInvokers = invokers;</span><br><span class="line">    <span class="comment">// invokersåˆ¤ç©ºæ£€æŸ¥</span></span><br><span class="line">    checkInvokers(copyInvokers, invocation);</span><br><span class="line">          <span class="comment">// è·å–è®¿é—®çš„æ–¹æ³•</span></span><br><span class="line">    String methodName = RpcUtils.getMethodName(invocation);    </span><br><span class="line">    <span class="comment">// é‡è¯•æ¬¡æ•°</span></span><br><span class="line">    <span class="keyword">int</span> len = getUrl().getMethodParameter(methodName, RETRIES_KEY, DEFAULT_RETRIES) + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (len &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        len = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// retry loop.</span></span><br><span class="line">    RpcException le = <span class="keyword">null</span>; <span class="comment">// last exception.</span></span><br><span class="line">    List&lt;Invoker&lt;T&gt;&gt; invoked = <span class="keyword">new</span> ArrayList&lt;Invoker&lt;T&gt;&gt;(copyInvokers.size()); <span class="comment">// invoked invokers.</span></span><br><span class="line">    Set&lt;String&gt; providers = <span class="keyword">new</span> HashSet&lt;String&gt;(len);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// åœ¨è¿›è¡Œé‡è¯•å‰é‡æ–°åˆ—ä¸¾Invokerï¼Œè¿™æ ·åšçš„å¥½æ•°æ˜¯å¦‚æœæŸä¸ªæœåŠ¡æŒ‚äº†ï¼Œé€šè¿‡è°ƒç”¨listå¯å¾—åˆ°æœ€æ–°å¯ç”¨çš„Invokeråˆ—è¡¨</span></span><br><span class="line">            checkWhetherDestroyed();</span><br><span class="line">            copyInvokers = list(invocation);</span><br><span class="line">            <span class="comment">// check again</span></span><br><span class="line">            checkInvokers(copyInvokers, invocation);</span><br><span class="line">        &#125;</span><br><span class="line">         <span class="comment">// é€šè¿‡è´Ÿè½½å‡è¡¡é€‰æ‹©invoker</span></span><br><span class="line">        Invoker&lt;T&gt; invoker = select(loadbalance, invocation, copyInvokers, invoked);</span><br><span class="line">        <span class="comment">// æ·»åŠ invokeråˆ°invoked åˆ—è¡¨ä¸­</span></span><br><span class="line">        invoked.add(invoker);</span><br><span class="line">        <span class="comment">// è®¾ç½®invokedåˆ°RPCä¸Šä¸‹æ–‡ä¸­</span></span><br><span class="line">        RpcContext.getContext().setInvokers((List) invoked);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// è°ƒç”¨ç›®æ ‡Invokerçš„invokeæ–¹æ³•</span></span><br><span class="line">            Result result = invoker.invoke(invocation);</span><br><span class="line">            <span class="keyword">if</span> (le != <span class="keyword">null</span> &amp;&amp; logger.isWarnEnabled()) &#123;</span><br><span class="line">                logger.warn(<span class="string">"Although retry the method "</span> + methodName</span><br><span class="line">                        + <span class="string">" in the service "</span> + getInterface().getName()</span><br><span class="line">                        + <span class="string">" was successful by the provider "</span> + invoker.getUrl().getAddress()</span><br><span class="line">                        + <span class="string">", but there have been failed providers "</span> + providers</span><br><span class="line">                        + <span class="string">" ("</span> + providers.size() + <span class="string">"/"</span> + copyInvokers.size()</span><br><span class="line">                        + <span class="string">") from the registry "</span> + directory.getUrl().getAddress()</span><br><span class="line">                        + <span class="string">" on the consumer "</span> + NetUtils.getLocalHost()</span><br><span class="line">                        + <span class="string">" using the dubbo version "</span> + Version.getVersion() + <span class="string">". Last error is: "</span></span><br><span class="line">                        + le.getMessage(), le);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RpcException e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (e.isBiz()) &#123; <span class="comment">// biz exception.</span></span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125;</span><br><span class="line">            le = e;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            le = <span class="keyword">new</span> RpcException(e.getMessage(), e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            providers.add(invoker.getUrl().getAddress());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(le.getCode(), <span class="string">"Failed to invoke the method "</span></span><br><span class="line">            + methodName + <span class="string">" in the service "</span> + getInterface().getName()</span><br><span class="line">            + <span class="string">". Tried "</span> + len + <span class="string">" times of the providers "</span> + providers</span><br><span class="line">            + <span class="string">" ("</span> + providers.size() + <span class="string">"/"</span> + copyInvokers.size()</span><br><span class="line">            + <span class="string">") from the registry "</span> + directory.getUrl().getAddress()</span><br><span class="line">            + <span class="string">" on the consumer "</span> + NetUtils.getLocalHost() + <span class="string">" using the dubbo version "</span></span><br><span class="line">            + Version.getVersion() + <span class="string">". Last error is: "</span></span><br><span class="line">            + le.getMessage(), le.getCause() != <span class="keyword">null</span> ? le.getCause() : le);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="è·å–æœ€åˆé€‚çš„æœåŠ¡æµç¨‹"><a href="#è·å–æœ€åˆé€‚çš„æœåŠ¡æµç¨‹" class="headerlink" title="è·å–æœ€åˆé€‚çš„æœåŠ¡æµç¨‹"></a>è·å–æœ€åˆé€‚çš„æœåŠ¡æµç¨‹</h4><p>é€‰æ‹©Invokerçš„æ–¹æ³•</p><ol><li>é¦–å…ˆæ ¹æ®loadbalanceè¿›è¡Œé€‰æ‹©ï¼Œå¦‚æœinvokeråœ¨ä»¥å‰é€‰æ‹©çš„åˆ—è¡¨ä¸­æˆ–invokerä¸èƒ½æä¾›æœåŠ¡è¿›è¡Œreselectã€‚  </li><li>é‡é€‰çš„éªŒè¯è§„åˆ™ï¼šselected&gt;availableï¼Œè¿™ä¸ªè§„åˆ™ä¿è¯é€‰ä¸­çš„invokeræ˜¯åœ¨ä»¥å‰é€‰ä¸­çš„åˆ—è¡¨ä¸­æœ€å°å˜åŠ¨çš„ï¼Œä¹Ÿä¿è¯äº†å…¶é€‚ç”¨æ€§ã€‚</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Invoker&lt;T&gt; <span class="title">select</span><span class="params">(LoadBalance loadbalance, Invocation invocation,</span></span></span><br><span class="line"><span class="function"><span class="params">                        List&lt;Invoker&lt;T&gt;&gt; invokers, List&lt;Invoker&lt;T&gt;&gt; selected)</span> <span class="keyword">throws</span> RpcException </span>&#123;</span><br><span class="line"><span class="comment">// åˆ¤ç©ºæ£€æŸ¥</span></span><br><span class="line"><span class="keyword">if</span> (CollectionUtils.isEmpty(invokers)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line">String methodName = invocation == <span class="keyword">null</span> ? StringUtils.EMPTY : invocation.getMethodName();</span><br><span class="line"><span class="comment">// åˆ¤æ–­è¯·æ±‚çš„æ–¹æ³•ä¸ºç²˜æ»è¿æ¥</span></span><br><span class="line"><span class="keyword">boolean</span> sticky = invokers.get(<span class="number">0</span>).getUrl()</span><br><span class="line">        .getMethodParameter(methodName, CLUSTER_STICKY_KEY, DEFAULT_CLUSTER_STICKY);</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ£€æµ‹invokersåˆ—è¡¨æ˜¯å¦åŒ…å«stickyInvokerã€‚å¦‚æœä¸åŒ…å«ï¼Œè¯´æ˜stickyInvokerä»£è¡¨çš„æœåŠ¡æä¾›è€…æŒ‚äº†ï¼Œæ­¤æ—¶éœ€è¦å°†å…¶ç½®ä¸ºç©º</span></span><br><span class="line"><span class="keyword">if</span> (stickyInvoker != <span class="keyword">null</span> &amp;&amp; !invokers.contains(stickyInvoker)) &#123;</span><br><span class="line">    stickyInvoker = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// åœ¨stickyä¸ºtrueä¸”stickyInvoker!=nullçš„æƒ…å†µä¸‹ï¼Œå¦‚æœselectedåŒ…å«stickeyInvoker,è¡¨æ˜stickeyInvokerå¯¹åº”çš„æœåŠ¡æä¾›è€…å¯èƒ½å› ä¸ºç½‘ç»œåŸå› æœªèƒ½æˆåŠŸæä¾›æœåŠ¡ï¼Œä½†æ˜¯è¯¥æä¾›è€…å¹¶æ²¡æŒ‚ï¼Œæ­¤æ—¶invokersåˆ—è¡¨ä¸­ä»å­˜åœ¨è¯¥æœåŠ¡æä¾›è€…å¯¹åº”çš„Invoker</span></span><br><span class="line"><span class="keyword">if</span> (sticky &amp;&amp; stickyInvoker != <span class="keyword">null</span> &amp;&amp; (selected == <span class="keyword">null</span> || !selected.contains(stickyInvoker))) &#123;</span><br><span class="line">    <span class="comment">// availablecheckè¡¨ç¤ºæ˜¯å¦å¼€å¯äº†å¯ç”¨æ€§æ£€æŸ¥ï¼Œå¦‚æœå¼€å¯äº†ï¼Œåˆ™è°ƒç”¨stickyInvokerçš„isAvailableæ–¹æ³•è¿›è¡Œæ£€æŸ¥ï¼Œè‹¥æœæ£€æŸ¥é€šè¿‡ï¼Œåˆ™ç›´æ¥è¿”å›stickyInvoker</span></span><br><span class="line">    <span class="keyword">if</span> (availablecheck &amp;&amp; stickyInvoker.isAvailable()) &#123;</span><br><span class="line">        <span class="keyword">return</span> stickyInvoker;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç²˜æ€§è¿æ¥ä¸ºnullæˆ–è€…ä¸å¯ç”¨ï¼Œéœ€è¦è¿›è¡Œé‡ç°é€‰æ‹©</span></span><br><span class="line">Invoker&lt;T&gt; invoker = doSelect(loadbalance, invocation, invokers, selected);</span><br><span class="line"><span class="comment">// å¦‚æœstickyä¸ºtrueï¼Œå°†è´Ÿè½½å‡è¡¡ç»„ä»¶é€‰æ‹©çš„Invokerèµ‹å€¼ç»™stickyInvoker</span></span><br><span class="line"><span class="keyword">if</span> (sticky) &#123;</span><br><span class="line">    stickyInvoker = invoker;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="keyword">return</span> invoker;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€‰æ‹©Invoker</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Invoker&lt;T&gt; <span class="title">doSelect</span><span class="params">(LoadBalance loadbalance, Invocation invocation,</span></span></span><br><span class="line"><span class="function"><span class="params">                            List&lt;Invoker&lt;T&gt;&gt; invokers, List&lt;Invoker&lt;T&gt;&gt; selected)</span> <span class="keyword">throws</span> RpcException </span>&#123;</span><br><span class="line">    <span class="comment">// åˆ¤ç©ºæ£€æŸ¥</span></span><br><span class="line">    <span class="keyword">if</span> (CollectionUtils.isEmpty(invokers)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (invokers.size() == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> invokers.get(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// é€šè¿‡è´Ÿè½½å‡è¡¡é€‰æ‹©Invoker</span></span><br><span class="line">    Invoker&lt;T&gt; invoker = loadbalance.select(invokers, getUrl(), invocation);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœselectedåŒ…å«è´Ÿè½½å‡è¡¡é€‰æ‹©å‡ºçš„Invoker,æˆ–è€…è¯¥Invokeræ— æ³•ç»è¿‡å¯ç”¨æ€§æ£€æŸ¥ï¼Œæ­¤æ—¶è¿›è¡Œé‡é€‰</span></span><br><span class="line">    <span class="keyword">if</span> ((selected != <span class="keyword">null</span> &amp;&amp; selected.contains(invoker))</span><br><span class="line">            || (!invoker.isAvailable() &amp;&amp; getUrl() != <span class="keyword">null</span> &amp;&amp; availablecheck)) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// è¿›è¡Œé‡é€‰</span></span><br><span class="line">            Invoker&lt;T&gt; rInvoker = reselect(loadbalance, invocation, invokers, selected, availablecheck);</span><br><span class="line">            <span class="keyword">if</span> (rInvoker != <span class="keyword">null</span>) &#123;</span><br><span class="line">                invoker = rInvoker;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//è·å–Invokeråœ¨Invokersä¸­çš„ä½ç½®</span></span><br><span class="line">                <span class="keyword">int</span> index = invokers.indexOf(invoker);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//è·å–index+1ä½ç½®å¤„çš„Invoker</span></span><br><span class="line">                    invoker = invokers.get((index + <span class="number">1</span>) % invokers.size());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    logger.warn(e.getMessage() + <span class="string">" may because invokers list dynamic change, ignore."</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            logger.error(<span class="string">"cluster reselect fail reason is :"</span> + t.getMessage() + <span class="string">" if can not solve, you can set cluster.availablecheck=false in url"</span>, t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> invoker;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‡ç°è¿›è¡Œé€‰æ‹© </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Invoker&lt;T&gt; <span class="title">reselect</span><span class="params">(LoadBalance loadbalance, Invocation invocation,</span></span></span><br><span class="line"><span class="function"><span class="params">                            List&lt;Invoker&lt;T&gt;&gt; invokers, List&lt;Invoker&lt;T&gt;&gt; selected, <span class="keyword">boolean</span> availablecheck)</span> <span class="keyword">throws</span> RpcException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Allocating one in advance, this list is certain to be used.</span></span><br><span class="line">    List&lt;Invoker&lt;T&gt;&gt; reselectInvokers = <span class="keyword">new</span> ArrayList&lt;&gt;(</span><br><span class="line">            invokers.size() &gt; <span class="number">1</span> ? (invokers.size() - <span class="number">1</span>) : invokers.size());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°è¯•ä¸ä»selectedä¸­è·å–</span></span><br><span class="line">    <span class="keyword">for</span> (Invoker&lt;T&gt; invoker : invokers) &#123;</span><br><span class="line">        <span class="comment">// æ£€æŸ¥å¯ç”¨æ€§</span></span><br><span class="line">        <span class="keyword">if</span> (availablecheck &amp;&amp; !invoker.isAvailable()) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœselectedåˆ—è¡¨åŒ…å«å½“å‰invokerï¼Œåˆ™å°†å…¶æ·»åŠ åˆ°reselectInvokersä¸­ã€‚</span></span><br><span class="line">        <span class="keyword">if</span> (selected == <span class="keyword">null</span> || !selected.contains(invoker)) &#123;</span><br><span class="line">            reselectInvokers.add(invoker);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// reselectInvokerä¸ä¸ºç©ºï¼Œé€šè¿‡è´Ÿè½½å‡è¡¡ç»„ä»¶è¿›è¡Œç­›é€‰Invoker</span></span><br><span class="line">    <span class="keyword">if</span> (!reselectInvokers.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span> loadbalance.select(reselectInvokers, getUrl(), invocation);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä»…ä»selectedä¸­æŸ¥æ‰¾èƒ½ç”¨çš„Invoker</span></span><br><span class="line">   <span class="comment">// selected åˆ—è¡¨ä¸­æŸ¥æ‰¾å¯ç”¨çš„ Invokerï¼Œå¹¶å°†å…¶æ·»åŠ åˆ° reselectInvokers é›†åˆä¸­</span></span><br><span class="line">    <span class="keyword">if</span> (selected != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Invoker&lt;T&gt; invoker : selected) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((invoker.isAvailable()) <span class="comment">// available first</span></span><br><span class="line">                    &amp;&amp; !reselectInvokers.contains(invoker)) &#123;</span><br><span class="line">                reselectInvokers.add(invoker);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!reselectInvokers.isEmpty()) &#123;</span><br><span class="line">        <span class="comment">// åœ¨æ­¤è¿›è¡Œç­›é€‰ï¼Œè¿”å›ç»“æœ</span></span><br><span class="line">        <span class="keyword">return</span> loadbalance.select(reselectInvokers, getUrl(), invocation);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›®çš„é€‰æ‹©åˆé€‚çš„Invokeræ‰§è¡Œï¼Œå¦‚ä½•é€‰æ‹©ï¼Ÿ</p><ol><li>è·å–æ‰€æœ‰çš„æœåŠ¡å®ç°è€…ã€‚</li><li>ä»æ‰€æœ‰çš„æœåŠ¡ä¸­é€‰æ‹©å‡ºåˆé€‚çš„å®ç°è€…ã€‚</li><li>é€‰æ‹©ç²˜æ»è¿æ¥çš„å®ç°è€…ã€‚</li><li>Invokerçš„å”¯ä¸€ï¼Œå°±é€‰æ‹©è¿™ä¸ªInvokerã€‚</li><li>loadbalanceç»„ä»¶è¿›è¡Œé€‰æ‹©ã€‚</li></ol><h4 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h4><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">Dubbo</span>](<span class="link">http://dubbo.apache.org/zh-cn/docs/source_code_guide/cluster.html</span>)</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;Clusterçš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€å°±æ˜¯å¯»æ‰¾å‡ºåˆé€‚çš„æœåŠ¡æä¾›è€…ï¼Œä¾›æ¶ˆè´¹è€…è¿œç¨‹è°ƒç”¨ã€‚&lt;br&gt;å¦‚ä½•å¯»æ‰¾ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;p&gt;è·å–æ¶ˆè´¹è€…èƒ½å¤Ÿè¿œç¨‹è°ƒç”¨çš„æ‰€æœ‰æœåŠ¡æä¾›è€…åˆ—è¡¨ã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;é€‰æ‹©åˆé€‚çš„Invokerã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;å¦‚æœåªæœ‰ä¸€ä¸ªInvokeråˆ™ç›´æ¥è¿”å›ï¼Œæœ‰å¤šä¸ªInvokerï¼Œåˆ™é€šè¿‡loadbalanceç»„ä»¶é€‰æ‹©å‡ºåˆé€‚çš„Invokerã€‚ &lt;/p&gt;&lt;/li&gt;&lt;/ol&gt;&lt;/blockquote&gt;
    
    </summary>
    
      <category term="dubbo" scheme="http://yoursite.com/categories/dubbo/"/>
    
    
      <category term="Cluster" scheme="http://yoursite.com/tags/Cluster/"/>
    
  </entry>
  
  <entry>
    <title>Dubboçš„SPIçš„æœºåˆ¶åˆæ¢</title>
    <link href="http://yoursite.com/2020/05/10/20003/"/>
    <id>http://yoursite.com/2020/05/10/20003/</id>
    <published>2020-05-10T10:56:17.000Z</published>
    <updated>2020-06-10T13:21:09.371Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>SPI æ¨¡å¼åœ¨å¼€å‘ä¸­ç”¨åˆ°çš„åœ°æ–¹å¾ˆå¤šï¼Œä½†æ˜¯ä¸€ç›´å’ŒDubboçš„SPIæ··æ·†åœ¨ä¸€èµ·ï¼Œæœ¬æ–‡å¯¹JDKçš„SPIå’ŒDubboçš„SPIåŒºåˆ†çš„ä¸€ä¸ªæ¦‚å¿µçš„å¤§ç•¥äº†è§£ï¼Œä¸ºäº†åå–å¯¹Dubboæ¡†æ¶çš„ç†Ÿæ‚‰åšä¸€ä¸ªåŸºç¡€ã€‚<a id="more"></a></p></blockquote><h2 id="ä»€ä¹ˆæ˜¯SPIï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯SPIï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯SPIï¼Ÿ"></a>ä»€ä¹ˆæ˜¯SPIï¼Ÿ</h2><p>SPIçš„å…¨ç§°æ˜¯Service Provider Interfaceï¼Œç”¨æ¥è¢«ç¬¬ä¸‰æ–¹å®ç°æˆ–è€…æ‰©å±•çš„APIã€‚ä¹Ÿå°±æ˜¯è¯´SPIæ˜¯ä¸€ç§æœåŠ¡å‘ç°æœºåˆ¶ã€‚è€Œå¯¹äºæˆ‘çš„ç†è§£å°±æ˜¯ï¼šSPIæ˜¯ä¸ºæŸä¸ªæ¥å£å¯»æ‰¾å®ç°ç±»çš„æœºåˆ¶ï¼Œæœ‰ç‚¹ç±»ä¼¼äºIOCï¼Œç”¨äºè§£è€¦ã€‚</p><h3 id="JDK-SPI"><a href="#JDK-SPI" class="headerlink" title="JDK SPI"></a>JDK SPI</h3><p>SPIå…·ä½“çº¦å®šï¼šå½“æœåŠ¡çš„æä¾›è€…ï¼Œæä¾›äº†ä¸€ç§æœåŠ¡ä¹‹åï¼Œåœ¨jaråŒ…çš„META-INF/Services/ç›®å½•é‡ŒåŒæ—¶åˆ›å»ºä¸€ä¸ªä»¥æœåŠ¡æ¥å£å…¨è·¯å¾„å‘½åçš„æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶é‡Œå°±æ˜¯å®ç°è¯¥æœåŠ¡çš„æ¥å£çš„å…·ä½“å‘½åçš„å®ç°ç±»ã€‚å½“ç¬¬ä¸‰æ–¹æœåŠ¡éœ€è¦å¼•å…¥è¿™ä¸ªæ¨¡å—çš„æ—¶å€™ï¼Œå°±å¯ä»¥é€šè¿‡è¯¥jaråŒ…çš„MATE-INF/Services/é‡Œçš„é…ç½®æ–‡ä»¶æ‰¾åˆ°å…·ä½“çš„å®ç°ç±»åï¼Œé€šè¿‡JDKæä¾›çš„å·¥å…·ç±»java.util.ServiceLoaderè¿›è¡ŒåŠ è½½å®ä¾‹åŒ–ã€‚</p><p>æœ€å¸¸è§çš„å°±æ˜¯æ•°æ®åº“é©±åŠ¨åŒ…ï¼Œä»¥mysqlä¸ºä¾‹ï¼Œæ­£å¦‚ä¸Šé¢æ‰€è®²çš„ä¸€æ ·ï¼Œåœ¨META-INF/Services/ç›®å½•ä¸‹åˆ›å»ºä»¥java.sql.Driveræ–‡ä»¶ï¼Œæ–‡ä»¶ä¸­æ˜¯æ¥å£çš„å…·ä½“å®ç°ç±»ã€‚</p><p><img src="/2020/05/10/20003/SPI-mysql.png" alt="MySQL SPIé…ç½®"></p><p>è€Œé…ç½®æ–‡ä»¶ä¸­å…·ä½“çš„å®ç°ç±»å¦‚ä¸‹ï¼š</p><p><img src="/2020/05/10/20003/SPI-mysql2.png" alt="MySQL é©±åŠ¨å…·ä½“å®ç°ç±»"></p><h2 id="Dubboçš„SPI"><a href="#Dubboçš„SPI" class="headerlink" title="Dubboçš„SPI"></a>Dubboçš„SPI</h2><h3 id="Dubbo-SPIçº¦å®š"><a href="#Dubbo-SPIçº¦å®š" class="headerlink" title="Dubbo SPIçº¦å®š"></a>Dubbo SPIçº¦å®š</h3><p>dubboçš„SPIåŠ è½½ç±»å’ŒJDKçš„SPIè®°è½½ç±»ä¸åŒï¼Œ dubboçš„è®°è½½ç±»org.apache.dubbo.common.extension.ExtensionLoaderï¼Œè¿›å…¥æºç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å…¼å®¹äº†JDK SPIçš„é…ç½®æ–‡ä»¶æ”¾ç½®ä½ç½®</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SERVICES_DIRECTORY = <span class="string">"META-INF/services/"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DUBBO_DIRECTORY = <span class="string">"META-INF/dubbo/"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DUBBO_INTERNAL_DIRECTORY = DUBBO_DIRECTORY + <span class="string">"internal/"</span>;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * synchronized in getExtensionClasses</span></span><br><span class="line"><span class="comment"> * */</span></span><br><span class="line"><span class="keyword">private</span> Map&lt;String, Class&lt;?&gt;&gt; loadExtensionClasses() &#123;</span><br><span class="line">    cacheDefaultExtensionName();</span><br><span class="line"><span class="comment">// åŠ è½½é…ç½®æ–‡ä»¶çº¦å®šæ”¾ç½®çš„ä½ç½®</span></span><br><span class="line">    Map&lt;String, Class&lt;?&gt;&gt; extensionClasses = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    loadDirectory(extensionClasses, DUBBO_INTERNAL_DIRECTORY, type.getName());</span><br><span class="line">    loadDirectory(extensionClasses, DUBBO_INTERNAL_DIRECTORY, type.getName().replace(<span class="string">"org.apache"</span>, <span class="string">"com.alibaba"</span>));</span><br><span class="line">    loadDirectory(extensionClasses, DUBBO_DIRECTORY, type.getName());</span><br><span class="line">    loadDirectory(extensionClasses, DUBBO_DIRECTORY, type.getName().replace(<span class="string">"org.apache"</span>, <span class="string">"com.alibaba"</span>));</span><br><span class="line">    loadDirectory(extensionClasses, SERVICES_DIRECTORY, type.getName());</span><br><span class="line">    loadDirectory(extensionClasses, SERVICES_DIRECTORY, type.getName().replace(<span class="string">"org.apache"</span>, <span class="string">"com.alibaba"</span>));</span><br><span class="line">    <span class="keyword">return</span> extensionClasses;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±ä¸Šé¢ä¸¤æ®µæºç å¯çŸ¥ï¼Œåœ¨Dubboå¯åŠ¨çš„æ—¶å€™ï¼Œä¼šé»˜è®¤æ‰«æMETA/-INF/servicesã€META-INF/dubbo/ã€META-INF/dubbo/internalä¸‰ä¸ªç›®å½•ï¼Œå…¶å®Dubboçš„SPIå’ŒJDK SPIç±»ä¼¼ï¼ŒåŒæ ·éœ€è¦åœ¨ä»¥ä¸Šä¸‰ä¸ªç›®å½•ä¸­æ”¾ç½®ä»¥å…¨è·¯å¾„åä¸ºå‘½åçš„é…ç½®æ–‡ä»¶ï¼Œè€Œé…ç½®æ–‡ä»¶çš„å†…å®¹ä¸ºkey=æ‰©å±•èŠ‚ç‚¹å®ç°çš„å…¨è·¯å¾„åï¼Œå¦‚æœç”±å¤šä¸ªå®ç°ç±»åˆ™ä½¿ç”¨æ¢è¡Œç¬¦åˆ†å‰²ã€‚keyä¼šä½œä¸ºDubbo SPIæ³¨è§£ä¸­çš„ä¼ å…¥å‚æ•°ã€‚</p><h3 id="SPIçš„ç¼“å­˜"><a href="#SPIçš„ç¼“å­˜" class="headerlink" title="SPIçš„ç¼“å­˜"></a>SPIçš„ç¼“å­˜</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ‰©å±•ç±»ä¸å¯¹åº”çš„æ‰©å±•ç±»åŠ è½½èµ·ç¼“å­˜</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ConcurrentMap&lt;Class&lt;?&gt;, ExtensionLoader&lt;?&gt;&gt; EXTENSION_LOADERS = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰©å±•åä¸ç±»åˆå§‹åŒ–åçš„ç¼“å­˜</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ConcurrentMap&lt;Class&lt;?&gt;, Object&gt; EXTENSION_INSTANCES = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Class&lt;?&gt; type;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ExtensionFactory objectFactory;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰©å±•ç±»ä¸æ‰©å±•åç¼“å­˜</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;Class&lt;?&gt;, String&gt; cachedNames = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ™®é€šæ‰©å±•ç±»ç¼“å­˜ï¼Œä¸åŒ…æ‹¬è‡ªé€‚åº”çš„æ‹“å±•ç±»å’ŒWrapper</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Holder&lt;Map&lt;String, Class&lt;?&gt;&gt;&gt; cachedClasses = <span class="keyword">new</span> Holder&lt;&gt;();</span><br><span class="line"><span class="comment">// æ‰©å±•åä¸@Activateçš„ç¼“å­˜</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; cachedActivates = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"><span class="comment">// æ‰©å±•åä¸æ‰©å±•å¯¹è±¡ç¼“å­˜</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;String, Holder&lt;Object&gt;&gt; cachedInstances = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"><span class="comment">// å®ä¾‹åŒ–åçš„è‡ªé€‚åº”æ‰©å±•å¯¹è±¡ï¼Œåªèƒ½åŒæ—¶å­˜åœ¨ä¸€ä¸ª</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Holder&lt;Object&gt; cachedAdaptiveInstance = <span class="keyword">new</span> Holder&lt;&gt;();</span><br><span class="line"><span class="comment">// è‡ªé€‚åº”æ‰©å±•ç±»ç¼“å­˜</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> Class&lt;?&gt; cachedAdaptiveClass = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">private</span> String cachedDefaultName;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> Throwable createAdaptiveInstanceError;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Wrapperç±»ç¼“å­˜</span></span><br><span class="line"><span class="keyword">private</span> Set&lt;Class&lt;?&gt;&gt; cachedWrapperClasses;</span><br></pre></td></tr></table></figure><p>ç”±ä¸Šé¢æºç å¯ä»¥æ˜ç¡®çš„åˆ†ä¸ºClassç¼“å­˜ï¼Œå®ä¾‹ç¼“å­˜ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addExtension</span><span class="params">(String name, Class&lt;?&gt; clazz)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 1. åŠ è½½Class</span></span><br><span class="line">    getExtensionClasses(); <span class="comment">// load classes</span></span><br><span class="line"><span class="comment">// 2. Class åˆ¤æ–­</span></span><br><span class="line">    <span class="keyword">if</span> (!type.isAssignableFrom(clazz)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Input type "</span> +</span><br><span class="line">                clazz + <span class="string">" doesn't implement the Extension "</span> + type);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (clazz.isInterface()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Input type "</span> +</span><br><span class="line">                clazz + <span class="string">" can't be interface!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!clazz.isAnnotationPresent(Adaptive.class)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(name)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Extension name is blank (Extension "</span> + type + <span class="string">")!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="comment">// Class ç¼“å­˜ä¸­æ˜¯å¦å·²ç»æœ‰è¯¥Classç±»</span></span><br><span class="line">        <span class="keyword">if</span> (cachedClasses.get().containsKey(name)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Extension name "</span> +</span><br><span class="line">                    name + <span class="string">" already exists (Extension "</span> + type + <span class="string">")!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">// å°†è¦åŠ è½½çš„æ‰©å±•ç±»çš„åå­—è¿›è¡Œä¿å­˜ï¼ˆå³ä½¿æ‰©å±•ç±»è·å–ä¸åˆ°ï¼Œä¹Ÿå¯ä»¥çŸ¥é“æ˜¯å“ªä¸ªæ‰©å±•ç±»æ²¡æœ‰è·å–åˆ°ï¼‰</span></span><br><span class="line">        cachedNames.put(clazz, name);</span><br><span class="line">      <span class="comment">// å°†Classæ–‡ä»¶å­˜å…¥ç¼“å­˜</span></span><br><span class="line">        cachedClasses.get().put(name, clazz);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (cachedAdaptiveClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Adaptive Extension already exists (Extension "</span> + type + <span class="string">")!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cachedAdaptiveClass = clazz;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŠ è½½Class</span></span><br><span class="line"><span class="keyword">private</span> Map&lt;String, Class&lt;?&gt;&gt; getExtensionClasses() &#123;</span><br><span class="line">  <span class="comment">// 1.1 ä»Classç¼“å­˜ä¸­è·å–Class</span></span><br><span class="line">        Map&lt;String, Class&lt;?&gt;&gt; classes = cachedClasses.get();</span><br><span class="line">  <span class="comment">// 1.2 Class ä¸å­˜åœ¨</span></span><br><span class="line">        <span class="keyword">if</span> (classes == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (cachedClasses) &#123;</span><br><span class="line">              <span class="comment">// é˜²æ­¢é‡å¤è·å–</span></span><br><span class="line">                classes = cachedClasses.get();</span><br><span class="line">                <span class="keyword">if</span> (classes == <span class="keyword">null</span>) &#123;</span><br><span class="line">                  <span class="comment">// 1.3 ä»é…ç½®ä¸­åŠ è½½Classç±»</span></span><br><span class="line">                    classes = loadExtensionClasses();</span><br><span class="line">                  <span class="comment">// 1.4 ç¼“å­˜ä¸­ä¿å­˜Classç±»</span></span><br><span class="line">                    cachedClasses.set(classes);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">  <span class="comment">// 1.5 è¿”å›Classç±»</span></span><br><span class="line">        <span class="keyword">return</span> classes;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ol><li><p>Classç¼“å­˜ä¼˜å…ˆä»ç¼“å­˜ä¸­è¯»å–ï¼Œå¦‚æœç¼“å­˜ä¸­ä¸å­˜åœ¨ï¼Œåˆ™åŠ è½½é…ç½®æ–‡ä»¶ï¼Œæ ¹æ®é…ç½®æŠŠClassç¼“å­˜åˆ°å†…å­˜ä¸­ï¼Œä½†å¹¶ä¸ä¼šå…¨éƒ¨åˆå§‹åŒ–ï¼Œä¼šæŒ‰éœ€åˆå§‹åŒ–ã€‚</p></li><li><p>å®ä¾‹ç¼“å­˜æ¯æ¬¡è·å–çš„æ—¶å€™ï¼Œä¼šå…ˆä»ç¼“å­˜ä¸­è·å–ï¼Œå¦‚æœç¼“å­˜ä¸­è¯»å–ä¸åˆ°ï¼Œåˆ™é‡æ–°åŠ è½½ç¼“å­˜èµ·æ¥ã€‚</p></li></ol><p>è€ŒClassç¼“å­˜å’Œå®ä¾‹ç¼“å­˜æ ¹æ®å…¶ç‰¹æ€§åˆå¯ä»¥åˆ†ä¸ºæ™®é€šæ‰©å±•ç±»ã€åŒ…è£…æ‰©å±•ç±»ã€è‡ªé€‚åº”æ‰©å±•ç±»ã€å…¶ä»–ç¼“å­˜ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>åœ¨å®˜æ–¹æ–‡æ¡£ä¸­ä¸¤è€…çš„æ¯”è¾ƒå¦‚ä¸‹ï¼š</p><ol><li>JDKæ ‡å‡†çš„SPIä¼šä¸€æ¬¡æ€§å®ä¾‹åŒ–æ‰©å±•çš„æ‰€æœ‰å®ç°ï¼Œå³ä½¿å†…æœ‰ç”¨ä¸Šä¹Ÿä¼šåŠ è½½ã€‚</li><li>å¦‚æœåŠ è½½å¤±è´¥ï¼Œåˆ™è¿æ‰©å±•çš„åç§°éƒ½è·å–ä¸åˆ°ã€‚</li><li>å¢åŠ äº†å¯¹æ‰©å±•IoCå’ŒAOPçš„æ”¯æŒï¼Œä¸€ä¸ªæ‰©å±•å¯ä»¥ç›´æ¥setteræ³¨å…¥å…¶ä»–æ‰©å±•ã€‚</li></ol>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;SPI æ¨¡å¼åœ¨å¼€å‘ä¸­ç”¨åˆ°çš„åœ°æ–¹å¾ˆå¤šï¼Œä½†æ˜¯ä¸€ç›´å’ŒDubboçš„SPIæ··æ·†åœ¨ä¸€èµ·ï¼Œæœ¬æ–‡å¯¹JDKçš„SPIå’ŒDubboçš„SPIåŒºåˆ†çš„ä¸€ä¸ªæ¦‚å¿µçš„å¤§ç•¥äº†è§£ï¼Œä¸ºäº†åå–å¯¹Dubboæ¡†æ¶çš„ç†Ÿæ‚‰åšä¸€ä¸ªåŸºç¡€ã€‚&lt;/p&gt;&lt;/blockquote&gt;
    
    </summary>
    
      <category term="dubbo" scheme="http://yoursite.com/categories/dubbo/"/>
    
    
      <category term="SPI" scheme="http://yoursite.com/tags/SPI/"/>
    
  </entry>
  
  <entry>
    <title>Spring Securityè®¤è¯æµç¨‹æ¦‚è¿°ï¼ˆä¸€ï¼‰</title>
    <link href="http://yoursite.com/2020/05/06/20002/"/>
    <id>http://yoursite.com/2020/05/06/20002/</id>
    <published>2020-05-06T13:19:36.000Z</published>
    <updated>2020-05-10T11:36:12.054Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>Spring Securityæ˜¯ä¸€ä¸ªæ¡†æ¶ï¼Œæä¾›é’ˆå¯¹å¸¸è§æ”»å‡»çš„èº«ä»½éªŒè¯ï¼Œæˆæƒå’Œä¿æŠ¤ã€‚é€šè¿‡å¯¹å‘½ä»¤å¼å’Œååº”å¼åº”ç”¨ç¨‹åºçš„ä¸€æµæ”¯æŒï¼Œå®ƒæ˜¯ä¿æŠ¤åŸºäºSpringçš„åº”ç”¨ç¨‹åºçš„äº‹å®æ ‡å‡†ã€‚æœ¬ç« åªæ˜¯å¯¹Spring Security è®¤è¯æµç¨‹çš„ä¸€ä¸ªå¤§æ¦‚çš„è®¤çŸ¥ï¼<a id="more"></a></p></blockquote><pre><code>##  Spring Securityæ¨¡å—</code></pre><ol><li><p>æ ¸å¿ƒæ¨¡å—ï¼šåŒ…å«æ ¸å¿ƒçš„éªŒè¯å’Œè®¿é—®æ§åˆ¶ç±»å’Œæ¥å£ï¼Œè¿œç¨‹æ”¯æŒå’ŒåŸºæœ¬çš„é…ç½®APIã€‚</p></li><li><p>è¿œç¨‹è°ƒç”¨ï¼šæä¾›Spring Remotingçš„é›†æˆã€‚</p></li><li><p>ç½‘é¡µï¼šåŒ…æ‹¬ç½‘ç«™å®‰å…¨çš„æ¨¡å—ï¼Œæä¾›ç½‘ç«™è®¤è¯æœåŠ¡å’ŒåŸºäºURLè®¿é—®æ§åˆ¶ã€‚</p></li><li><p>é…ç½®ï¼šåŒ…å«å®‰å…¨å‘½ä»¤ç©ºé—´çš„è§£æä»£ç ã€‚</p></li><li><p>LDAPï¼šLDAPéªŒè¯å’Œé…ç½®ä»£ç ã€‚ä¸»è¦ç”¨äºLDAPéªŒè¯å’Œç®¡ç†LDAPç”¨æˆ·å®ä½“</p></li><li><p>ACLè®¿é—®æ§åˆ¶è¡¨ï¼šACLä¸“é—¨çš„é¢†åŸŸå¯¹è±¡çš„å®ç°ã€‚ä¸»è¦ç”¨äºåœ¨ç¨‹åºä¸­åº”ç”¨å®‰å…¨ç‰¹å®šçš„é¢†åŸŸå¯¹è±¡å®ä¾‹ã€‚</p></li><li><p>CASï¼šSpring Securityçš„CASå®¢æˆ·ç«¯é›†æˆã€‚ä¸»è¦ç”¨äºCASçš„SSOæœåŠ¡å™¨ä½¿ç”¨Spring Securityç½‘é¡µéªŒè¯éœ€è¦è¯¥æ¨¡å—ã€‚</p></li><li><p>OpenIDï¼šOpenID ç½‘é¡µéªŒè¯æ”¯æŒã€‚ä½¿ç”¨å¤–éƒ¨çš„OpenIDæœåŠ¡å™¨éªŒè¯ç”¨æˆ·ã€‚</p></li><li><p>Testï¼šæ”¯æŒSpring Securityçš„æµ‹è¯•ã€‚</p><h2 id="æ‰§è¡Œæµç¨‹"><a href="#æ‰§è¡Œæµç¨‹" class="headerlink" title="æ‰§è¡Œæµç¨‹"></a>æ‰§è¡Œæµç¨‹</h2><p><img src="/2020/05/06/20002/20002.png" alt="Spring Securityè®¤è¯æµç¨‹"></p><ol><li><p>è¾“å…¥ç”¨æˆ·åã€å¯†ç åç‚¹å‡»ç™»å½•æŒ‰é’®ï¼Œå…ˆè¿›å…¥ UsernamePassworkAuthenticationFilter çš„çˆ¶ç±»<br>AbstractAuthenticationProcessingFilter è°ƒç”¨ doFilter() æ–¹æ³•ï¼Œç„¶åå†æ‰§è¡Œ UsernamePasswordAuthenticationFilter çš„ attemptAuthentication() æ–¹æ³•è¿›è¡ŒéªŒè¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest req, ServletResponse res, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">    HttpServletRequest request = (HttpServletRequest)req;</span><br><span class="line">    HttpServletResponse response = (HttpServletResponse)res;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.requiresAuthentication(request, response)) &#123;</span><br><span class="line">        chain.doFilter(request, response);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.logger.isDebugEnabled()) &#123;</span><br><span class="line">            <span class="keyword">this</span>.logger.debug(<span class="string">"Request is to process authentication"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Authentication authResult;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// æ‰§è¡Œè®¤è¯æµç¨‹</span></span><br><span class="line">            authResult = <span class="keyword">this</span>.attemptAuthentication(request, response);</span><br><span class="line">            <span class="keyword">if</span> (authResult == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">this</span>.sessionStrategy.onAuthentication(authResult, request, response);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InternalAuthenticationServiceException var8) &#123;</span><br><span class="line">            <span class="keyword">this</span>.logger.error(<span class="string">"An internal error occurred while trying to authenticate the user."</span>, var8);</span><br><span class="line">            <span class="keyword">this</span>.unsuccessfulAuthentication(request, response, var8);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (AuthenticationException var9) &#123;</span><br><span class="line">            <span class="keyword">this</span>.unsuccessfulAuthentication(request, response, var9);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.continueChainBeforeSuccessfulAuthentication) &#123;</span><br><span class="line">            chain.doFilter(request, response);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//è®¤è¯æˆåŠŸ</span></span><br><span class="line">        <span class="keyword">this</span>.successfulAuthentication(request, response, chain, authResult);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li><p>é€šè¿‡UsernamePasswordAuthenticationFilterè¿‡æ»¤å™¨å°†ä¼ å…¥çš„usernameå’Œpasswordç»„è£…æˆUsernamePasswordAuthenticationTokenå¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">username = username.trim();</span><br><span class="line">UsernamePasswordAuthenticationToken authRequest = <span class="keyword">new</span> UsernamePasswordAuthenticationToken(username, password);</span><br><span class="line"><span class="keyword">this</span>.setDetails(request, authRequest);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>.getAuthenticationManager().authenticate(authRequest);</span><br></pre></td></tr></table></figure></li><li><p>å°†UsernamePasswordAuthenticationTokenä¼ é€’åˆ°AuthenticationManagerçš„anthenticateæ–¹æ³•ã€‚</p></li><li><p>AuthenticationManagerå§”æ‰˜ç»™ProviderManagerçš„authencateæ–¹æ³•è¿›è¡Œæ‰§è¡Œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (AuthenticationProvider provider : getProviders()) &#123;</span><br><span class="line">    <span class="comment">//è¿‡æ»¤æ‰æµ‹è¯•æ¨¡å—ç±»</span></span><br><span class="line">   <span class="keyword">if</span> (!provider.supports(toTest)) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (debug) &#123;</span><br><span class="line">      logger.debug(<span class="string">"Authentication attempt using "</span></span><br><span class="line">            + provider.getClass().getName());</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      result = provider.authenticate(authentication);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</span><br><span class="line">         copyDetails(authentication, result);</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (AccountStatusException e) &#123;      prepareException(e, authentication);</span><br><span class="line">      <span class="comment">// SEC-546: Avoid polling additional providers if auth failure is due to</span></span><br><span class="line">      <span class="comment">// invalid account status</span></span><br><span class="line">      <span class="keyword">throw</span> e;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (InternalAuthenticationServiceException e) &#123;</span><br><span class="line">      prepareException(e, authentication);</span><br><span class="line">      <span class="keyword">throw</span> e;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (AuthenticationException e) &#123;</span><br><span class="line">      lastException = e;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>ProviderManagerå°†authenticationä¼ é€’ç»™AbstractUserDetailAuthenticationProviderçš„authenticateæ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">UserDetails user = <span class="keyword">this</span>.userCache.getUserFromCache(username);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (user == <span class="keyword">null</span>) &#123;</span><br><span class="line">   cacheWasUsed = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// è·å–UserDetails</span></span><br><span class="line">      user = retrieveUser(username,</span><br><span class="line">            (UsernamePasswordAuthenticationToken) authentication);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (UsernameNotFoundException notFound) &#123;</span><br><span class="line">      logger.debug(<span class="string">"User '"</span> + username + <span class="string">"' not found"</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (hideUserNotFoundExceptions) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> BadCredentialsException(messages.getMessage(</span><br><span class="line">               <span class="string">"AbstractUserDetailsAuthenticationProvider.badCredentials"</span>,</span><br><span class="line">               <span class="string">"Bad credentials"</span>));</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="keyword">throw</span> notFound;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   Assert.notNull(user,</span><br><span class="line">         <span class="string">"retrieveUser returned null - a violation of the interface contract"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">   <span class="comment">// åœ¨ç”¨æˆ·åå¯†ç éªŒè¯ä¹‹å‰è¿›è¡Œçš„é¢„æ“ä½œ</span></span><br><span class="line">   preAuthenticationChecks.check(user);</span><br><span class="line">   additionalAuthenticationChecks(user,</span><br><span class="line">         (UsernamePasswordAuthenticationToken) authentication);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (AuthenticationException exception) &#123;</span><br><span class="line">   <span class="keyword">if</span> (cacheWasUsed) &#123;</span><br><span class="line">      <span class="comment">// There was a problem, so try again after checking</span></span><br><span class="line">      <span class="comment">// we're using latest data (i.e. not from the cache)</span></span><br><span class="line">      cacheWasUsed = <span class="keyword">false</span>;</span><br><span class="line">      user = retrieveUser(username,</span><br><span class="line">            (UsernamePasswordAuthenticationToken) authentication);</span><br><span class="line">      preAuthenticationChecks.check(user);</span><br><span class="line">      additionalAuthenticationChecks(user,</span><br><span class="line">            (UsernamePasswordAuthenticationToken) authentication);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> exception;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">postAuthenticationChecks.check(user);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!cacheWasUsed) &#123;</span><br><span class="line">   <span class="keyword">this</span>.userCache.putUserInCache(user);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Object principalToReturn = user;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (forcePrincipalAsString) &#123;</span><br><span class="line">   principalToReturn = user.getUsername();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//è¿”å›è®¤è¯æˆåŠŸçš„ç”¨æˆ·ä¿¡æ¯ï¼ˆAuthenticationï¼‰</span></span><br><span class="line"><span class="keyword">return</span> createSuccessAuthentication(principalToReturn, authentication, user);</span><br></pre></td></tr></table></figure></li><li><p>AbstractUserDetailAuthenticationProviderçš„additionalAuthenticationChecksè¿›è¡Œç”¨æˆ·åä¸å¯†ç çš„éªŒè¯ï¼Œè·å–UserDetailsé€šè¿‡å…¶å­ç±»DaoAuthenticationProviderç±»å®ç°ã€‚åœ¨DaoAuthenticationProviderä¸­é€šè¿‡UserDetailsServiceçš„loadUserByUsernameæ–¹æ³•è¿›è¡Œè·å–ã€‚è€ŒDaoAuthenticationProvideråªæ˜¯å…¶æœ€ç®€å•çš„ä¸€ä¸ªå®ç°ã€‚</p></li><li><p>å½“ç”¨æˆ·éªŒè¯æˆåŠŸåï¼Œåˆ©ç”¨SecurityContextHolderç”¨æ¥å­˜å‚¨å®‰å…¨çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚ä¿å­˜å½“å‰çš„è®¿é—®è€…ä¿¡æ¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">successfulAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain, Authentication authResult)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.logger.isDebugEnabled()) &#123;</span><br><span class="line">       <span class="keyword">this</span>.logger.debug(<span class="string">"Authentication success. Updating SecurityContextHolder to contain: "</span> + authResult);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// éªŒè¯æˆåŠŸåï¼Œå°†ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ°SecurityContextHolderä¸­</span></span><br><span class="line">    SecurityContextHolder.getContext().setAuthentication(authResult);</span><br><span class="line">    <span class="keyword">this</span>.rememberMeServices.loginSuccess(request, response, authResult);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.eventPublisher != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.eventPublisher.publishEvent(<span class="keyword">new</span> InteractiveAuthenticationSuccessEvent(authResult, <span class="keyword">this</span>.getClass()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.successHandler.onAuthenticationSuccess(request, response, authResult);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ä¸»è¦æ¥å£é‡Šä¹‰"><a href="#ä¸»è¦æ¥å£é‡Šä¹‰" class="headerlink" title="ä¸»è¦æ¥å£é‡Šä¹‰"></a>ä¸»è¦æ¥å£é‡Šä¹‰</h2><h4 id="AuthenticationéªŒè¯ä¿¡æ¯"><a href="#AuthenticationéªŒè¯ä¿¡æ¯" class="headerlink" title="AuthenticationéªŒè¯ä¿¡æ¯"></a>AuthenticationéªŒè¯ä¿¡æ¯</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Authentication</span> <span class="keyword">extends</span> <span class="title">Principal</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="comment">//æƒé™ä¿¡æ¯åˆ—è¡¨ï¼Œé»˜è®¤æ˜¯GrantedAuthorityæ¥å£çš„ä¸€äº›å®ç°ç±»ã€‚é€šå¸¸æ˜¯ä»£è¡¨æƒé™çš„ä¸€ç³»åˆ—å­—ç¬¦ä¸²ã€‚</span></span><br><span class="line">    Collection&lt;? extends GrantedAuthority&gt; getAuthorities();</span><br><span class="line">    <span class="comment">//å¯†ç ä¿¡æ¯ï¼Œç”¨æˆ·è¾“å…¥çš„å¯†ç å­—ç¬¦ä¸²ï¼Œåœ¨è®¤è¯è¿‡åé€šå¸¸ä¼šè¢«ç§»é™¤ï¼Œç”¨äºä¿éšœå®‰å…¨ã€‚</span></span><br><span class="line">    <span class="function">Object <span class="title">getCredentials</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">// è¯¦ç»†ä¿¡æ¯ï¼Œwebåº”ç”¨ä¸­çš„å®ç°æ¥å£é€šå¸¸ä¸ºWebAuthenticationDetailsï¼Œå®ƒè®°å½•äº†è®¿é—®è€…çš„ipåœ°å€å’ŒsessionIDçš„å€¼ã€‚</span></span><br><span class="line">    <span class="function">Object <span class="title">getDetails</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">// èº«ä»½ä¿¡æ¯ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹è¿”å›çš„æ˜¯UserDetailsæ¥å£çš„å®ç°ç±»ã€‚åœ¨æœªè®¤è¯çš„æƒ…å†µä¸‹è·å–åˆ°çš„æ˜¯ç”¨æˆ·åï¼Œåœ¨å·²è®¤è¯çš„æƒ…å†µä¸‹è·å–åˆ°çš„æ˜¯UserDetailsã€‚</span></span><br><span class="line">    <span class="function">Object <span class="title">getPrincipal</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">// è·å–å½“å‰Authenticationæ˜¯å¦å·²è®¤è¯ã€‚</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isAuthenticated</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">// è®¾ç½®å½“å‰Authenticationæ˜¯å¦å·²è®¤è¯ã€‚</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setAuthenticated</span><span class="params">(<span class="keyword">boolean</span> isAuthenticated)</span> <span class="keyword">throws</span> IllegalArgumentException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="UserDetailsç”¨æˆ·æ ¸å¿ƒä¿¡æ¯"><a href="#UserDetailsç”¨æˆ·æ ¸å¿ƒä¿¡æ¯" class="headerlink" title="UserDetailsç”¨æˆ·æ ¸å¿ƒä¿¡æ¯"></a>UserDetailsç”¨æˆ·æ ¸å¿ƒä¿¡æ¯</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDetails</span> <span class="keyword">extends</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="comment">//è·å–ç”¨æˆ·æƒé™ï¼Œæœ¬è´¨æ˜¯ç”¨æˆ·çš„æ ¡è‰²ä¿¡æ¯</span></span><br><span class="line">   Collection&lt;? extends GrantedAuthority&gt; getAuthorities();</span><br><span class="line">    <span class="comment">//è·å–å¯†ç </span></span><br><span class="line">   <span class="function">String <span class="title">getPassword</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//è·å–ç”¨æˆ·å</span></span><br><span class="line">   <span class="function">String <span class="title">getUsername</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//è´¦æˆ·æ˜¯å¦è¿‡æœŸ</span></span><br><span class="line">   <span class="function"><span class="keyword">boolean</span> <span class="title">isAccountNonExpired</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//è´¦æˆ·æ˜¯å¦è¢«é”å®š</span></span><br><span class="line">   <span class="function"><span class="keyword">boolean</span> <span class="title">isAccountNonLocked</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//å¯†ç æ˜¯å¦è¿‡æœŸ</span></span><br><span class="line">   <span class="function"><span class="keyword">boolean</span> <span class="title">isCredentialsNonExpired</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//è´¦æˆ·æ˜¯å¦å¯ç”¨</span></span><br><span class="line">   <span class="function"><span class="keyword">boolean</span> <span class="title">isEnabled</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol></li></ol></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;Spring Securityæ˜¯ä¸€ä¸ªæ¡†æ¶ï¼Œæä¾›é’ˆå¯¹å¸¸è§æ”»å‡»çš„èº«ä»½éªŒè¯ï¼Œæˆæƒå’Œä¿æŠ¤ã€‚é€šè¿‡å¯¹å‘½ä»¤å¼å’Œååº”å¼åº”ç”¨ç¨‹åºçš„ä¸€æµæ”¯æŒï¼Œå®ƒæ˜¯ä¿æŠ¤åŸºäºSpringçš„åº”ç”¨ç¨‹åºçš„äº‹å®æ ‡å‡†ã€‚æœ¬ç« åªæ˜¯å¯¹Spring Security è®¤è¯æµç¨‹çš„ä¸€ä¸ªå¤§æ¦‚çš„è®¤çŸ¥ï¼&lt;/p&gt;&lt;/blockquote&gt;
    
    </summary>
    
      <category term="Spring" scheme="http://yoursite.com/categories/Spring/"/>
    
    
      <category term="Spring Security" scheme="http://yoursite.com/tags/Spring-Security/"/>
    
  </entry>
  
  <entry>
    <title>SpringBootæ˜¯å¦‚ä½•è¿›è¡Œè‡ªåŠ¨é…ç½®çš„ï¼Ÿ</title>
    <link href="http://yoursite.com/2019/06/04/springboot01/"/>
    <id>http://yoursite.com/2019/06/04/springboot01/</id>
    <published>2019-06-04T15:20:19.000Z</published>
    <updated>2020-05-10T11:36:12.063Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>å¹³æ—¶ä¸€ç›´åœ¨ä½¿ç”¨SpringBootï¼Œä½†æ˜¯æ²¡æœ‰è¿›å…¥æ·±å…¥çš„äº†è§£ï¼Œå…¬å¸éœ€è¦å¯¹åŸæœ‰çš„é¡¹ç›®æ”¹é€ å‡çº§ï¼Œå€Ÿç€è¿™ä¸ªæœºä¼šäº†è§£ä¸‹SpringBootçš„è‡ªåŠ¨åŠ è½½æœºåˆ¶ã€‚<a id="more"></a></p></blockquote><p>&emsp;&emsp;å› ä¸ºå…¬å¸å‘å¯¹dubboè¿›è¡Œå‡çº§ï¼Œè§£å†³dubboä¼˜é›…åœæœºç­‰bugé—®é¢˜ï¼Œå€Ÿç€è¿™ä¸ªæœºä¼šï¼Œå‡çº§æ”¹é€ é¡¹ç›®ä½¿ç”¨SpringBootã€‚</p><h4 id="å¸¸ç”¨æ³¨è§£"><a href="#å¸¸ç”¨æ³¨è§£" class="headerlink" title="å¸¸ç”¨æ³¨è§£"></a>å¸¸ç”¨æ³¨è§£</h4><table><thead><tr><th>æ³¨è§£</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>@Value</td><td>@Value å°±ç›¸å½“äºä¼ ç»Ÿ xml é…ç½®æ–‡ä»¶ä¸­çš„ value å­—æ®µã€‚</td></tr><tr><td>@ConfigurationProperties</td><td>å¯¹æ ‡è®°æœ‰@ConfigurationPropertiesçš„ç±»æ‰€æœ‰å±æ€§å’Œé…ç½®æ–‡ä»¶ä¸­ç›¸å…³çš„é…ç½®é¡¹è¿›è¡Œç»‘å®šã€‚ï¼ˆé»˜è®¤ä»å…¨å±€é…ç½®æ–‡ä»¶ä¸­è·å–é…ç½®å€¼ï¼‰ï¼Œç»‘å®šä¹‹åæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è¿™ä¸ªç±»å»è®¿é—®å…¨å±€é…ç½®æ–‡ä»¶ä¸­çš„å±æ€§å€¼äº†ã€‚</td></tr><tr><td>@Import</td><td>@Importæ³¨è§£æ”¯æŒå¯¼å…¥æ™®é€šJavaç±»ï¼Œå¹¶å°†å…¶å£°æ˜æˆä¸€ä¸ªbeanã€‚ä¸»è¦ç”¨äºå°†å¯¹å„åˆ†æ•£çš„java configé…ç½®ç±»èåˆæˆä¸€ä¸ªæ›´å¤§çš„configç±»ã€‚</td></tr><tr><td>@Conditional</td><td>@Conditionalæ³¨é‡Šå¯ä»¥å®ç°åªæœ‰åœ¨ç‰¹å®šæ¡ä»¶æ»¡è¶³æ—¶æ‰å¯ç”¨ä¸€äº›é…ç½®ã€‚</td></tr></tbody></table><h4 id="SpringBootè‡ªåŠ¨é…ç½®åŸç†"><a href="#SpringBootè‡ªåŠ¨é…ç½®åŸç†" class="headerlink" title="SpringBootè‡ªåŠ¨é…ç½®åŸç†"></a>SpringBootè‡ªåŠ¨é…ç½®åŸç†</h4><p>&emsp;&emsp;SpringBootçš„è‡ªåŠ¨é…ç½®æºå¤´ä¸€åˆ‡éƒ½è¦ä»@SpringBootApplicationè¿™ä¸ªæ³¨è§£å¼€å§‹è¯´èµ·ã€‚</p><p>@SpringBootApplication æ ‡æ³¨åœ¨æŸä¸ªç±»ä¸Šè¯´æ˜ï¼š</p><ul><li>è¿™ä¸ªç±»æ˜¯ SpringBoot çš„ä¸»é…ç½®ç±»ã€‚</li><li>SpringBoot å°±åº”è¯¥è¿è¡Œè¿™ä¸ªç±»çš„ main æ–¹æ³•æ¥å¯åŠ¨ SpringBoot åº”ç”¨ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@SpringBootConfiguration</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(excludeFilters = &#123; <span class="meta">@Filter</span>(type = FilterType.CUSTOM, classes = TypeExcludeFilter.class),</span><br><span class="line"><span class="meta">@Filter</span>(type = FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter.class) &#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SpringBootApplication &#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;é€šè¿‡æºç å¯çŸ¥ï¼Œ@SpringBootApplicationæ˜¯ä¸€ä¸ªç»„åˆæ³¨è§£ï¼Œç”±ä¸‰ä¸ªæ³¨è§£ç»„æˆï¼š</p><p>@SpringBootConfigurationï¼šè¯¥æ³¨è§£è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªSpringBootçš„é…ç½®ç±»ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªConfigurationæ³¨è§£è€Œå·²ã€‚</p><p>@EnableAutoConfigurationï¼šå¼€å¯è‡ªåŠ¨é…ç½®ã€‚</p><p>@ComponentScanï¼šå¼€å¯ç»„ä»¶æ‰«æã€‚</p><p>åœ¨æŸ¥çœ‹ä¸‹å¼€å¯è‡ªåŠ¨é…ç½®çš„çš„æ³¨è§£ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@AutoConfigurationPackage</span></span><br><span class="line"><span class="meta">@Import</span>(AutoConfigurationImportSelector.class)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableAutoConfiguration &#123;</span><br><span class="line"></span><br><span class="line">String ENABLED_OVERRIDE_PROPERTY = <span class="string">"spring.boot.enableautoconfiguration"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Exclude specific auto-configuration classes such that they will never be applied.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the classes to exclude</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">Class&lt;?&gt;[] exclude() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Exclude specific auto-configuration class names such that they will never be</span></span><br><span class="line"><span class="comment"> * applied.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the class names to exclude</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.3.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">String[] excludeName() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>@EnableAutoConfigurationæ³¨è§£ç”±@AutoConfigurationPackageå’Œ@Importä¸¤ä¸ªæ³¨è§£ç»„æˆã€‚</p><p>@AutoConfigurationPackageï¼šç”±@Import(AutoConfigurationPackages.Registrar.class)å¯çŸ¥ï¼Œå…¶æ³¨è§£ä¸»è¦æ˜¯å°†ä¸»é…ç½®ç±»ï¼ˆ@SpringBootConfigurationæ ‡æ³¨çš„ç±»ï¼‰çš„æ‰€åœ¨åŒ…åŠä¸‹é¢æ‰€æœ‰å­åŒ…é‡Œé¢çš„æ‰€æœ‰ç»„ä»¶æ‰«æåˆ°Springå®¹å™¨ä¸­ã€‚</p><p>@Importè‡ªåŠ¨å¯¼å…¥äº†AutoConfigurationImportSelector.classé…ç½®ç±»ã€‚</p><p>&emsp;&emsp;é€šè¿‡AutoConfigurationImportSelector#selectImportsæ–¹æ³•è¿”å›éœ€è¦å¯¼å…¥çš„ç»„ä»¶çš„å…¨ç±»åæ•°ç»„çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String[] selectImports(AnnotationMetadata annotationMetadata) &#123;</span><br><span class="line"><span class="keyword">if</span> (!isEnabled(annotationMetadata)) &#123;</span><br><span class="line"><span class="keyword">return</span> NO_IMPORTS;</span><br><span class="line">&#125;</span><br><span class="line">  <span class="comment">//1ã€åŠ è½½META-INF/spring-autoconfigure-metadata.propertiesæ–‡ä»¶</span></span><br><span class="line">AutoConfigurationMetadata autoConfigurationMetadata = AutoConfigurationMetadataLoader</span><br><span class="line">.loadMetadata(<span class="keyword">this</span>.beanClassLoader);</span><br><span class="line">AutoConfigurationEntry autoConfigurationEntry = getAutoConfigurationEntry(autoConfigurationMetadata,</span><br><span class="line">annotationMetadata);</span><br><span class="line">  <span class="comment">//3.Â å°†EnableAutoConfigurationçš„å€¼å°è£…åœ¨ä¸€ä¸ªæ•°ç»„ä¸­è¿”å›ã€‚</span></span><br><span class="line"><span class="keyword">return</span> StringUtils.toStringArray(autoConfigurationEntry.getConfigurations());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡ getAutoConfigurationEntry() -&gt; getCandidateConfigurations() -&gt; loadFactoryNames()æŸ¥æ‰¾å…¨ç±»åã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> List&lt;String&gt; <span class="title">getCandidateConfigurations</span><span class="params">(AnnotationMetadata metadata, AnnotationAttributes attributes)</span> </span>&#123;</span><br><span class="line">List&lt;String&gt; configurations = SpringFactoriesLoader.loadFactoryNames(getSpringFactoriesLoaderFactoryClass(),</span><br><span class="line">getBeanClassLoader());</span><br><span class="line">Assert.notEmpty(configurations, <span class="string">"No auto configuration classes found in META-INF/spring.factories. If you "</span></span><br><span class="line">+ <span class="string">"are using a custom packaging, make sure that file is correct."</span>);</span><br><span class="line"><span class="keyword">return</span> configurations;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨loadFactoryNamesæ–¹æ³•ä¸­ï¼Œä»å½“å‰é¡¹ç›®çš„è·¯å¾„ä¸­è·å–æ‰€æœ‰MATA-INF/spring.factoriesæ–‡ä»¶ä¸­çš„ä¿¡æ¯ã€‚å°†è·å–åˆ°çš„ä¿¡æ¯å°è£…ä¸ºä¸€ä¸ªMapè¿”å›ã€‚åœ¨ä»mapä¸­é€šè¿‡ä¼ å…¥çš„ EnableAutoConfiguration.classå‚æ•°ï¼Œè·å–è¯¥keyä¸‹çš„æ‰€æœ‰å€¼ã€‚</p><p>å¯¹è·å–çš„AutoConfigurationEntryè¿›è¡Œè¿‡æ»¤ï¼Œè¿‡æ»¤çš„ä¾æ®æ˜¯æ¡ä»¶åŒ¹é…ã€‚é€šè¿‡org.springframework.boot.autoconfigure.AutoConfigurationImportFilterè¿‡æ»¤å™¨è¿›è¡Œè¿‡æ»¤ï¼Œåˆ†ä¸ºconfigurationsï¼Œexclusionsä¸¤ä¸ªé›†åˆã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> AutoConfigurationEntry <span class="title">getAutoConfigurationEntry</span><span class="params">(AutoConfigurationMetadata autoConfigurationMetadata,</span></span></span><br><span class="line"><span class="function"><span class="params">AnnotationMetadata annotationMetadata)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (!isEnabled(annotationMetadata)) &#123;</span><br><span class="line"><span class="keyword">return</span> EMPTY_ENTRY;</span><br><span class="line">&#125;</span><br><span class="line">AnnotationAttributes attributes = getAttributes(annotationMetadata);</span><br><span class="line">List&lt;String&gt; configurations = getCandidateConfigurations(annotationMetadata, attributes);</span><br><span class="line">configurations = removeDuplicates(configurations);</span><br><span class="line">Set&lt;String&gt; exclusions = getExclusions(annotationMetadata, attributes);</span><br><span class="line">checkExcludedClasses(configurations, exclusions);</span><br><span class="line">configurations.removeAll(exclusions);</span><br><span class="line">configurations = filter(configurations, autoConfigurationMetadata);</span><br><span class="line">fireAutoConfigurationImportEvents(configurations, exclusions);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> AutoConfigurationEntry(configurations, exclusions);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>&emsp;&emsp;SpringBootçš„è‡ªåŠ¨é…ç½®ä½“ç°äº†çº¦å®šå¤§äºé…ç½®çš„è®¾è®¡ç†å¿µã€‚å°†SpringBootéœ€è¦çš„jaråœ¨Spring.factoriesä¸­é…ç½®ã€‚é€šè¿‡SPIçš„è®¾è®¡æ¨¡å¼ï¼Œåœ¨æœåŠ¡å¯åŠ¨æ—¶ï¼Œç”¨ServiceLoaderè¿›è¡ŒåŠ è½½ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;å¹³æ—¶ä¸€ç›´åœ¨ä½¿ç”¨SpringBootï¼Œä½†æ˜¯æ²¡æœ‰è¿›å…¥æ·±å…¥çš„äº†è§£ï¼Œå…¬å¸éœ€è¦å¯¹åŸæœ‰çš„é¡¹ç›®æ”¹é€ å‡çº§ï¼Œå€Ÿç€è¿™ä¸ªæœºä¼šäº†è§£ä¸‹SpringBootçš„è‡ªåŠ¨åŠ è½½æœºåˆ¶ã€‚&lt;/p&gt;&lt;/blockquote&gt;
    
    </summary>
    
      <category term="Spring" scheme="http://yoursite.com/categories/Spring/"/>
    
    
      <category term="SpringBoot è‡ªåŠ¨é…ç½®" scheme="http://yoursite.com/tags/SpringBoot-%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE/"/>
    
  </entry>
  
  <entry>
    <title>è®°ä¸€æ¬¡æœåŠ¡å¯åŠ¨æ—¶å¤±è´¥çš„é—®é¢˜</title>
    <link href="http://yoursite.com/2019/06/03/work01/"/>
    <id>http://yoursite.com/2019/06/03/work01/</id>
    <published>2019-06-03T14:23:47.000Z</published>
    <updated>2020-05-10T11:36:12.066Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>è®°å½•ä¸€æ¬¡çº¿ä¸ŠaccountæœåŠ¡ç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶ï¼Œæœ‰æ•ˆè®¿é—®é˜»å¡ï¼Œå¯åŠ¨å¤±è´¥çš„é—®é¢˜ã€‚<a id="more"></a></p></blockquote><h4 id="èµ·å› "><a href="#èµ·å› " class="headerlink" title="èµ·å› "></a>èµ·å› </h4><p>&emsp;&emsp;åœ¨ä»Šå¤©ä¿®æ”¹äº†accountæœåŠ¡ä¹‹åï¼Œå‘å¸ƒåˆ°ç”Ÿäº§ä¹‹åï¼Œå‘ç°æºç¨‹çš„æŸ¥è¯¢è¯·æ±‚å…¨éƒ¨æŠ¥é”™ï¼Œé˜»å¡åœ¨äº†accountæœåŠ¡ä¸­ã€‚æˆ‘ä»¬å°±å¯¹é—®é¢˜è¿›è¡Œäº†æ’æŸ¥ã€‚é¦–å…ˆï¼Œé¢„ä¼°æœ‰è¿™ä¸ªåŸå› ï¼š</p><ol><li><p>RedisæŒ‚äº†ï¼Œçº¿ç¨‹æ± æ²¡æœ‰èµ·åˆ°ä½œç”¨ã€‚</p></li><li><p>åœ¨é‡æ–°å‘å¸ƒæ—¶ï¼Œä¾›åº”å•†ä¿¡æ¯æ²¡æœ‰å­˜æ”¾åœ¨ç¼“å­˜ä¸­ã€‚</p></li></ol><h4 id="é—®é¢˜æ’æŸ¥"><a href="#é—®é¢˜æ’æŸ¥" class="headerlink" title="é—®é¢˜æ’æŸ¥"></a>é—®é¢˜æ’æŸ¥</h4><p>&emsp;&emsp;æ£€æŸ¥ä»£ç ï¼Œå‘ç°ä»£ç æ²¡æœ‰é—®é¢˜ï¼ŒæŸ¥çœ‹redisçš„çº¿ç¨‹æ± è®¾è®¡ã€‚æˆ‘ä»¬ç”¨çš„redisçº¿ç¨‹æ± æ˜¯ç”¨çš„commons-poolã€‚æŸ¥çœ‹è·å–å¯¹è±¡çš„æ–¹æ³•ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">public T borrowObject() throws Exception &#123;</span><br><span class="line">        long starttime = System.currentTimeMillis();</span><br><span class="line">        GenericObjectPool.Latch&lt;T&gt; latch = new GenericObjectPool.Latch();</span><br><span class="line">        byte whenExhaustedAction;</span><br><span class="line">        long maxWait;</span><br><span class="line">        synchronized(this) &#123;</span><br><span class="line">            whenExhaustedAction = this._whenExhaustedAction;</span><br><span class="line">            maxWait = this._maxWait;</span><br><span class="line">            this._allocationQueue.add(latch);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        this.allocate();</span><br><span class="line"></span><br><span class="line">        while(true) &#123;</span><br><span class="line">        // æ·»åŠ åŒæ­¥é”</span><br><span class="line">            synchronized(this) &#123;</span><br><span class="line">                this.assertOpen();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (latch.getPair() == null &amp;&amp; !latch.mayCreate()) &#123;</span><br><span class="line">                switch(whenExhaustedAction) &#123;</span><br><span class="line">                case 0:</span><br><span class="line">                // åŒæ­¥é”</span><br><span class="line">                    synchronized(this) &#123;</span><br><span class="line">                        if (latch.getPair() == null &amp;&amp; !latch.mayCreate()) &#123;</span><br><span class="line">                            this._allocationQueue.remove(latch);</span><br><span class="line">                            throw new NoSuchElementException(&quot;Pool exhausted&quot;);</span><br><span class="line">                        &#125;</span><br><span class="line">                        break;</span><br><span class="line">                    &#125;</span><br><span class="line">                case 1:</span><br><span class="line">                    try &#123;</span><br><span class="line">                        synchronized(latch) &#123;</span><br><span class="line">                            if (latch.getPair() != null || latch.mayCreate()) &#123;</span><br><span class="line">                                break;</span><br><span class="line">                            &#125;</span><br><span class="line">                            </span><br><span class="line">                            // ç­‰å¾…æ—¶é—´</span><br><span class="line">                            if (maxWait &lt;= 0L) &#123;</span><br><span class="line">                                latch.wait();</span><br><span class="line">                            &#125; else &#123;</span><br><span class="line">                                long elapsed = System.currentTimeMillis() - starttime;</span><br><span class="line">                                long waitTime = maxWait - elapsed;</span><br><span class="line">                                if (waitTime &gt; 0L) &#123;</span><br><span class="line">                                    latch.wait(waitTime);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        if (this.isClosed()) &#123;</span><br><span class="line">                            throw new IllegalStateException(&quot;Pool closed&quot;);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; catch (InterruptedException var51) &#123;</span><br><span class="line">            ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è€Œæˆ‘ä»¬çš„é—®é¢˜å°±å‡ºç°åœ¨äº†è¿™ä¸ªç­‰å¾…æ—¶é—´çš„é—®é¢˜ä¸Šã€‚</p><p>&emsp;&emsp;å½“accountæœåŠ¡é‡æ–°å¯åŠ¨æ—¶ï¼Œredisä¼šä»çº¿ç¨‹æ± ä¸­è·å–redisè¿æ¥ã€‚è€Œåœ¨ç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶ï¼Œ<font color="red">redisPoolå®šä¹‰çš„æœ€å¤§èµ„æºæ•°ã€æœ€å°ç©ºé—²èµ„æºæ•°æ—¶ï¼Œä¸ä¼šçœŸçš„æŠŠJedisè¿æ¥æ”¾åˆ°è¿æ¥æ± é‡Œã€‚ç¬¬ä¸€æ¬¡ä½¿ç”¨æ—¶ï¼Œæ²¡æœ‰èµ„æºä½¿ç”¨ï¼Œä¼šå…ˆåˆ›å»ºä¸€ä¸ªæ–°çš„é“¾æ¥ï¼Œç„¶åæ”¾åˆ°æ± å­é‡Œï¼Œä¼šæœ‰ä¸€å®šçš„æ—¶é—´å¼€é”€ã€‚</font>è€Œåœ¨è¿™ä¸€æ®µæ—¶é—´é‡Œï¼Œæºç¨‹ç­‰OTAçš„æœç´¢é‡éå¸¸å¤§ï¼Œè¦åœ¨accountæœåŠ¡æŸ¥è¯¢å¤§é‡çš„ä¾›åº”å•†ä¿¡æ¯ï¼Œé€ æˆå µå¡ã€‚æ‰€ä»¥åœ¨accountæœåŠ¡å¯åŠ¨å‰3åˆ†é’Ÿæ—¶ï¼Œä¼šé€ æˆæºç¨‹çš„æœç´¢å¤±è´¥ç‡å¾ˆé«˜ï¼Œæœ‰æ—¶ç›´æ¥accountæœåŠ¡å¯åŠ¨å¤±è´¥ã€‚æ‰€ä»¥æˆ‘ä»¬è€ƒè™‘<font color="red">è¦åœ¨accountæœåŠ¡å¯åŠ¨æ—¶ï¼Œå…ˆè¦ä¸ºredisPoolè¿›è¡Œé¢„çƒ­ã€‚</font></p><p>&emsp;&emsp;æºç¨‹çš„æœºç¥¨æœç´¢ä¸€ç›´è°ƒç”¨accountæœåŠ¡ï¼Œä½†æ˜¯åªæ˜¯åœ¨accountæœåŠ¡æŸ¥è¯¢ä¾›åº”å•†çš„ä¿¡æ¯ï¼Œè€Œè¿™äº›ä¾›åº”å•†ä¿¡æ¯ä¸€èˆ¬éƒ½æ˜¯å›ºå®šçš„ã€‚æ‰€ä»¥æœ€åæˆ‘ä»¬å†³å®šä½¿ç”¨æœ¬åœ°ç¼“å­˜ã€‚åœ¨æ¯ä¸€ä¸ªå¯¹å¤–æŸ¥è¯¢æ¥å£è¿›è¡Œæ·»åŠ æœ¬åœ°ç¼“å­˜ï¼ŒåŒæ—¶ï¼Œä¸ºäº†é˜²æ­¢çªç„¶ä¿®æ”¹ä¾›åº”å•†ä¿¡æ¯ï¼Œéœ€è¦åˆ·æ–°æœ¬åœ°ç¼“å­˜ï¼Œæˆ‘ä»¬ä¿®æ”¹ä¾›åº”å•†ä¿¡æ¯æ—¶ä¼šé€šçŸ¥ç»™zookeeperï¼Œä¸€ä½†æœ¬åœ°ç¼“å­˜çš„ç¨‹åºå‘ç°ä¾›åº”å•†ä¿¡æ¯ä¿®æ”¹äº†ï¼Œä¼šè‡ªåŠ¨åˆ·æ–°æœ¬åœ°ç¼“å­˜ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;è®°å½•ä¸€æ¬¡çº¿ä¸ŠaccountæœåŠ¡ç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶ï¼Œæœ‰æ•ˆè®¿é—®é˜»å¡ï¼Œå¯åŠ¨å¤±è´¥çš„é—®é¢˜ã€‚&lt;/p&gt;&lt;/blockquote&gt;
    
    </summary>
    
      <category term="ç”Ÿäº§æ•…éšœ" scheme="http://yoursite.com/categories/%E7%94%9F%E4%BA%A7%E6%95%85%E9%9A%9C/"/>
    
    
      <category term="Redis" scheme="http://yoursite.com/tags/Redis/"/>
    
      <category term="Cache" scheme="http://yoursite.com/tags/Cache/"/>
    
  </entry>
  
  <entry>
    <title>åˆ†å¸ƒå¼äº‹åŠ¡å­¦ä¹ </title>
    <link href="http://yoursite.com/2019/04/29/tcc01/"/>
    <id>http://yoursite.com/2019/04/29/tcc01/</id>
    <published>2019-04-29T12:16:59.000Z</published>
    <updated>2020-06-10T13:22:59.568Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p> äº‹åŠ¡åœ¨åˆ†å¸ƒå¼æœåŠ¡ä¸­è‡³å…³é‡è¦ï¼Œæœ¬æ–‡ä¸»è¦å­¦ä¹ TCCä¸‰é˜¶æ®µçš„æµç¨‹ä¸æ¨¡å¼ã€‚äº†è§£XAæ¨¡å¼ã€‚<a id="more"></a></p></blockquote><h3 id="äº‹åŠ¡ç‰¹æ€§"><a href="#äº‹åŠ¡ç‰¹æ€§" class="headerlink" title="äº‹åŠ¡ç‰¹æ€§"></a>äº‹åŠ¡ç‰¹æ€§</h3><p>æ•°æ®åº“äº‹åŠ¡æ˜¯æŒ‡æ•°æ®åº“æ‰§è¡Œè¿‡ç¨‹ä¸­çš„ä¸€ä¸ªé€»è¾‘å•ä½ï¼Œç”±ä¸€ä¸ªæœ‰é™çš„æ•°æ®åº“æ“ä½œåºåˆ—æ„æˆã€‚</p><p>äº‹åŠ¡æœ‰ACIDå››ä¸ªç‰¹æ€§ï¼š</p><ol><li>åŸå­æ€§ï¼šäº‹åŠ¡ä½œä¸ºä¸€ä¸ªæ•´ä½“è¢«æ‰§è¡Œï¼ŒåŒ…æ‹¬åœ¨å…¶ä¸­çš„å¯¹æ•°æ®çš„æ“ä½œè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œè¦ä¹ˆå…¨éƒ¨è¢«æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œã€‚</li><li>ä¸€è‡´æ€§ï¼šäº‹åŠ¡åº”ç¡®ä¿æ•°æ®åº“çš„çŠ¶æ€ä»ä¸€ä¸ªä¸€è‡´çŠ¶æ€è½¬å˜ä¸ºå¦ä¸€ä¸ªä¸€è‡´çŠ¶æ€ã€‚ä¸€è‡´çŠ¶æ€æ˜¯æŒ‡æ•°æ®åº“ä¸­çš„æ•°æ®åº”è¯¥æ»¡è¶³å®Œæ•´æ€§çº¦æŸã€‚</li><li>éš”ç¦»æ€§ï¼šå¤šä¸ªäº‹åŠ¡å¹¶å‘æ‰§è¡Œæ—¶ï¼Œä¸€ä¸ªäº‹åŠ¡çš„æ‰§è¡Œä¸åº”å½±å“å…¶ä»–äº‹åŠ¡çš„æ‰§è¡Œï¼Œå¦‚åŒåªæœ‰è¿™ä¸€ä¸ªæ“ä½œåœ¨è¢«æ•°æ®åº“æ‰€æ‰§è¡Œä¸€æ ·ã€‚</li><li>æŒä¹…æ€§ï¼šå·²è¢«æäº¤çš„äº‹åŠ¡å¯¹æ•°æ®åº“çš„ä¿®æ”¹åº”è¯¥æ°¸ä¹…ä¿å­˜åœ¨æ•°æ®åº“ä¸­ã€‚åœ¨äº‹åŠ¡ç»“æŸæ—¶ï¼Œæ­¤æ“ä½œä¸å¯é€†è½¬ã€‚</li></ol><h3 id="åˆ†å¸ƒå¼äº‹åŠ¡"><a href="#åˆ†å¸ƒå¼äº‹åŠ¡" class="headerlink" title="åˆ†å¸ƒå¼äº‹åŠ¡"></a>åˆ†å¸ƒå¼äº‹åŠ¡</h3><h4 id="XAåè®®"><a href="#XAåè®®" class="headerlink" title="XAåè®®"></a>XAåè®®</h4><p>XAåè®®ç”±Tuxedoé¦–å…ˆæå‡ºï¼Œå¹¶äº¤ç»™X/Openç»„ç»‡ï¼Œä½œä¸ºèµ„æºç®¡ç†å™¨ï¼ˆæ•°æ®åº“ï¼‰ä¸äº‹åŠ¡ç®¡ç†å™¨çš„æ¥å£æ ‡å‡†ã€‚XAåè®®é‡‡ç”¨ä¸¤é˜¶æ®µæäº¤çš„æ–¹å¼æ¥ç®¡ç†åˆ†å¸ƒå¼äº‹åŠ¡ã€‚XAæ¥å£æä¾›èµ„æºç®¡ç†å™¨ä¸äº‹åŠ¡ç®¡ç†å™¨ä¹‹é—´è¿›è¡Œé€šä¿¡çš„æ ‡å‡†äº¤å£ã€‚</p><p>èµ„æºç®¡ç†å™¨ï¼ˆRMï¼‰ï¼šèµ„æºç®¡ç†å™¨æä¾›å¯¹äº‹åŠ¡æ€§èµ„æºçš„è®¿é—®ã€‚æ•°æ®åº“å…¶å®å°±æ˜¯ä¸€ç§èµ„æºç®¡ç†å™¨ï¼Œå¿…é¡»æäº¤æˆ–è€…å›æ»šç”±RMç®¡ç†çš„äº‹åŠ¡ã€‚</p><p>äº‹åŠ¡ç®¡ç†å™¨ï¼ˆTMï¼‰ï¼šä¸»è¦åè°ƒä½œä¸ºå…¨å±€äº‹åŠ¡ä¸­çš„éƒ¨åˆ†äº‹åŠ¡ã€‚å®ƒä½œä¸ºRMSä¸­æ¯ä¸ªäº‹åŠ¡çš„åè°ƒè€…ã€‚</p><p>æ‰§è¡Œå…¨å±€äº‹åŠ¡çš„è¿‡ç¨‹é‡‡ç”¨ä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰ï¼Œå…¨å±€äº‹åŠ¡æ˜¯å‘ç”Ÿåœ¨åˆ†æ”¯æ‰§è¡Œçš„æ“ä½œä¹‹åçš„ï¼š</p><p>ç¬¬ä¸€é˜¶æ®µï¼šæ‰€æœ‰åˆ†æ”¯çš„æ“ä½œéƒ½å‡†å¤‡å¥½äº†ï¼Œç”±TMå‘ŠçŸ¥æ¯ä¸ªåˆ†æ”¯å‡†å¤‡æäº¤ï¼Œæ­¤æ—¶ï¼Œä½œä¸ºå…¨å±€äº‹åŠ¡ä¸­çš„æ¯ä¸ªRMè®°å½•ç€åœ¨ç¨³å®šå­˜å‚¨ä¸­çš„åŠ¨ä½œã€‚</p><p>ç¬¬äºŒé˜¶æ®µï¼šTMä¼šå‘Šè¯‰RMSæ˜¯å¦æäº¤æˆ–å›æ»šï¼Œå¦‚æœæ‰€æœ‰åˆ†æ”¯è¡¨æ˜å‡†å¤‡å¥½èƒ½å¤Ÿæäº¤æ—¶ï¼ŒRMSä¼šè¢«å‘ŠçŸ¥æäº¤ï¼Œå¦‚æœä»»ä½•ä¸€ä¸ªRMè¡¨æ˜æ²¡æœ‰å‡†å¤‡å¥½æˆ–è€…ä¸èƒ½æäº¤ï¼Œåˆ™è¿›è¡Œå…¨éƒ¨å›æ»šã€‚</p><p><img src="/2019/04/29/tcc01/xa.png" alt="ä¸¤é˜¶æ®µæ›´æ–°"></p><h4 id="TCCæäº¤"><a href="#TCCæäº¤" class="headerlink" title="TCCæäº¤"></a>TCCæäº¤</h4><p>TCC(Try-Confirm-Cancel)åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å‹ç›¸å¯¹äºXAç­‰ä¼ ç»Ÿæ¨¡å‹ï¼Œå…¶ç‰¹å¾åœ¨äºå®ƒä¸ä¾èµ–èµ„æºç®¡ç†å™¨ï¼ˆRMï¼‰å¯¹åˆ†å¸ƒå¼äº‹åŠ¡çš„æ”¯æŒï¼Œè€Œæ˜¯é€šè¿‡å¯¹ä¸šåŠ¡é€»è¾‘çš„åˆ†è§£æ¥å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ã€‚</p><p>åˆæ­¥æ“ä½œTryï¼šå®Œæˆæ‰€æœ‰ä¸šåŠ¡æ£€æŸ¥ï¼Œé¢„ç•™å¿…é¡»çš„ä¸šåŠ¡èµ„æºã€‚</p><p>ç¡®è®¤æ“ä½œConfirmï¼šçœŸæ­£æ‰§è¡Œçš„ä¸šåŠ¡é€»è¾‘ï¼Œä¸åœ¨ä»»åŠ¡ä¸šåŠ¡æ£€æŸ¥ï¼Œåªä½¿ç”¨Tryé˜¶æ®µé¢„ç•™çš„ä¸šåŠ¡èµ„æºã€‚å› æ­¤ï¼Œåªè¦Tryæ“ä½œæˆåŠŸï¼ŒConfirmå¿…é¡»èƒ½æˆåŠŸã€‚å¦å¤–ï¼ŒConfirmæ“ä½œéœ€æ»¡è¶³å¹‚ç­‰æ€§ï¼Œä¿è¯ä¸€ç¬”åˆ†å¸ƒå¼äº‹åŠ¡åˆä¸”åªèƒ½æˆåŠŸä¸€æ¬¡ã€‚</p><p>å–æ¶ˆæ“ä½œCancelï¼šé‡Šæ”¾Tryé˜¶æ®µé¢„ç•™çš„ä¸šåŠ¡èµ„æºã€‚åŒæ ·çš„ï¼ŒCancelæ“ä½œä¹Ÿéœ€è¦æ»¡è¶³å¹‚ç­‰æ€§ã€‚</p><p><img src="/2019/04/29/tcc01/tcc.png" alt="ä¸‰é˜¶æ®µæäº¤æ¨¡å‹ï¼ˆè½¬è‡ªç½‘ä¸Šï¼‰"></p><p>TCCåˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å‹åŒ…æ‹¬ä¸‰éƒ¨åˆ†ï¼š</p><ol><li>ä¸»ä¸šåŠ¡æœåŠ¡ï¼šä¸»ä¸šåŠ¡æœåŠ¡ä¸ºæ•´ä¸ªä¸šåŠ¡æ´»åŠ¨çš„å‘èµ·æ–¹ï¼ŒæœåŠ¡çš„ç¼–æ’è€…ï¼Œè´Ÿè´£å‘èµ·å¹¶å®Œæˆæ•´ä¸ªä¸šåŠ¡æ´»åŠ¨ã€‚</li><li>ä»ä¸šåŠ¡æœåŠ¡ï¼šä»ä¸šåŠ¡æœåŠ¡æ˜¯æ•´ä¸ªä¸šåŠ¡æ´»åŠ¨çš„å‚ä¸æ–¹ï¼Œè´Ÿè´£æä¾›TCCä¸šåŠ¡æ“ä½œï¼Œå®ç°åˆæ­¥æ“ä½œï¼ˆTryï¼‰ï¼Œç¡®è®¤æ“ä½œï¼ˆConfirmï¼‰ã€å–æ¶ˆæ“ä½œï¼ˆCancelï¼‰ä¸‰ä¸ªå€Ÿå£ï¼Œä¾›ä¸»ä¸šåŠ¡æœåŠ¡è°ƒç”¨ã€‚</li><li>ä¸šåŠ¡æ´»åŠ¨ç®¡ç†å™¨ï¼šä¸šåŠ¡æ´»åŠ¨ç®¡ç†å™¨ç®¡ç†æ§åˆ¶æ•´ä¸ªä¸šåŠ¡æ´»åŠ¨ï¼ŒåŒ…æ‹¬è®°å½•ç»´æŠ¤TCCå…¨å±€äº‹åŠ¡çš„äº‹åŠ¡çŠ¶æ€å’Œæ¯ä¸ªä»ä¸šåŠ¡æœåŠ¡çš„å­äº‹åŠ¡çŠ¶æ€ï¼Œå¹¶åœ¨ä¸šåŠ¡æ´»åŠ¨æäº¤æ—¶è°ƒç”¨æ‰€æœ‰ä»ä¸šåŠ¡æœåŠ¡çš„Confirmæ“ä½œï¼Œåœ¨ä¸šåŠ¡æ´»åŠ¨å–æ¶ˆè°ƒç”¨æ‰€æœ‰ä»ä¸šåŠ¡æœåŠ¡çš„Cancelæ“ä½œã€‚</li></ol><p>TCCåˆ†å¸ƒå¼äº‹åŠ¡æµç¨‹ï¼š</p><ol><li>ä¸»ä¸šåŠ¡æœåŠ¡é¦–å…ˆå¼€å¯æœ¬åœ°äº‹åŠ¡ã€‚</li><li>ä¸»ä¸šåŠ¡æœåŠ¡å‘ä¸šåŠ¡æ´»åŠ¨ç®¡ç†å™¨ç”³è¯·å¯åŠ¨åˆ†å¸ƒå¼äº‹åŠ¡ä¸šåŠ¡æ´»åŠ¨ã€‚</li><li>ç„¶åé’ˆå¯¹è¦è°ƒç”¨çš„ä»ä¸šåŠ¡æœåŠ¡ï¼Œä¸»ä¸šåŠ¡æ´»åŠ¨å…ˆå‘ä¸šåŠ¡æ´»åŠ¨ç®¡ç†å™¨æ³¨å†Œä¸šåŠ¡æ´»åŠ¨ï¼Œç„¶åè°ƒç”¨ä»ä¸šåŠ¡æœåŠ¡çš„Tryæ¥å£ï¼›</li><li>å½“æ‰€æœ‰ä»ä¸šåŠ¡æœåŠ¡çš„Tryæ¥å£è°ƒç”¨æˆåŠŸï¼Œä¸»ä¸šåŠ¡æœåŠ¡æäº¤æœ¬åœ°äº‹åŠ¡ï¼›è‹¥è°ƒç”¨å¤±è´¥ï¼Œä¸»ä¸šåŠ¡æœåŠ¡å›æ»šæœ¬åœ°äº‹åŠ¡ã€‚</li><li>è‹¥ä¸»ä¸šåŠ¡æœåŠ¡æäº¤æœ¬åœ°äº‹åŠ¡ï¼Œåˆ™TCCæ¨¡å‹åˆ†åˆ«è°ƒç”¨æ‰€æœ‰ä»ä¸šåŠ¡æœåŠ¡çš„Confirmæ¥å£ï¼›è‹¥ä¸»ä¸šåŠ¡æœåŠ¡å›æ»šæœ¬åœ°äº‹åŠ¡ï¼Œåˆ™åˆ†åˆ«è°ƒç”¨Cancelæ¥å£ï¼›</li><li>æ‰€æœ‰ä»ä¸šåŠ¡æœåŠ¡çš„Confirmæˆ–Cancelæ“ä½œå®Œæˆåï¼Œå…¨å±€äº‹åŠ¡ç»“æŸã€‚</li></ol><h3 id="ä¾‹å­"><a href="#ä¾‹å­" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h3><p>å†™äº†ä¸€ä¸ªä¾‹å­ç”¨æ¥å­¦ä¹ TCCï¼Œåœ°å€ï¼š<a href="https://github.com/yosamaru/tccDemo" target="_blank" rel="noopener">https://github.com/yosamaru/tccDemo</a></p>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt; äº‹åŠ¡åœ¨åˆ†å¸ƒå¼æœåŠ¡ä¸­è‡³å…³é‡è¦ï¼Œæœ¬æ–‡ä¸»è¦å­¦ä¹ TCCä¸‰é˜¶æ®µçš„æµç¨‹ä¸æ¨¡å¼ã€‚äº†è§£XAæ¨¡å¼ã€‚&lt;/p&gt;&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="TCC" scheme="http://yoursite.com/tags/TCC/"/>
    
  </entry>
  
  <entry>
    <title>Redisäº‹ä»¶æœºåˆ¶</title>
    <link href="http://yoursite.com/2019/04/25/redisEvent1/"/>
    <id>http://yoursite.com/2019/04/25/redisEvent1/</id>
    <published>2019-04-25T14:05:23.000Z</published>
    <updated>2020-05-10T11:36:12.058Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>Redisæœ‰ä¸¤ç±»äº‹ä»¶ï¼šæ–‡ä»¶äº‹ä»¶å’Œæ—¶é—´äº‹ä»¶ï¼Œè¿™ä¸¤ä¸ªäº‹ä»¶ç»„æˆäº†Redisçš„æœåŠ¡å™¨çš„äº‹ä»¶é©±åŠ¨ç¨‹åºã€‚<a id="more"></a>  </p></blockquote><h3 id="æ–‡ä»¶äº‹ä»¶"><a href="#æ–‡ä»¶äº‹ä»¶" class="headerlink" title="æ–‡ä»¶äº‹ä»¶"></a>æ–‡ä»¶äº‹ä»¶</h3><p>RedisåŸºäºReactoræ¨¡å¼å¼€å‘äº†è‡ªå·±çš„ç½‘ç»œæ—¶é—´å¤„ç†å™¨ï¼šè¿™ä¸ªå¤„ç†å™¨è¢«ç§°ä¸ºæ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ã€‚</p><p>æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ä½¿ç”¨I/Oå¤šè·¯å¤ç”¨ç¨‹åºæ¥åŒæ—¶ç›‘å¬å¤šä¸ªå¥—æ¥å­—ï¼Œå¹¶æ ¹æ®å¥—æ¥å­—ç›®å‰æ‰§è¡Œçš„ä»»åŠ¡æ¥ä¸ºå¥—æ¥å­—å…³è”ä¸åŒçš„æ—¶é—´å¤„ç†å™¨ã€‚</p><p>å½“è¢«ç›‘å¬çš„å¥—æ¥å­—å‡†å¤‡å¥½æ‰§è¡Œè¿ç»“åº”ç­”ï¼ˆacceptï¼‰è¯»å–ï¼ˆreadï¼‰å†™å…¥ï¼ˆwriteï¼‰å…³é—­ï¼ˆcloseï¼‰ç­‰æ“ä½œæ—¶ï¼Œä¸æ“ä½œç›¸å¯¹åº”çš„æ–‡ä»¶äº‹ä»¶å°±ä¼šäº§ç”Ÿï¼Œè¿™æ—¶æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨å°±ä¼šè°ƒç”¨å¥—æ¥å­—ä¹‹å‰å…³è”å¥½çš„äº‹ä»¶å¤„ç†å™¨æ¥å¤„ç†è¿™äº›äº‹ä»¶ã€‚</p><p><img src="/2019/04/25/redisEvent1/FileEvent.png" alt="&#39;æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨çš„å››ä¸ªç»„æˆéƒ¨åˆ†&#39;"></p><p>å°½ç®¡å¤šä¸ªæ–‡ä»¶äº‹ä»¶å¯èƒ½ä¼šå¹¶å‘åœ°å‡ºç°ï¼Œä½†I/Oå¤šè·¯å¤ç”¨ç¨‹åºæ€»æ˜¯ä¼šå°†æ‰€æœ‰äº§ç”Ÿäº‹ä»¶çš„å¥—æ¥å­—éƒ½æ”¾åˆ°ä¸€ä¸ªé˜Ÿåˆ—é‡Œé¢ï¼Œç„¶åé€šè¿‡è¿™ä¸ªé˜Ÿåˆ—ï¼Œä»¥æœ‰åºã€åŒæ­¥ã€æ¯æ¬¡ä¸€ä¸ªå¥—æ¥å­—çš„æ–¹å¼å‘æ–‡ä»¶äº‹ä»¶åˆ†æ´¾å™¨ä¼ é€å¥—æ¥å­—ã€‚</p><p>æ–‡ä»¶äº‹ä»¶åˆ†æ´¾å™¨æ¥å—I/Oå¤šè·¯å¤ç”¨ç¨‹åºä¼ æ¥çš„å¥—æ¥å­—ï¼Œå¹¶æ ¹æ®å¥—æ¥å­—äº§ç”Ÿçš„äº‹ä»¶çš„ç±»å‹ï¼Œè°ƒç”¨ç›¸åº”çš„äº‹ä»¶å¤„ç†å™¨ã€‚</p><h3 id="æ—¶é—´äº‹ä»¶"><a href="#æ—¶é—´äº‹ä»¶" class="headerlink" title="æ—¶é—´äº‹ä»¶"></a>æ—¶é—´äº‹ä»¶</h3><p>Redisçš„æ—¶é—´äº‹ä»¶åˆ†ä¸ºä»¥ä¸‹ä¸¤ç±»ï¼š</p><p>å®šæ—¶äº‹ä»¶ï¼šè®©ä¸€æ®µç¨‹åºåœ¨æŒ‡å®šçš„æ—¶é—´ä¹‹åæ‰§è¡Œä¸€æ¬¡ã€‚<br>å‘¨æœŸäº‹ä»¶ï¼šè®©ä¸€æ®µç¨‹åºæ¯éš”æŒ‡å®šæ—¶é—´å°±æ‰§è¡Œä¸€æ¬¡ã€‚</p><p>æœåŠ¡å™¨å°†æ‰€æœ‰æ—¶é—´äº‹ä»¶éƒ½æ”¾åœ¨ä¸€ä¸ªæ— åºé“¾è¡¨ä¸­ï¼Œæ¯å½“æ—¶é—´äº‹ä»¶æ‰§è¡Œå™¨è¿è¡Œæ—¶ï¼Œå®ƒå°±éå†æ•´ä¸ªé“¾è¡¨ï¼ŒæŸ¥æ‰¾æ‰€æœ‰å·²åˆ°è¾¾çš„æ—¶é—´äº‹ä»¶ï¼Œå¹¶è°ƒç”¨ç›¸åº”çš„äº‹ä»¶å¤„ç†å™¨ã€‚</p><p><img src="/2019/04/25/redisEvent1/Event.png" alt="äº‹ä»¶å¤„ç†è§’åº¦ä¸‹çš„æœåŠ¡å™¨è¿è¡Œæµç¨‹"></p><p>æ—¶é—´äº‹ä»¶çš„è¿ç”¨å®ä¾‹ï¼šserverCronå‡½æ•°ï¼Œå®ƒçš„ä¸»è¦å·¥ä½œåŒ…æ‹¬ï¼š</p><ol><li>æ›´æ–°æœåŠ¡å™¨çš„å„ç±»ç»Ÿè®¡ä¿¡æ¯ï¼Œæ¯”å¦‚ï¼šæ—¶é—´ã€å†…å­˜å ç”¨ã€æ•°æ®åº“å ç”¨æƒ…å†µç­‰ã€‚</li><li>æ¸…ç†æ•°æ®åº“ä¸­çš„è¿‡æœŸé”®å€¼å¯¹ã€‚</li><li>å…³é—­æ¸…ç†è¿æ¥å¤±æ•ˆçš„å®¢æˆ·ç«¯ã€‚</li><li>å°è¯•è¿›è¡ŒAOFæˆ–RDBä¹‹ä¹…åŒ–æ“ä½œã€‚</li><li>å¦‚æœæœåŠ¡å™¨æ˜¯ä¸»æœåŠ¡å™¨ï¼Œå¯¹ä»æœåŠ¡å™¨è¿›è¡Œå®šæœŸåŒæ­¥ã€‚</li><li>å¦‚æœå¤„äºé›†ç¾¤æ¨¡å¼ï¼Œå¯¹é›†ç¾¤è¿›è¡Œå®šæœŸåŒæ­¥å’Œè¿æ¥æµ‹è¯•ã€‚</li></ol><p>æ–‡ä»¶äº‹ä»¶å’Œæ—¶é—´äº‹ä»¶æ˜¯åˆä½œå…³ç³»ï¼ŒæœåŠ¡å™¨ä¼šè½®æµå¤„ç†è¿™ä¸¤ç§äº‹ä»¶ï¼Œå¹¶ä¸”å¤„ç†äº‹ä»¶çš„è¿‡ç¨‹ä¸­ä¸ä¼šè¿›è¡ŒæŠ¢å ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;Redisæœ‰ä¸¤ç±»äº‹ä»¶ï¼šæ–‡ä»¶äº‹ä»¶å’Œæ—¶é—´äº‹ä»¶ï¼Œè¿™ä¸¤ä¸ªäº‹ä»¶ç»„æˆäº†Redisçš„æœåŠ¡å™¨çš„äº‹ä»¶é©±åŠ¨ç¨‹åºã€‚&lt;/p&gt;&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="Redis Event" scheme="http://yoursite.com/tags/Redis-Event/"/>
    
  </entry>
  
  <entry>
    <title>çº¿ç¨‹æ± å‚æ•°åˆ†æ</title>
    <link href="http://yoursite.com/2019/03/06/threadpool1/"/>
    <id>http://yoursite.com/2019/03/06/threadpool1/</id>
    <published>2019-03-05T23:51:52.000Z</published>
    <updated>2020-05-10T11:36:12.066Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>ä¸€ç›´åœ¨ä½¿ç”¨çº¿ç¨‹æ± åˆ›å»ºçº¿ç¨‹ï¼Œä½†æ˜¯çº¿ç¨‹æ± çš„å‚æ•°æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿ<a id="more"></a></p></blockquote><h4 id="å‚æ•°æ¦‚å¿µ"><a href="#å‚æ•°æ¦‚å¿µ" class="headerlink" title="å‚æ•°æ¦‚å¿µ"></a>å‚æ•°æ¦‚å¿µ</h4><ol><li>corePoolSizeï¼šçº¿ç¨‹æ± ä¸­ä¸€ç›´å­˜æ´»è€…çš„çº¿ç¨‹çš„æœ€å°æ•°é‡ã€‚</li><li>maximumPoolSizeï¼šçº¿ç¨‹æ± å†…èƒ½å¤Ÿå®¹çº³çº¿ç¨‹æ•°é‡çš„æœ€å¤§å€¼ï¼Œä½†æ˜¯å¦‚æœæä¾›çš„é˜»å¡é˜Ÿåˆ—ï¼ˆä¹Ÿå°±æ˜¯å‚æ•°workQueueï¼‰æ˜¯ä¸€ä¸ªæ— ç•Œé˜Ÿåˆ—ï¼Œé‚£ä¹ˆæä¾›çš„maximumPoolSizeçš„æ•°å€¼å°†æ¯«æ— æ„ä¹‰ã€‚</li><li>keepAliveTimeï¼šç©ºé—²çº¿ç¨‹å¤„äºç­‰å¾…çŠ¶æ€çš„è¶…æ—¶æ—¶é—´ã€‚å¦‚æœæ‰§è¡Œçš„ä»»åŠ¡ç›¸å¯¹è¾ƒå¤šï¼Œå¹¶ä¸”æ¯ä¸ªä»»åŠ¡æ‰§è¡Œçš„æ—¶é—´æ¯”è¾ƒçŸ­ï¼Œé‚£ä¹ˆå¯ä»¥ä¸ºè¯¥å‚æ•°è®¾ç½®ä¸€ä¸ªç›¸å¯¹è¾ƒå¤§çš„æ•°å€¼ï¼Œä»¥æé«˜çº¿ç¨‹çš„åˆ©ç”¨ç‡ã€‚å¦‚æœæ‰§è¡Œçš„ä»»åŠ¡ç›¸å¯¹è¾ƒå°‘ï¼Œçº¿ç¨‹æ± ä½¿ç”¨ç‡ç›¸å¯¹è¾ƒä½ï¼Œé‚£ä¹ˆå¯ä»¥å…ˆå°†å‚æ•°è®¾ç½®ä¸ºä¸€ä¸ªè¾ƒå°çš„æ•°å€¼ï¼Œé€šè¿‡è¶…æ—¶åœæ­¢çš„æœºåˆ¶æ¥é™ä½ç³»ç»Ÿçº¿ç¨‹èµ„æºçš„å¼€é”€ï¼Œåç»­å¦‚æœå‘ç°çº¿ç¨‹æ± çš„ä½¿ç”¨ç‡é€æ¸å¢é«˜ä»¥åï¼Œçº¿ç¨‹æ± ä¼šæ ¹æ®å½“å‰è°ƒæ•™çš„ä»»åŠ¡æ•°è‡ªåŠ¨åˆ›å»ºæ–°çš„çº¿ç¨‹ï¼Œå½“ç„¶ï¼Œä¹Ÿå¯ä»¥æ‰‹åŠ¨è°ƒç”¨setKeepAliveTimeï¼ˆlongï¼Œ TimeUnit)æ–¹æ³•æ¥é‡æ–°è®¾å®škeepAliveTimeå­—æ®µçš„å€¼ã€‚</li><li>workQueueï¼šworkQueueæ˜¯ä¸€ä¸ªå†…éƒ¨å…ƒç´ ä¸ºRunable(å„ç§ä»»åŠ¡ï¼Œé€šå¸¸æ˜¯å¼‚æ­¥ä»»åŠ¡)çš„é˜»å¡é˜Ÿåˆ—ã€‚é˜»å¡é˜Ÿåˆ—æ˜¯ä¸€ç§ç±»ä¼¼äºâ€œç”Ÿäº§è€…-æ¶ˆè´¹è€…â€æ¨¡å‹çš„é˜Ÿåˆ—ã€‚å½“é˜Ÿåˆ—å·²æ»¡æ—¶å¦‚æœç»§ç»­å‘é˜Ÿåˆ—ä¸­æ’å…¥å…ƒç´ ï¼Œè¯¥æ’å…¥æ“ä½œå°†è¢«é˜»å¡ä¸€ç›´å¤„äºç­‰å¾…çŠ¶æ€ï¼ŒçŸ¥é“é˜Ÿåˆ—ä¸­æœ‰å…ƒç´ è¢«ç§»é™¤äº§ç”Ÿç©ºä½å­åï¼Œæ‰æœ‰å¯èƒ½æ‰§è¡Œè¿™æ¬¡æ’å…¥æ“ä½œï¼›å½“é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œå¦‚æœç»§ç»­æ‰§è¡Œå…ƒç´ çš„åˆ é™¤æˆ–è·å–æ“ä½œï¼Œè¯¥æ“ä½œåŒæ ·ä¼šè¢«é˜»å¡è€Œè¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œç›´åˆ°é˜Ÿåˆ—ä¸­åˆæœ‰äº†è¯¥å…ƒç´ åï¼Œæ‰èƒ½æ‰§è¡Œè¯¥æ“ä½œã€‚</li></ol><h4 id="çº¿ç¨‹æ± æ“ä½œ"><a href="#çº¿ç¨‹æ± æ“ä½œ" class="headerlink" title="çº¿ç¨‹æ± æ“ä½œ"></a>çº¿ç¨‹æ± æ“ä½œ</h4><ol><li>å¦‚æœçº¿ç¨‹æ± ä¸­æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°å°‘äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œé‚£ä¹ˆçº¿ç¨‹æ± æ€»æ˜¯å€¾å‘äºåˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹æ¥æ‰§è¡Œè¯¥ä»»åŠ¡ï¼Œè€Œä¸æ˜¯å°†è¯¥ä»»åŠ¡æäº¤åˆ°è¯¥é˜Ÿåˆ—workQueueä¸­è¿›è¡Œç­‰å¾…ã€‚</li><li>å¦‚æœçº¿ç¨‹æ± ä¸­æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°ä¸å°‘äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œé‚£ä¹ˆçº¿ç¨‹æ± æ€»æ˜¯å€¾å‘äºå°†è¯¥ä»»åŠ¡æäº¤åˆ°é˜Ÿåˆ—workQueueä¸­å…ˆè®©å…¶ç­‰å¾…ï¼Œè€Œä¸æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹æ¥æ‰§è¡Œè¯¥ä»»åŠ¡ã€‚</li><li>å¦‚æœçº¿ç¨‹æ± ä¸­æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°ä¸å°‘äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå¹¶ä¸”çº¿ç¨‹æ± ä¸­çš„é˜»å¡é˜Ÿåˆ—ä¹Ÿæ»¡äº†ä½¿å¾—è¯¥ä»»åŠ¡å…¥é˜Ÿå¤±è´¥ï¼Œé‚£ä¹ˆçº¿ç¨‹æ± ä¼šå»åˆ¤æ–­å½“å‰æ± å­ä¸­è¿è¡Œçš„çº¿ç¨‹æ•°æ˜¯å¦å·²ç»ç­‰äºäº†è¯¥çº¿ç¨‹æ± å…è®¸è¿è¡Œçš„æœ€å¤§çº¿ç¨‹æ•°maximumPoolSizeï¼Œå¦‚æœå‘ç°å·²ç»ç­‰äºäº†ï¼Œè¯´æ˜çº¿ç¨‹æ± å·²æ»¡ï¼Œæ— æ³•åœ¨ç»§ç»­åˆ›å»ºæ–°çš„çº¿ç¨‹äº†ï¼Œé‚£ä¹ˆå°±ä¼šæ‹’ç»æ‰§è¡Œè¯¥ä»»åŠ¡ã€‚å¦‚æœå‘ç°è¿è¡Œçš„çº¿ç¨‹æ•°å°äºæ± å­å…è®¸çš„æœ€å¤§çº¿ç¨‹æ•°ï¼Œé‚£ä¹ˆå°±ä¼šåˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼ˆåˆ›å»ºçš„çº¿ç¨‹æ˜¯éæ ¸å¿ƒçº¿ç¨‹ï¼‰æ¥æ‰§è¡Œè¯¥ä»»åŠ¡ã€‚</li></ol>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;ä¸€ç›´åœ¨ä½¿ç”¨çº¿ç¨‹æ± åˆ›å»ºçº¿ç¨‹ï¼Œä½†æ˜¯çº¿ç¨‹æ± çš„å‚æ•°æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿ&lt;/p&gt;&lt;/blockquote&gt;
    
    </summary>
    
      <category term="çº¿ç¨‹æ± " scheme="http://yoursite.com/categories/%E7%BA%BF%E7%A8%8B%E6%B1%A0/"/>
    
    
      <category term="çº¿ç¨‹æ± å‚æ•°" scheme="http://yoursite.com/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%8F%82%E6%95%B0/"/>
    
  </entry>
  
  <entry>
    <title>RocketMQäº‹åŠ¡æ¶ˆæ¯çŸ¥æ‚‰</title>
    <link href="http://yoursite.com/2018/12/01/rocketmq2/"/>
    <id>http://yoursite.com/2018/12/01/rocketmq2/</id>
    <published>2018-12-01T14:14:23.000Z</published>
    <updated>2020-05-10T11:36:12.063Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>RocketMQçš„äº‹åŠ¡æ¶ˆæ¯ç”¨é€”å¹¿æ³›ï¼Œä¹Ÿæ˜¯å¾ˆå¤šäººæ¶ˆæ¯ä¸­é—´ä»¶é€‰æ‹©RocketMQçš„ä¸€ä¸ªé‡è¦åŸå› ã€‚<a id="more"></a></p></blockquote><h4 id="äº‹åŠ¡æ¶ˆæ¯"><a href="#äº‹åŠ¡æ¶ˆæ¯" class="headerlink" title="äº‹åŠ¡æ¶ˆæ¯"></a>äº‹åŠ¡æ¶ˆæ¯</h4><p>RocketMQçš„äº‹åŠ¡æ¶ˆæ¯é˜Ÿåˆ—æä¾›ç±»ä¼¼X/Open XAçš„åˆ†å¸ƒå¼äº‹åŠ¡åŠŸèƒ½ï¼Œé€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—RocketMQäº‹åŠ¡æ¶ˆæ¯èƒ½è¾¾åˆ°åˆ†å¸ƒå¼äº‹åŠ¡çš„æœ€ç»ˆä¸€è‡´ã€‚</p><p>åŠæ¶ˆæ¯ï¼šæš‚ä¸èƒ½æŠ•æ•Œçš„æ¶ˆæ¯ï¼Œå‘é€æ–¹å·²ç»å°†æ¶ˆæ¯æˆåŠŸåœ°å‘é€åˆ°äº†æ¶ˆæ¯é˜Ÿåˆ—RocketMQæœåŠ¡æ®µï¼Œä½†æ˜¯æœåŠ¡ç«¯æœªæ”¶åˆ°ç”Ÿäº§ç€å¯¹è¯¥æ¶ˆæ¯çš„äºŒæ¬¡ç¡®è®¤ï¼Œæ­¤æ—¶è¯¥æ¶ˆæ¯è¢«æ ‡è®°æˆâ€œæš‚ä¸èƒ½æŠ•é€’â€çŠ¶æ€ï¼Œå¤„äºè¯¥ç§çŠ¶æ€ä¸‹çš„æ¶ˆæ¯å³ä¸ºåŠæ¶ˆæ¯ï¼Œ</p><p>æ¶ˆæ¯å›æŸ¥ï¼šç”±äºç½‘ç»œé—ªæ–­ã€ç”Ÿäº§è€…åº”ç”¨é‡å¯ç­‰åŸå› ï¼Œå¯¼è‡´æŸæ¡äº‹åŠ¡æ¶ˆæ¯çš„äºŒæ¬¡ç¡®è®¤ä¸¢å¤±ï¼Œæ¶ˆæ¯é˜Ÿåˆ—RocketMQæœåŠ¡ç«¯é€šè¿‡æ‰«æå‘ç°æŸæ¡æ¶ˆæ¯é•¿æœŸå¤„äºâ€œåŠæ¶ˆæ¯â€æ—¶ï¼Œéœ€è¦ä¸»åŠ¨å‘æ¶ˆæ¯ç”Ÿäº§è€…è¯¢é—®è¯¥æ¶ˆæ¯çš„æœ€ç»ˆçŠ¶æ€ï¼ˆCommitæˆ–æ˜¯Rollbackï¼‰ï¼Œæ­¤è¿‡ç¨‹å³ä¸ºæ¶ˆæ¯å›æŸ¥ã€‚</p><p><img src="/2018/12/01/rocketmq2/rocketmq2.png" alt="RocketMQäº‹åŠ¡æµç¨‹"></p><ol><li>å‘é€æ–¹å‘æ¶ˆæ¯é˜Ÿåˆ—RocketMQæœåŠ¡ç«¯å‘é€æ¶ˆæ¯ã€‚</li><li><p>æœåŠ¡ç«¯å°†æ¶ˆæ¯æŒä¹…åŒ–æˆåŠŸåï¼Œå‘å‘é€æ–¹ACKç¡®è®¤æ¶ˆæ¯å·²ç»å‘é€æˆåŠŸï¼Œæ­¤æ—¶æ¶ˆæ¯ä¸ºåŠæ¶ˆæ¯ã€‚</p></li><li><p>å‘é€æ–¹å¼€å§‹æ‰§è¡Œæœ¬åœ°äº‹åŠ¡é€»è¾‘ã€‚</p></li><li>å‘é€æ–¹æ ¹æ®æœ¬åœ°äº‹åŠ¡æ‰§è¡Œç»“æœå‘æœåŠ¡ç«¯æäº¤äºŒæ¬¡ç¡®è®¤ï¼ˆcommitæˆ–æ˜¯rollbackï¼‰ï¼ŒæœåŠ¡ç«¯æ”¶åˆ°commitçŠ¶æ€</li></ol><p>åˆ™å°†åŠæ¶ˆæ¯æ ‡è®°ä¸ºå¯æŠ•é€’çŠ¶æ€ï¼Œè®¢é˜…æ–¹æœ€ç»ˆå°†æ”¶åˆ°è¯¥æ¶ˆæ¯ï¼›æœåŠ¡ç«¯æ”¶åˆ°rollbackçŠ¶æ€ï¼Œåˆ™åˆ é™¤åŠæ¶ˆæ¯ï¼Œè®¢é˜…æ–¹å°†ä¸ä¼šæ”¶åˆ°è¯¥æ¶ˆæ¯ã€‚</p><ol start="5"><li>åœ¨æ–­ç½‘æˆ–è€…æ˜¯åº”ç”¨é‡å¯çš„ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œä¸Šè¿°æ­¥éª¤4æäº¤çš„äºŒæ¬¡ç¡®è®¤æ²¡æœ‰æŠµè¾¾RocketMQçš„æœåŠ¡ç«¯ï¼Œç»è¿‡å›ºå®šæ—¶é—´åï¼ŒæœåŠ¡ç«¯å°†ä¼šå¯¹æ¶ˆæ¯è¿›è¡Œå›æŸ¥ã€‚</li><li><p>å‘é€æ–¹æ”¶åˆ°æ¶ˆæ¯å›æŸ¥ç»“æœåï¼Œéœ€è¦æ£€æŸ¥å¯¹åº”æ¶ˆæ¯çš„æœ¬åœ°äº‹åŠ¡æ‰§è¡Œçš„æœ€ç»ˆç»“æœã€‚</p></li><li><p>å‘é€æ–¹æ ¹æ®æ£€æŸ¥åˆ°çš„æœ¬åœ°äº‹åŠ¡çš„æœ€ç»ˆçŠ¶æ€å†æ­¤æäº¤äºŒæ¬¡ç¡®è®¤ï¼ŒæœåŠ¡ç«¯ä»æŒ‰ç…§æ­¥éª¤å››å¯¹åŠæ¶ˆæ¯è¿›è¡Œæ“ä½œã€‚</p></li></ol><p>åœ¨å®é™…æ“ä½œä¸­éœ€è¦æ³¨æ„çš„æ˜¯äº‹åŠ¡æ¶ˆæ¯çš„Group IDä¸èƒ½ä¸å…¶ä»–ç±»å‹æ¶ˆæ¯çš„Group IDå…±ç”¨ã€‚ä¸å…¶ä»–æ¶ˆæ¯ä¸åŒçš„æ˜¯ï¼Œäº‹åŠ¡æ¶ˆæ¯æœ‰å›æŸ¥æœºåˆ¶ï¼Œå›æŸ¥æ—¶æ¶ˆæ¯é˜Ÿåˆ—RocketMQæœåŠ¡ç«¯ä¼šæ ¹æ®Group IDå»æŸ¥è¯¢å®¢æˆ·ç«¯ã€‚å¦‚æœæ˜¯é€šè¿‡ ONSFactory.createTransactionProducer åˆ›å»ºäº‹åŠ¡æ¶ˆæ¯çš„ Producer æ—¶å¿…é¡»æŒ‡å®š LocalTransactionChecker çš„å®ç°ç±»ï¼Œå¤„ç†å¼‚å¸¸æƒ…å†µä¸‹äº‹åŠ¡æ¶ˆæ¯çš„å›æŸ¥ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;RocketMQçš„äº‹åŠ¡æ¶ˆæ¯ç”¨é€”å¹¿æ³›ï¼Œä¹Ÿæ˜¯å¾ˆå¤šäººæ¶ˆæ¯ä¸­é—´ä»¶é€‰æ‹©RocketMQçš„ä¸€ä¸ªé‡è¦åŸå› ã€‚&lt;/p&gt;&lt;/blockquote&gt;
    
    </summary>
    
      <category term="RocketMQ" scheme="http://yoursite.com/categories/RocketMQ/"/>
    
    
      <category term="æ¶ˆæ¯äº‹åŠ¡" scheme="http://yoursite.com/tags/%E6%B6%88%E6%81%AF%E4%BA%8B%E5%8A%A1/"/>
    
  </entry>
  
  <entry>
    <title>RedisæŒä¹…åŒ–</title>
    <link href="http://yoursite.com/2018/11/25/redisback/"/>
    <id>http://yoursite.com/2018/11/25/redisback/</id>
    <published>2018-11-25T13:03:31.000Z</published>
    <updated>2020-05-10T11:36:12.061Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>Redisçš„æŒä¹…è¯æ–¹å¼åˆ†ä¸ºAOF(Append Of File)å’ŒRDBä¸¤ç§æ–¹å¼ã€‚<a id="more"></a> </p></blockquote><h3 id="RDBæŒä¹…åŒ–"><a href="#RDBæŒä¹…åŒ–" class="headerlink" title="RDBæŒä¹…åŒ–"></a>RDBæŒä¹…åŒ–</h3><h4 id="RDBæ–‡ä»¶çš„åˆ›å»ºä¸åŠ è½½"><a href="#RDBæ–‡ä»¶çš„åˆ›å»ºä¸åŠ è½½" class="headerlink" title="RDBæ–‡ä»¶çš„åˆ›å»ºä¸åŠ è½½"></a>RDBæ–‡ä»¶çš„åˆ›å»ºä¸åŠ è½½</h4><p>&emsp;&emsp;æœ‰ä¸¤ä¸ªRediså‘½ä»¤å¯ç”¨äºç”ŸæˆRDBæ–‡ä»¶ï¼Œä¸€ä¸ªSAVEï¼Œå¦ä¸€ä¸ªäº‹BGSAVEã€‚</p><p>&emsp;&emsp;SAVEå‘½ä»¤ä¼š<font color="red">é˜»å¡</font>RedisæœåŠ¡å™¨è¿›ç¨‹ã€‚ç›´åˆ°RDBæ–‡ä»¶åˆ›å»ºå®Œæˆä¸ºæ­¢ï¼Œ<font color="red">åœ¨æœåŠ¡å™¨è¿›ç¨‹é˜»å¡æœŸé—´ï¼ŒæœåŠ¡å™¨ä¸èƒ½å¤„ç†ä»»ä½•å‘½ä»¤è¯·æ±‚</font>ã€‚</p><p>&emsp;&emsp;BGSAVEå‘½ä»¤ä¼šæ´¾ç”Ÿä¸€ä¸ª<font color="red">å­è¿›ç¨‹</font>ï¼Œç„¶åç”±å­è¿›ç¨‹è´Ÿè´£åˆ›å»ºRDBæ–‡ä»¶ï¼Œ<font color="red">æœåŠ¡å™¨è¿›è¡Œï¼ˆçˆ¶è¿›ç¨‹ï¼‰ç»§ç»­å¤„ç†å‘½ä»¤è¯·æ±‚</font>ã€‚</p><p>&emsp;&emsp;RDBæ–‡ä»¶çš„è½½å…¥å·¥ä½œæ˜¯åœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œçš„ï¼Œæ‰€ä»¥æ— è®ºæ˜¯SAVEã€BGSAVEç”Ÿæˆçš„RDBæ–‡ä»¶ï¼Œè½½å…¥çš„æ–¹å¼éƒ½æ˜¯ä¸€è‡´çš„ã€‚<font color="red">åªè¦RDBæœåŠ¡å™¨åœ¨å¯åŠ¨æ—¶æ£€æµ‹åˆ°RDBæ–‡ä»¶å­˜åœ¨ï¼Œå®ƒå°±ä¼šè‡ªåŠ¨è½½å…¥RDBæ–‡ä»¶ã€‚</font></p><p>&emsp;&emsp;å› ä¸ºAOFæ–‡ä»¶çš„æ›´æ–°é¢‘ç‡é€šå¸¸æ¯”RDBæ–‡ä»¶çš„æ›´æ–°çš„é¢‘ç‡é«˜ï¼Œæ‰€ä»¥:</p><ol><li>å¦‚æœæœåŠ¡å™¨å¼€å¯äº†AOFæŒä¹…åŒ–åŠŸèƒ½ï¼Œé‚£ä¹ˆæœåŠ¡å™¨ä¼šä¼˜å…ˆä½¿ç”¨AOFæ–‡ä»¶æ¥è¿˜åŸæ•°æ®åº“çŠ¶æ€ã€‚</li><li>åªæœ‰åœ¨AOFæŒä¹…åŒ–åŠŸèƒ½å¤„äºå…³é—­çŠ¶æ€æ—¶ï¼ŒæœåŠ¡å™¨æ‰ä½¿ç”¨RDBæ–‡ä»¶æ¥è¿˜åŸæ•°æ®åº“çŠ¶æ€ã€‚</li></ol><p>&emsp;&emsp;æœåŠ¡å™¨ç¦æ­¢SAVEå‘½ä»¤å’ŒBGSAVEå‘½ä»¤åŒæ—¶æ‰§è¡Œæ˜¯ä¸ºäº†çˆ¶è¿›ç¨‹ï¼ˆæœåŠ¡å™¨è¿›ç¨‹ï¼‰å’Œå­è¿›ç¨‹åŒæ—¶æ‰§è¡Œä¸¤ä¸ªrdbSaveè°ƒç”¨ï¼Œé˜²æ­¢å‘ç”Ÿç«äº‰ã€‚å…¶æ¬¡ï¼Œåœ¨BGSAVEå‘½ä»¤æ‰§è¡ŒæœŸé—´ï¼Œå®¢æˆ·ç«¯å‘é€çš„BGSAVEå‘½ä»¤ä¼šè¢«æœåŠ¡å™¨æ‹’ç»ï¼Œå› ä¸ºåŒæ—¶æ‰§è¡Œä¸¤ä¸ªBGSAVEä¹Ÿä¼šäº§ç”Ÿç«äº‰æ¡ä»¶ã€‚</p><p>&emsp;&emsp;å› ä¸ºBGSAVEå‘½ä»¤å¯ä»¥ä¸é˜»å¡æœåŠ¡å™¨è¿›ç¨‹çš„æƒ…å†µä¸‹æ‰§è¡Œï¼Œæ‰€ä»¥Rediså…è®¸ç”¨æˆ·é€šè¿‡è®¾ç½®æœåŠ¡å™¨é…ç½®çš„saveé€‰é¡¹ï¼Œè®©æœåŠ¡å™¨æ¯ä¸ªä¸€æ®µæ—¶é—´è‡ªåŠ¨æ‰§è¡Œä¸€æ¬¡BGSAVEå‘½ä»¤ã€‚</p><h3 id="AOFæŒä¹…åŒ–"><a href="#AOFæŒä¹…åŒ–" class="headerlink" title="AOFæŒä¹…åŒ–"></a>AOFæŒä¹…åŒ–</h3><p>AOFæŒä¹…åŒ–çš„åŠŸèƒ½å¯ä»¥åˆ†ä¸ºå‘½ä»¤è¿½åŠ ï¼ˆappendï¼‰ã€æ–‡ä»¶å†™å…¥ã€æ–‡ä»¶åŒæ­¥ï¼ˆsyncï¼‰ä¸‰ä¸ªæ­¥éª¤ã€‚</p><h4 id="AOFæ–‡ä»¶çš„åˆ›å»º"><a href="#AOFæ–‡ä»¶çš„åˆ›å»º" class="headerlink" title="AOFæ–‡ä»¶çš„åˆ›å»º"></a>AOFæ–‡ä»¶çš„åˆ›å»º</h4><h5 id="å‘½ä»¤è¿½åŠ "><a href="#å‘½ä»¤è¿½åŠ " class="headerlink" title="å‘½ä»¤è¿½åŠ "></a>å‘½ä»¤è¿½åŠ </h5><p>&emsp;&emsp;å½“AOFæŒä¹…åŒ–åŠŸèƒ½å¤„äºæ‰“å¼€çŠ¶æ€æ—¶ï¼ŒæœåŠ¡å™¨åœ¨æ‰§è¡Œå®Œä¸€ä¸ªå†™å…¥å‘½ä»¤ä¹‹åï¼Œä¼šä»¥åè®®æ ¼å¼å°†è¢«æ‰§è¡Œçš„å†™å‘½ä»¤è¿½åŠ åˆ°æœåŠ¡å™¨çŠ¶æ€çš„aof bufç¼“å†²åŒºçš„æœ«å°¾ã€‚</p><h5 id="AOFçš„æ–‡ä»¶å†™å…¥"><a href="#AOFçš„æ–‡ä»¶å†™å…¥" class="headerlink" title="AOFçš„æ–‡ä»¶å†™å…¥"></a>AOFçš„æ–‡ä»¶å†™å…¥</h5><p>&emsp;&emsp;Redisçš„æœåŠ¡å™¨è¿›ç¨‹å°±æ˜¯ä¸€ä¸ªäº‹ä»¶å¾ªç¯ã€‚å› ä¸ºæœåŠ¡å™¨åœ¨å¤„ç†æ–‡ä»¶äº‹ä»¶æ—¶å¯èƒ½ä¼šæ‰§è¡Œå†™å‘½ä»¤ï¼Œä½¿å¾—ä¸€äº›å†…å®¹è¢«è¿½åŠ åˆ°aof_bufç¼“å†²åŒºé‡Œé¢ï¼Œæ‰€ä»¥åœ¨æœåŠ¡å™¨æ¯æ¬¡ç»“æŸä¸€ä¸ªäº‹ä»¶å¾ªç¯ä¹‹å‰ï¼Œå®ƒéƒ½ä¼šè°ƒç”¨flushAppendOnlyFileå‡½æ•°ï¼Œè€ƒè™‘æ˜¯å¦éœ€è¦å°†aof_bufç¼“å†²åŒºä¸­çš„å†…å®¹å†™å…¥å’Œä¿å­˜åˆ°aofæ–‡ä»¶é‡Œé¢ã€‚</p><h5 id="AOFçš„æ–‡ä»¶åŒæ­¥"><a href="#AOFçš„æ–‡ä»¶åŒæ­¥" class="headerlink" title="AOFçš„æ–‡ä»¶åŒæ­¥"></a>AOFçš„æ–‡ä»¶åŒæ­¥</h5><p>&emsp;&emsp;ä¸ºäº†æé«˜æ–‡ä»¶çš„å†™å…¥æ•ˆç‡ï¼Œåœ¨ç°ä»£æ“ä½œç³»ç»Ÿä¸­ï¼Œå½“ç”¨æˆ·è°ƒç”¨writerå‡½æ•°ï¼Œå°†ä¸€äº›æ•°æ®å†™å…¥åˆ°æ–‡ä»¶çš„æ—¶å€™ï¼Œæ“ä½œç³»ç»Ÿé€šå¸¸ä¼šå°†å†™å…¥æ•°æ®æš‚æ—¶ä¿å­˜åœ¨ä¸€ä¸ªå†…å­˜ç¼“å†²åŒºé‡Œé¢ï¼Œç­‰åˆ°ç¼“å†²åŒºçš„ç©ºé—´è¢«å¡«æ»¡ï¼Œæˆ–è€…è¶…è¿‡äº†æŒ‡å®šçš„æ—¶é™ä¹‹åï¼Œæ‰çœŸæ­£åœ°å°†ç¼“å†²åŒºä¸­çš„æ•°æ®å†™å…¥åˆ°ç£ç›˜é‡Œé¢ã€‚</p><p>&emsp;&emsp;ä¸ºæ­¤ï¼Œç³»ç»Ÿæä¾›äº†fsyncå’Œfdatasyncä¸¤ä¸ªåŒæ­¥å‡½æ•°ï¼Œå®ƒä»¬å¯ä»¥å¼ºåˆ¶è®©æ“ä½œç³»ç»Ÿç«‹å³å°†ç¼“å†²åŒºä¸­çš„æ•°æ®å†™å…¥åˆ°ç¡¬ç›˜é‡Œé¢ï¼Œä»è€Œç¡®ä¿å†™å…¥æ•°æ®çš„å®‰å…¨æ€§ã€‚</p><h4 id="AOFæ–‡ä»¶è½½å…¥ä¸æ•°æ®è¿˜åŸ"><a href="#AOFæ–‡ä»¶è½½å…¥ä¸æ•°æ®è¿˜åŸ" class="headerlink" title="AOFæ–‡ä»¶è½½å…¥ä¸æ•°æ®è¿˜åŸ"></a>AOFæ–‡ä»¶è½½å…¥ä¸æ•°æ®è¿˜åŸ</h4><p><img src="/2018/11/25/redisback/repository.png" alt="æ–‡ä»¶è½½å…¥è¿‡ç¨‹"></p><h4 id="AOFé‡å†™"><a href="#AOFé‡å†™" class="headerlink" title="AOFé‡å†™"></a>AOFé‡å†™</h4><p>&emsp;&emsp;ä¸ºäº†è§£å†³AOFæ–‡ä»¶ä½“ç§¯è†¨èƒ€çš„é—®é¢˜ï¼ŒRedisæä¾›äº†AOFæ–‡ä»¶é‡å†™ï¼ˆrewriteï¼‰åŠŸèƒ½ã€‚é€šè¿‡è¯¥åŠŸèƒ½ï¼ŒRedisæœåŠ¡å™¨å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„AOFæ–‡ä»¶æ¥æ›¿ä»£ç°æœ‰çš„AOFæ–‡ä»¶ï¼Œæ–°æ—§ä¸¤ä¸ªAOFæ–‡ä»¶æ‰€ä¿å­˜çš„æ•°æ®åº“çŠ¶æ€ç›¸åŒï¼Œä½†æ–°AOFæ–‡ä»¶ä¸åŒ…å«ä»»ä½•æµªè´¹ç©ºé—´çš„å†—ä½™å‘½ä»¤ï¼Œæ‰€ä»¥æ–°AOFæ–‡ä»¶çš„ä½“ç§¯é€šå¸¸ä¼šæ¯”AOFæ–‡ä»¶çš„ä½“ç§¯è¦å°çš„å¤šã€‚</p><p>&emsp;&emsp;è™½ç„¶Rediså°†ç”Ÿæˆæ–°AOFæ–‡ä»¶æ›¿æ¢æ—§AOFæ–‡ä»¶çš„åŠŸèƒ½å‘½åä¸ºâ€œAOFæ–‡ä»¶é‡å†™â€ï¼Œä½†å®é™…ä¸Šï¼ŒAOFé‡å†™å¹¶ä¸éœ€è¦å¯¹ç°æœ‰çš„AOFæ–‡ä»¶è¿›è¡Œä»»ä½•è¯»å–ã€åˆ†æã€æˆ–ç€å†™å…¥æ“ä½œï¼Œè¿™ä¸ªåŠŸèƒ½æ˜¯é€šè¿‡è¯»å–æœåŠ¡å™¨å½“å‰çš„æ•°æ®åº“çŠ¶æ€æ¥å®ç°çš„ã€‚</p><p>&emsp;&emsp;é¦–å…ˆä»æ•°æ®åº“ä¸­è¯»å–é”®ç°åœ¨çš„å€¼ï¼Œç„¶åç”¨ä¸€æ¡å‘½ä»¤å»è®°å½•é”®å€¼å¯¹ï¼Œä»£æ›¿ä¹‹å‰è®°å½•è¿™ä¸ªé”®å€¼å¯¹çš„å¤šæ¡å‘½ä»¤ï¼Œè¿™å°±æ˜¯AOFé‡å†™åŠŸèƒ½çš„å®ç°ã€‚ï¼ˆ<font color="red">å…ˆè¯»åå†™</font>ï¼‰</p><p><img src="/2018/11/25/redisback/aof01.png" alt="æœåŠ¡å™¨åŒæ—¶å°†å‘½ä»¤å‘é€ç»™AOFæ–‡ä»¶å’ŒAOFé‡å†™ç¼“å†²åŒº"></p><p>&emsp;&emsp;Redisä¸å¸Œæœ›AOFé‡å†™é€ æˆæœåŠ¡å™¨æ— æ³•å¤„ç†è¯·æ±‚ï¼Œæ‰€ä»¥Rediså†³å®šå°†AOFé‡å†™ç¨‹åºæ”¾åˆ°å­è¿›ç¨‹é‡Œæ‰§è¡Œï¼Œå¯ä»¥åŒæ—¶è¾¾åˆ°ä¸¤ä¸ªç›®çš„ï¼š</p><ol><li>å­è¿›ç¨‹è¿›è¡ŒAOFé‡å†™æœŸé—´ï¼ŒæœåŠ¡å™¨è¿›è¡Œï¼ˆçˆ¶è¿›ç¨‹ï¼‰å¯ä»¥å¤„ç†å‘½ä»¤è¯·æ±‚ã€‚</li><li>å­è¿›ç¨‹å¸¦æœ‰æœåŠ¡å™¨è¿›ç¨‹çš„æ•°æ®å‰¯æœ¬ï¼Œä½¿ç”¨å­è¿›ç¨‹è€Œä¸æ˜¯çº¿ç¨‹ï¼Œå¯ä»¥åœ¨é¿å…ä½¿ç”¨é”çš„æƒ…å†µä¸‹ï¼Œä¿è¯æ•°æ®çš„å®‰å…¨æ€§ã€‚</li></ol><h5 id="AOFé‡å†™è¿‡ç¨‹ä¸­æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜è§£å†³"><a href="#AOFé‡å†™è¿‡ç¨‹ä¸­æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜è§£å†³" class="headerlink" title="AOFé‡å†™è¿‡ç¨‹ä¸­æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜è§£å†³"></a>AOFé‡å†™è¿‡ç¨‹ä¸­æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜è§£å†³</h5><p>&emsp;&emsp;ä¸ºäº†è§£å†³è¿™ç§æ•°æ®ä¸ä¸€è‡´é—®é¢˜ï¼ŒRedisæœåŠ¡å™¨è®¾ç½®äº†ä¸€ä¸ªAOFé‡å†™ç¼“å†²åŒºï¼Œè¿™ä¸ªç¼“å†²åŒºåœ¨æœåŠ¡å™¨åˆ›å»ºå­è¿›ç¨‹ä¹‹åå¼€å§‹ä½¿ç”¨ï¼Œå½“RedisæœåŠ¡å™¨æ‰§è¡Œäº†ä¸€ä¸ªå†™å‘½ä»¤ä¹‹åï¼Œå®ƒä¼šåŒæ—¶å°†è¿™ä¸ªå†™å‘½ä»¤å‘é€ç»™AOFç¼“å†²åŒºå’ŒAOFé‡å†™ç¼“å†²åŒºã€‚</p><p>å½“å­è¿›ç¨‹å®ŒæˆAOFé‡å†™å·¥ä½œä¹‹åï¼Œå®ƒä¼šå‘çˆ¶è¿›ç¨‹å‘é€ä¸€ä¸ªä¿¡å·ï¼Œçˆ¶è¿›ç¨‹åœ¨æ¥åˆ°è¯¥ä¿¡å·ä¹‹åï¼Œä¼šè°ƒç”¨ä¸€ä¸ªä¿¡å·å¤„ç†å‡½æ•°ï¼Œå¹¶æ‰§è¡Œä»¥ä¸‹å·¥ä½œï¼š</p><ol><li>å°†AOFé‡å†™ç¼“å†²åŒºä¸­çš„æ‰€æœ‰å†…å®¹å†™å…¥åˆ°æ–°AOFæ–‡ä»¶æ±‡æ€»ï¼Œè¿™æ˜¯æ–°AOFæ–‡ä»¶æ‰€ä¿å­˜çš„æ•°æ®åº“å°†å’ŒæœåŠ¡å™¨å½“å‰çš„æ•°æ®åº“çŠ¶æ€ä¸€è‡´ã€‚</li><li>å¯¹æ–°çš„AOFæ–‡ä»¶è¿›è¡Œæ”¹åï¼ŒåŸå­åœ°è¦†ç›–ç°æœ‰çš„AOFæ–‡ä»¶ï¼Œå®Œæˆæ–°æ—§ä¸¤ä¸ªAOFæ–‡ä»¶çš„æ›¿æ¢ã€‚</li></ol><p>&emsp;&emsp;åœ¨æ•´ä¸ªAOFåå°é‡å†™è¿‡ç¨‹ä¸­ï¼Œåªæœ‰ä¿¡å·å¤„ç†å‡½æ•°æ‰§è¡Œæ—¶ä¼šå¯¹æœåŠ¡å™¨è¿›ç¨‹ï¼ˆçˆ¶è¿›ç¨‹ï¼‰é€ æˆé˜»å¡ï¼Œå…¶ä½™æ—¶é—´ï¼ŒAOFåå°é‡å†™éƒ½ä¸ä¼šé˜»å¡çˆ¶è¿›ç¨‹ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;Redisçš„æŒä¹…è¯æ–¹å¼åˆ†ä¸ºAOF(Append Of File)å’ŒRDBä¸¤ç§æ–¹å¼ã€‚&lt;/p&gt;&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="RDB" scheme="http://yoursite.com/tags/RDB/"/>
    
      <category term="AOF" scheme="http://yoursite.com/tags/AOF/"/>
    
  </entry>
  
  <entry>
    <title>Redisæ•°æ®å¯¹è±¡åˆè¯†</title>
    <link href="http://yoursite.com/2018/06/19/redisObjectInfo/"/>
    <id>http://yoursite.com/2018/06/19/redisObjectInfo/</id>
    <published>2018-06-19T09:31:43.000Z</published>
    <updated>2020-05-10T11:36:12.059Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>&emsp;&emsp;é¦–å…ˆå¸¦ç€è¿™å‡ ä¸ªé—®é¢˜ï¼š</p></blockquote><ol><li><p>redisæœ‰å“ªäº›å¯¹è±¡ï¼Ÿ</p></li><li><p>rediså¯¹è±¡åº•å±‚çš„æ•°æ®ç»“æ„æ˜¯ä»€ä¹ˆï¼Ÿ</p></li><li><p>ä¸ºä»€ä¹ˆè¦é€‰æ‹©è¿™ç§æ•°æ®ç»“æ„ï¼Ÿ <a id="more"></a></p></li></ol><h5 id="Rediså¯¹è±¡"><a href="#Rediså¯¹è±¡" class="headerlink" title="Rediså¯¹è±¡"></a>Rediså¯¹è±¡</h5><p>&emsp;&emsp;Redisæ¯åˆ›å»ºä¸€ä¸ªé”®å€¼å¯¹æ—¶ï¼Œè‡³å°‘ä¼šåˆ›å»ºä¸¤ä¸ªå¯¹è±¡ï¼Œä¸€ä¸ªå¯¹è±¡ç”¨ä½œé”®å€¼å¯¹çš„é”®ï¼Œä¸€ä¸ªç”¨ä½œé”®å€¼å¯¹çš„å€¼ã€‚æ¯ä¸€ä¸ªå¯¹è±¡éƒ½ç”±ä¸€ä¸ªredisObjectç»“æ„è¡¨ç¤ºï¼Œç»“æ„ä¸­å’Œä¿å­˜æ•°æ®æœ‰å…³çš„æ•°æ®æœ‰ä¸‰ä¸ªå±æ€§åˆ†åˆ«æ˜¯typeå±æ€§ã€encodingå±æ€§å’Œptrå±æ€§ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">typedef struct redisObject &#123;</span><br><span class="line">// ç±»å‹</span><br><span class="line">unsinged type:4;</span><br><span class="line">// ç¼–ç </span><br><span class="line">unsinged encoding:4;</span><br><span class="line">// æŒ‡å‘åº•å±‚å®ç°æ•°æ®ç»“æ„çš„æŒ‡é’ˆ</span><br><span class="line">void *ptr;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;Redisçš„å¯¹è±¡æœ‰å­—ç¬¦ä¸²ï¼ˆStringï¼‰ï¼Œåˆ—è¡¨ï¼ˆListï¼‰ï¼Œé›†åˆï¼ˆSetï¼‰ï¼Œå“ˆå¸Œï¼ˆHashï¼‰ï¼Œæœ‰åºé›†åˆï¼ˆZSetï¼‰è¿™å‡ ç§å¯¹è±¡ã€‚</p><ul><li>å­—ç¬¦ä¸²å¯¹è±¡ </li></ul><ol><li>å­—ç¬¦ä¸²å¯¹è±¡çš„ç¼–ç å¯ä»¥æ˜¯intã€rawæˆ–è€…embStrã€‚ </li><li>å¯¹äºintç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡æ¥è¯´ï¼Œå¦‚æœæˆ‘ä»¬æ‰§è¡Œäº†ä¸€äº›å‘½ä»¤ï¼Œä½¿å¾—è¿™ä¸ªå¯¹è±¡ä¿å­˜çš„ä¸å†æ˜¯æ•´æ•°å€¼ï¼Œè€Œæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å€¼ï¼Œé‚£ä¹ˆå­—ç¬¦ä¸²å¯¹è±¡çš„ç¼–ç å°†ä»intå˜ä¸ºrawã€‚ </li><li>å¯¹embStrç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡æ‰§è¡Œä»»ä½•ä¿®æ”¹å‘½ä»¤æ—¶ï¼Œç¨‹åºä¼šå…ˆå°†å¯¹è±¡çš„ç¼–ç ä»embStrè½¬æ¢æˆrawï¼Œç„¶ååœ¨æ‰§è¡Œå‘½ä»¤ã€‚æ‰€ä»¥ï¼ŒembStrç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡åœ¨æ‰§è¡Œä¿®æ”¹å‘½ä»¤ä¹‹åï¼Œæ€»ä¼šå˜æˆä¸€ä¸ªrawç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡ã€‚ </li></ol><ul><li>åˆ—è¡¨å¯¹è±¡ </li></ul><ol><li><p>åˆ—è¡¨å¯¹è±¡çš„ç¼–ç å¯ä»¥æ˜¯ziplistæˆ–è€…linkedlistã€‚ </p></li><li><p>ziplistç¼–ç çš„åˆ—è¡¨å¯¹è±¡ä½¿ç”¨å‹ç¼©åˆ—è¡¨ä½œä¸ºåº•å±‚å®ç°ï¼Œæ¯ä¸ªå‹ç¼©åˆ—è¡¨èŠ‚ç‚¹ä¿å­˜ä¸€ä¸ªåˆ—è¡¨å…ƒç´ ã€‚ </p></li><li><p>linkedlistç¼–ç çš„åˆ—è¡¨å¯¹è±¡ä½¿ç”¨åŒç«¯é“¾è¡¨ä½œä¸ºåº•å±‚å®ç°ï¼Œæ¯ä¸ªåŒç«¯é“¾è¡¨èŠ‚ç‚¹éƒ½ä¿å­˜äº†ä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ï¼Œè€Œæ¯ä¸ªå­—ç¬¦ä¸²å¯¹è±¡éƒ½ä¿å­˜äº†ä¸€ä¸ªåˆ—è¡¨å…ƒç´ ã€‚ </p></li><li><p>ç¼–ç è½¬æ¢ </p><p>&emsp;&emsp;å½“åˆ—è¡¨å¯¹è±¡å¯ä»¥åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶æ—¶ï¼Œåˆ—è¡¨å¯¹è±¡ä½¿ç”¨ziplistç¼–ç ï¼šåˆ—è¡¨å¯¹è±¡ä¿å­˜çš„æ‰€æœ‰å­—ç¬¦ä¸²å…ƒç´ çš„é•¿åº¦éƒ½å°äº64å­—èŠ‚ï¼›åˆ—è¡¨å¯¹è±¡ä¿å­˜çš„å…ƒç´ æ•°é‡å°äº512ä¸ªï¼›ä¸èƒ½æ»¡è¶³è¿™ä¸¤ä¸ªæ¡ä»¶çš„åˆ—è¡¨å¯¹è±¡éœ€è¦ä½¿ç”¨linkedlistç¼–ç ã€‚ </p></li></ol><ul><li>å“ˆå¸Œå¯¹è±¡ </li></ul><ol><li><p>å“ˆå¸Œå¯¹è±¡çš„ç¼–ç å¯ä»¥æ˜¯ziplistæˆ–è€…hashtableã€‚ </p></li><li><p>ziplist ç¼–ç çš„å“ˆå¸Œå¯¹è±¡ä½¿ç”¨å‹ç¼©åˆ—è¡¨ä½œä¸ºåº•å±‚å®ç°ï¼Œæ¯å½“æœ‰æ–°çš„é”®å€¼å¯¹è¦åŠ å…¥åˆ°å“ˆå¸Œå¯¹è±¡æ—¶ï¼Œç¨‹åºä¼šå…ˆå°†ä¿å­˜äº†é”®çš„å‹ç¼©åˆ—è¡¨èŠ‚ç‚¹æ¨å…¥åˆ°å‹ç¼©åˆ—è¡¨è¡¨å°¾ï¼Œæ‰€ä»¥ä¿å­˜äº†åŒä¸€é”®å€¼å¯¹çš„ä¸¤ä¸ªèŠ‚ç‚¹æ€»æ˜¯ç´§æŒ¨åœ¨ä¸€èµ·ï¼Œä¿å­˜é”®çš„èŠ‚ç‚¹åœ¨å‰ï¼Œä¿å­˜å€¼çš„èŠ‚ç‚¹åœ¨åï¼›å…ˆæ·»åŠ åˆ°å“ˆå¸Œå¯¹è±¡ä¸­çš„é”®å€¼å¯¹ä¼šæ”¾åœ¨å‹ç¼©åˆ—è¡¨çš„è¡¨å¤´æ–¹å‘ï¼Œè€Œåæ¥æ·»åŠ åˆ°å“ˆå¸Œå¯¹è±¡ä¸­çš„é”®å€¼å¯¹ä¼šè¢«æ”¾åœ¨å‹ç¼©åˆ—è¡¨çš„è¡¨å°¾æ–¹å‘ã€‚ </p></li><li><p>hashtableç¼–ç çš„å“ˆå¸Œå¯¹è±¡ä½¿ç”¨å­—å…¸ä½œä¸ºåº•å±‚å®ç°ï¼Œå“ˆå¸Œå¯¹è±¡ä¸­çš„æ¯ä¸ªé”®å€¼å¯¹éƒ½ä½¿ç”¨ä¸€ä¸ªå­—å…¸å€¼æ¥ä¿å­˜ï¼šå­—å…¸çš„æ¯ä¸ªé”®éƒ½æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ï¼Œå¯¹è±¡ä¸­ä¿å­˜äº†é”®å€¼å¯¹çš„é”®ã€‚å­—å…¸ä¸­çš„æ¯ä¸€ä¸ªå€¼éƒ½æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ï¼Œå¯¹è±¡ä¸­ä¿å­˜äº†é”®å€¼å¯¹çš„å€¼ã€‚ </p></li><li><p>ç¼–ç è½¬æ¢ </p><p>&emsp;&emsp;å½“å“ˆå¸Œå¯¹è±¡å¯ä»¥åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶æ—¶ï¼Œåˆ—è¡¨å¯¹è±¡ä½¿ç”¨ziplistç¼–ç ï¼šå“ˆå¸Œå¯¹è±¡ä¿å­˜çš„æ‰€æœ‰å­—ç¬¦ä¸²å…ƒç´ çš„é•¿åº¦éƒ½å°äº64å­—èŠ‚ï¼›å“ˆå¸Œå¯¹è±¡ä¿å­˜çš„å…ƒç´ æ•°é‡å°äº512ä¸ªï¼›ä¸èƒ½æ»¡è¶³è¿™ä¸¤ä¸ªæ¡ä»¶çš„å“ˆå¸Œå¯¹è±¡éœ€è¦ä½¿ç”¨hashtableç¼–ç ã€‚ </p></li></ol><ul><li>é›†åˆå¯¹è±¡ </li></ul><ol><li><p>é›†åˆå¯¹è±¡çš„ç¼–ç å¯ä»¥æ˜¯insetæˆ–è€…hashtableã€‚ </p></li><li><p>insetç¼–ç çš„é›†åˆå¯¹è±¡ä½¿ç”¨æ•´æ•°é›†åˆä½œä¸ºåº•å±‚å®ç°ï¼Œé›†åˆå¯¹è±¡åŒ…å«çš„æ‰€æœ‰å…ƒç´ éƒ½è¢«ä¿å­˜åœ¨æ•´æ•°é›†åˆé‡Œé¢ </p></li><li><p>hashtableç¼–ç çš„é›†åˆå¯¹è±¡ä½¿ç”¨å­—å…¸ä½œä¸ºåº•å±‚å®ç°ï¼Œå­—å…¸çš„æ¯ä¸ªé”®éƒ½æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ï¼Œæ¯ä¸ªå­—ç¬¦ä¸²å¯¹è±¡åŒ…å«äº†ä¸€ä¸ªé›†åˆå…ƒç´ ï¼Œå­—å…¸çš„å€¼åˆ™å…¨éƒ¨è¢«è®¾ç½®ä¸ºnullã€‚ </p></li><li><p>ç¼–ç çš„è½¬æ¢ </p><p>&emsp;&emsp;å½“é›†åˆå¯¹è±¡å¯ä»¥åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶æ—¶ï¼Œå¯¹è±¡ä½¿ç”¨insertç¼–ç ï¼šé›†åˆå¯¹è±¡ä¿å­˜çš„æ‰€æœ‰å…ƒç´ éƒ½æ˜¯æ•´æ•°å€¼,é›†åˆå¯¹è±¡ä¿å­˜çš„å…ƒç´ æ•°é‡å°äº512ä¸ªï¼›ä¸èƒ½æ»¡è¶³è¿™ä¸¤ä¸ªæ¡ä»¶çš„å“ˆå¸Œå¯¹è±¡éœ€è¦ä½¿ç”¨hashtableç¼–ç ã€‚ </p></li></ol><ul><li><p>æœ‰åºé›†åˆå¯¹è±¡ </p><p>&emsp;&emsp;æœ‰åºé›†åˆçš„ç¼–ç å¯ä»¥æ˜¯ziplistæˆ–è€…skiplistã€‚ </p><ol><li><p>ziplistç¼–ç çš„æœ‰åºé›†åˆå¯¹è±¡ä½¿ç”¨å‹ç¼©åˆ—è¡¨ä½œä¸ºåº•å±‚å®ç°ï¼Œæ¯ä¸ªé›†åˆå…ƒç´ ä½¿ç”¨ä¸¤ä¸ªç´§æŒ¨åœ¨ä¸€èµ·çš„å‹ç¼©åˆ—è¡¨èŠ‚ç‚¹æ¥ä¿å­˜ï¼Œç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¿å­˜å…ƒç´ çš„æˆå‘˜ï¼ˆmemberï¼‰ï¼Œè€Œç¬¬äºŒä¸ªå…ƒç´ åˆ™ä¿å­˜å…ƒç´ çš„åˆ†å€¼ï¼ˆscoreï¼‰ã€‚å‹ç¼©åˆ—è¡¨å†…çš„é›†åˆå…ƒç´ æŒ‰åˆ†å€¼ä»å°åˆ°å¤§è¿›è¡Œæ’åºï¼Œåˆ†å€¼è¾ƒå°çš„å…ƒç´ è¢«æ”¾ç½®åœ¨é è¿‘è¡¨å¤´çš„ä½ç½®ï¼Œè€Œåˆ†å€¼è¾ƒå¤§çš„å…ƒç´ åˆ™è¢«æ”¾ç½®åœ¨é è¿‘è¡¨å°¾çš„ä½ç½®ã€‚ </p></li><li><p>skiplistç¼–ç çš„æœ‰åºé›†åˆå¯¹è±¡ä½¿ç”¨zsetç»“æ„ä½œä¸ºåº•å±‚å®ç°ï¼Œä¸€ä¸ªzsetç»“æ„åŒæ—¶åŒ…å«ä¸€ä¸ªå­—å…¸å’Œä¸€ä¸ªè·³è·ƒè¡¨ã€‚zsetç»“æ„ä¸­çš„zs1è·³è·ƒè¡¨æŒ‰åˆ†å€¼ä»å°åˆ°å¤§ä¿å­˜äº†æ‰€æœ‰é›†åˆå…ƒç´ ï¼Œæ¯ä¸ªè·³è·ƒè¡¨èŠ‚ç‚¹éƒ½ä¿å­˜äº†ä¸€ä¸ªé›†åˆå…ƒç´ ï¼šè·³è·ƒè¡¨èŠ‚ç‚¹çš„objectå±æ€§ä¿å­˜äº†å…ƒç´ çš„æˆå‘˜ï¼Œè€Œè·³è·ƒè¡¨èŠ‚ç‚¹çš„scoreå±æ€§åˆ™ä¿å­˜äº†å…ƒç´ çš„åˆ†å€¼ã€‚ </p></li><li><p>ç¼–ç è½¬æ¢ </p><p>&emsp;&emsp;å½“æœ‰åºé›†åˆå¯¹è±¡å¯ä»¥åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶æ—¶ï¼Œå¯¹è±¡å¯ä»¥ä½¿ç”¨ziplistç¼–ç ï¼šæœ‰åºé›†åˆå¯¹è±¡ä¿å­˜çš„å…ƒç´ æ•°é‡å°äº128ä¸ªï¼›æœ‰åºé›†åˆå¯¹è±¡ä¿å­˜çš„æ‰€æœ‰å…ƒç´ æˆå‘˜çš„é•¿åº¦éƒ½å°äº64å­—èŠ‚ï¼›ä¸èƒ½æ»¡è¶³è¿™ä¸¤ä¸ªæ¡ä»¶çš„åˆ—è¡¨å¯¹è±¡éœ€è¦ä½¿ç”¨skiplistç¼–ç ã€‚ </p><p><img src="/2018/06/19/redisObjectInfo/rediså¯¹è±¡.png" alt="&#39;Rediså¯¹è±¡&#39;"></p></li></ol></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;&amp;emsp;&amp;emsp;é¦–å…ˆå¸¦ç€è¿™å‡ ä¸ªé—®é¢˜ï¼š&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ol&gt;
&lt;li&gt;&lt;p&gt;redisæœ‰å“ªäº›å¯¹è±¡ï¼Ÿ&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;rediså¯¹è±¡åº•å±‚çš„æ•°æ®ç»“æ„æ˜¯ä»€ä¹ˆï¼Ÿ&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;ä¸ºä»€ä¹ˆè¦é€‰æ‹©è¿™ç§æ•°æ®ç»“æ„ï¼Ÿ&lt;/p&gt;&lt;/li&gt;&lt;/ol&gt;
    
    </summary>
    
      <category term="Redis" scheme="http://yoursite.com/categories/Redis/"/>
    
    
      <category term="Redis Object" scheme="http://yoursite.com/tags/Redis-Object/"/>
    
  </entry>
  
  <entry>
    <title>JVMåƒåœ¾æ”¶é›†ï¼ˆä¸€ï¼‰</title>
    <link href="http://yoursite.com/2018/04/29/gc01/"/>
    <id>http://yoursite.com/2018/04/29/gc01/</id>
    <published>2018-04-29T10:12:02.000Z</published>
    <updated>2020-05-10T11:36:12.057Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>&emsp;&emsp;åœ¨JVMä¸­,è¿›è¡Œåƒåœ¾å›æ”¶é¦–å…ˆè¦åˆ¤æ–­å¯¹è±¡å¯¹è±¡æ˜¯å¦å­˜æ´»ï¼Œåœ¨å¯¹ä¸åŒç”Ÿå‘½å‘¨æœŸçš„å¯¹è±¡è¿›è¡Œåƒåœ¾å›æ”¶ã€‚åœ¨è¿›è¡Œåƒåœ¾å›æ”¶æ—¶ï¼Œè¦æ ¹æ®éœ€æ±‚è¿›è¡Œåƒåœ¾å›æ”¶ç®—æ³•çš„é€‰æ‹©ã€‚ï¼ˆæ¯”å¦‚æ³¨é‡ååé‡ï¼‰<a id="more"></a>  </p></blockquote><h5 id="å¦‚ä½•åˆ¤æ–­å¯¹è±¡å­˜æ´»"><a href="#å¦‚ä½•åˆ¤æ–­å¯¹è±¡å­˜æ´»" class="headerlink" title="å¦‚ä½•åˆ¤æ–­å¯¹è±¡å­˜æ´»"></a>å¦‚ä½•åˆ¤æ–­å¯¹è±¡å­˜æ´»</h5><table><thead><tr><th style="text-align:center">ç®—æ³•</th><th style="text-align:center">æ€æƒ³</th><th style="text-align:center">ä¼˜ç¼ºç‚¹</th></tr></thead><tbody><tr><td style="text-align:center">å¼•ç”¨è®¡æ•°ç®—æ³•</td><td style="text-align:center">ç»™å¯¹è±¡ä¸€ä¸ªè®¡æ•°å™¨ï¼Œæœ‰äººå¼•ç”¨å°±åŠ 1,å¼•ç”¨å¤±æ•ˆå°±å‡1ã€‚å½“è®¡æ•°å™¨ä¸º0æ—¶ï¼Œåˆ™å¯¹è±¡ä¸å†è¢«å¼•ç”¨ã€‚</td><td style="text-align:center">ä¼˜ç‚¹ï¼šå®ç°ç®€å•ï¼Œåˆ¤å®šæ•ˆç‡é«˜ã€‚ç¼ºç‚¹ï¼šå¾ˆéš¾è§£å†³å¯¹è±¡ä¹‹é—´ç›¸äº’å¾ªç¯è°ƒç”¨çš„é—®é¢˜</td></tr><tr><td style="text-align:center">å¯è¾¾æ€§åˆ†æç®—æ³•</td><td style="text-align:center">ä»¥GC Rootsä¸ºèµ·ç‚¹ï¼Œå½“ä¸€ä¸ªå¯¹è±¡æ²¡æœ‰ä»¥GC Rootsä¸ºèµ·ç‚¹çš„å¼•ç”¨é“¾æ—¶ï¼Œåˆ™å¯¹è±¡ä¸å†è¢«å¼•ç”¨</td><td style="text-align:center"></td></tr></tbody></table><p>åœ¨jdkä¸­å¼•ç”¨åˆ†ä¸ºå¼ºå¼•ç”¨ã€è½¯å¼•ç”¨ã€å¼±å¼•ç”¨ã€è™šå¼•ç”¨ã€‚  </p><table><thead><tr><th style="text-align:center">å¼ºå¼•ç”¨</th><th style="text-align:center">è½¯å¼•ç”¨</th><th style="text-align:center">å¼±å¼•ç”¨</th><th style="text-align:center">è™šå¼•ç”¨</th></tr></thead><tbody><tr><td style="text-align:center">å¼ºå¼•ç”¨åªè¦å­˜åœ¨ï¼Œå°±ä¸ä¼šè¢«å›æ”¶</td><td style="text-align:center">åœ¨ç³»ç»Ÿå°†è¦å‘ç”Ÿå†…å­˜æº¢å‡ºæ—¶ï¼Œå¯¹è±¡å°†è¿›å…¥äºŒæ¬¡åƒåœ¾å›æ”¶èŒƒå›´</td><td style="text-align:center">åªèƒ½ç”Ÿå­˜åˆ°ä¸‹ä¸€æ¬¡åƒåœ¾å›æ”¶ä¹‹å‰</td><td style="text-align:center">æƒŸä¸€çš„ç›®çš„å°±æ˜¯èƒ½åœ¨è¿™ä¸ªå¯¹åƒè¢«æ”¶é›†å™¨å›æ”¶æ—¶æ”¶åˆ°ä¸€ä¸ªç³»ç»Ÿçš„é€šçŸ¥</td></tr></tbody></table><h5 id="å¯¹è±¡çš„åˆ›å»º"><a href="#å¯¹è±¡çš„åˆ›å»º" class="headerlink" title="å¯¹è±¡çš„åˆ›å»º"></a>å¯¹è±¡çš„åˆ›å»º</h5><blockquote><p>&emsp;&emsp;åœ¨JVMä¸­ï¼Œå¯ä»¥æŠŠå †åˆ†ä¸º1/3çš„æ–°ç”Ÿä»£å’Œ2/3çš„è€ç”Ÿä»£ã€‚åœ¨å°†æ–°ç”Ÿä»£æŒ‰ç…§8:2åˆ†ä¸ºEdenåŒºå’ŒSurvivoråŒºã€‚è€Œåœ¨SurvivoråŒºæœ‰æŒ‰ç…§1:1åˆ†ä¸ºä¸¤ä¸ªï¼Œè®°ä¸ºfromï¼ŒtoåŒºã€‚(å„å‚æ•°ä¾æ®é»˜è®¤å‚æ•°)<br><img src="/2018/04/29/gc01/heap.png" alt="&#39;å †çš„å†…å­˜ç»“æ„&#39;"><br>åœ¨æ–°åˆ›å»ºä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œé¦–å…ˆè¦å¯¹ä¸€ä¸ªå¯¹è±¡è¿›è¡Œåˆ¤æ–­ï¼Œæ˜¯å¤§å¯¹è±¡è¿˜æ˜¯ä¸€èˆ¬çš„å¯¹è±¡ï¼ˆéœ€è¦å ç”¨è¿ç»­çš„å†…å­˜ç©ºé—´ï¼šå¦‚è¾ƒé•¿çš„å­—ç¬¦ä¸²æ•°ç»„ï¼‰ã€‚å¦‚æœæ˜¯å¤§å¯¹è±¡å°±ä¼šç›´æ¥è¿›å…¥è€å¹´ä»£ï¼Œå¦åˆ™ä¸€èˆ¬çš„å¯¹è±¡éƒ½ä¼šè¿›å…¥EdenåŒºã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="/2018/04/29/gc01/newObj.png" alt="&#39;å¯¹è±¡å»ºç«‹çš„è¿‡ç¨‹&#39;"><br>è€Œå¯¹äºåƒåœ¾æ”¶é›†å™¨çš„é€‰æ‹©å…·ä½“å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="/2018/04/29/gc01/gccollector.png" alt="&#39;åƒåœ¾æ”¶é›†å™¨çš„ç»„åˆ&#39;"><br>æˆ‘ä»¬éœ€è¦é’ˆå¯¹ä¸åŒçš„åœºåˆé€‰æ‹©åƒåœ¾æ”¶é›†å™¨ã€‚  </p></blockquote><table><thead><tr><th style="text-align:center">Serial</th><th style="text-align:center">ParNew</th><th style="text-align:center">Parallel Scavenge</th><th style="text-align:center">Serial Old</th><th style="text-align:center">Parallel Old</th></tr></thead><tbody><tr><td style="text-align:center">å•çº¿ç¨‹çš„æ”¶é›†å™¨ï¼Œåªä¼šä½¿ç”¨ä¸€ä¸ªCPUæˆ–ä¸€æ¡æ”¶é›†å™¨å»å®Œæˆåƒåœ¾æ”¶é›†å·¥ä½œï¼Œå¹¶åœ¨åœ¨å®ƒè¿›è¡Œåƒåœ¾æ”¶é›†æ—¶ï¼Œå¿…é¡»æš‚åœå…¶ä»–æ‰€æœ‰å·¥ä½œçš„çº¿ç¨‹</td><td style="text-align:center">Serialæ”¶é›†å™¨çš„å¤šçº¿ç¨‹ç‰ˆæœ¬ï¼Œä¹ŸåŒæ ·è¦æš‚åœå…¶ä»–å·¥ä½œçº¿ç¨‹ã€‚åªæœ‰å®ƒèƒ½ä¸CMSæ”¶é›†å™¨é…åˆã€‚</td><td style="text-align:center">CMSç­‰æ”¶é›†å™¨æ³¨é‡ç¼©çŸ­åƒåœ¾æ”¶é›†æ—¶ç”¨æˆ·çº¿ç¨‹çš„åœé¡¿æ—¶é—´ï¼Œè€ŒParallel Scavengeæ˜¯è¾¾åˆ°ä¸€ä¸ªå¯æ§åˆ¶çš„ååé‡ã€‚ä¸»è¦é€‚åˆåœ¨åå°è¿ç®—è€Œä¸éœ€è¦å¤ªå¤šäº¤äº’çš„ä»»åŠ¡</td><td style="text-align:center">å•çº¿ç¨‹æ”¶é›†å™¨ï¼Œä½¿ç”¨æ ‡è®°-æ•´ç†ç®—æ³•ã€‚ä¸»è¦ç”¨æ¥å’ŒJDK1.5åŠä»¥å‰çš„ç‰ˆæœ¬ä¸­ä¸Parallel Scavengeé…åˆä½¿ç”¨å’Œä½œä¸ºCMSæ”¶é›†å™¨çš„åå¤‡é¢„æ¡ˆï¼Œåœ¨å¹¶å‘æ”¶é›†å™¨å‘ç”ŸConcurrent Mode Failureæ—¶ä½¿ç”¨</td><td style="text-align:center">ä½¿ç”¨äº†å¤šçº¿ç¨‹å’Œæ ‡è®°-æ•´ç†ç®—æ³•ï¼Œåœ¨æ³¨é‡ååé‡ä»¥åŠCPUèµ„æºæ•æ„Ÿçš„åœºåˆä¼˜å…ˆè€ƒè™‘Parallel Scavengeå’ŒParallel Oldæ”¶é›†å™¨</td></tr></tbody></table><ul><li>CMS(Currernt Mark Sweep)<br>CMSæ”¶é›†å™¨é‡‡ç”¨â€œæ ‡è®°-æ¸…é™¤â€ç®—æ³•ï¼Œä»è€Œè¾¾åˆ°ä»¥è·å–æœ€çŸ­å›æ”¶åœé¡¿æ—¶é—´çš„ç›®æ ‡ã€‚å®ƒåˆ†ä¸º4ä¸ªæ­¥éª¤ï¼š  <ul><li>åˆå§‹æ ‡è®°<br>æ ‡è®°GC Rootsèƒ½ç›´æ¥å…³è”åˆ°çš„å¯¹è±¡ï¼Œé€Ÿåº¦å¾ˆå¿«ã€‚</li><li>å¹¶å‘æ ‡è®°<br>è¿›è¡ŒGC Roots Tracingçš„è¿‡ç¨‹ã€‚</li><li>é‡æ–°æ ‡è®°<br>ä¸ºäº†ä¿®æ­£å¹¶å‘æ ‡è®°æ—¶é—´å› ç”¨æˆ·ç¨‹åºç»§ç»­è¿ä½œè€Œå¯¼è‡´æ ‡è®°äº§ç”Ÿå˜åŠ¨çš„é‚£ä¸€éƒ¨åˆ†å¯¹è±¡çš„æ ‡è®°è®°å½•ï¼Œ</li><li>å¹¶å‘æ¸…é™¤<br>å¹¶å‘æ¸…é™¤GC Rootsä¸å¯è¾¾çš„å¯¹è±¡ã€‚<br>ä¼˜ç‚¹ï¼šå¹¶å‘æ”¶é›†ï¼Œä½åœé¡¿ã€‚<br>ç¼ºç‚¹ï¼š1ã€CMSæ”¶é›†çº¿å¯¹CPUèµ„æºéå¸¸æ•æ„Ÿã€‚<br>&emsp;&emsp;&emsp;2ã€CMSæ”¶é›†å™¨æ— æ³•å¤„ç†æµ®åŠ¨çš„åƒåœ¾ï¼Œå¯èƒ½å‡ºç°â€œConcurrent Mode Failureâ€å¤±è´¥è€Œå¯¼è‡´å¦ä¸€æ¬¡Full GCçš„äº§ç”Ÿã€‚å½“å‡ºç°Concurrent Mode Failureå¤±è´¥æ—¶ï¼Œè™šæ‹Ÿæœºå°†å¯åŠ¨åå¤‡é¢„æ¡ˆï¼šä¸´æ—¶å¯ç”¨Serial Oldæ”¶é›†å™¨æ¥é‡æ–°è¿›è¡Œè€å¹´ä»£çš„åƒåœ¾æ”¶é›†ï¼Œåœé¡¿çš„æ—¶é—´ä¼šåŠ é•¿ã€‚<br>&emsp;&emsp;&emsp;3ã€â€œæ ‡è®°-æ¸…é™¤â€ä¼šäº§ç”Ÿå¤§é‡çš„ç©ºé—´ç¢ç‰‡ã€‚</li></ul></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;&amp;emsp;&amp;emsp;åœ¨JVMä¸­,è¿›è¡Œåƒåœ¾å›æ”¶é¦–å…ˆè¦åˆ¤æ–­å¯¹è±¡å¯¹è±¡æ˜¯å¦å­˜æ´»ï¼Œåœ¨å¯¹ä¸åŒç”Ÿå‘½å‘¨æœŸçš„å¯¹è±¡è¿›è¡Œåƒåœ¾å›æ”¶ã€‚åœ¨è¿›è¡Œåƒåœ¾å›æ”¶æ—¶ï¼Œè¦æ ¹æ®éœ€æ±‚è¿›è¡Œåƒåœ¾å›æ”¶ç®—æ³•çš„é€‰æ‹©ã€‚ï¼ˆæ¯”å¦‚æ³¨é‡ååé‡ï¼‰&lt;/p&gt;&lt;/blockquote&gt;
    
    </summary>
    
      <category term="JVM" scheme="http://yoursite.com/categories/JVM/"/>
    
    
      <category term="CMS" scheme="http://yoursite.com/tags/CMS/"/>
    
      <category term="Serial" scheme="http://yoursite.com/tags/Serial/"/>
    
      <category term="ParNew" scheme="http://yoursite.com/tags/ParNew/"/>
    
      <category term="Parallel" scheme="http://yoursite.com/tags/Parallel/"/>
    
      <category term="Scavenge" scheme="http://yoursite.com/tags/Scavenge/"/>
    
      <category term="Serial Old" scheme="http://yoursite.com/tags/Serial-Old/"/>
    
      <category term="Parallel Old" scheme="http://yoursite.com/tags/Parallel-Old/"/>
    
      <category term="G1" scheme="http://yoursite.com/tags/G1/"/>
    
  </entry>
  
</feed>
